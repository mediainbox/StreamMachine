{
  "version": 3,
  "file": "alerts.js",
  "sourceRoot": "../../../src/streammachine/",
  "sources": [
    "alerts.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "nconf       = require \"nconf\"\r\n_           = require \"underscore\"\r\nnodemailer  = require \"nodemailer\"\r\npagerduty   = require \"pagerduty\"\r\n\r\n\r\nALERT_TYPES =\r\n    sourceless:\r\n        description:    \"A monitored stream has lost its only source connection.\"\r\n        wait_for:       30\r\n\r\n    slave_disconnected:\r\n        description:    \"A slave server has lost its connection to the master server.\"\r\n        wait_for:       30\r\n\r\n    slave_unresponsive:\r\n        description:    \"A slave server has stopped responding to our status queries.\"\r\n        wait_for:       30\r\n\r\n    slave_unsynced:\r\n        description:    \"A slave server is out of sync with master.\"\r\n        wait_for:       30\r\n\r\n# Alerts module is responsible for understanding how long we should wait\r\n# before saying something about alert conditions.  Code calls the alert\r\n# class with a code, a key and a state.\r\n\r\nmodule.exports = class Alerts extends require(\"events\").EventEmitter\r\n    constructor: (@opts) ->\r\n        super()\r\n\r\n        @logger = @opts.logger\r\n\r\n        @email      = new Alerts.Email @, nconf.get(\"alerts:email\") if nconf.get(\"alerts:email\")\r\n        @pagerduty  = new Alerts.PagerDuty @, nconf.get(\"alerts:pagerduty\") if nconf.get(\"alerts:pagerduty\")\r\n\r\n        @_states = {}\r\n\r\n    #----------\r\n\r\n    update: (code,key,active) ->\r\n        # make sure we know what this is...\r\n        if !ALERT_TYPES[code]\r\n            console.log \"Unknown alert type sent: #{code} / #{key}\"\r\n            return false\r\n\r\n        if !@_states[ code ]\r\n            @_states[ code ] = {}\r\n\r\n        # are we setting or unsetting?\r\n        if active\r\n            if s = @_states[ code ][ key ]\r\n                # update our timestamp\r\n                s.last_seen_at = new Date\r\n\r\n                # make sure there isn't an all-clear waiting to fire\r\n                clearTimeout s.c_timeout if s.c_timeout\r\n                delete s.c_timeout\r\n\r\n            else\r\n                # setting for the first time...\r\n                s = @_states[ code ][ key ] =\r\n                    code:           code\r\n                    key:            key\r\n                    triggered_at:   new Date\r\n                    last_seen_at:   new Date\r\n                    alert_sent:     false\r\n                    a_timeout:      null\r\n                    c_timeout:      null\r\n\r\n            # -- should we set a timeout for triggering an alarm? -- #\r\n\r\n            if !s.alert_sent && !s.a_timeout\r\n                s.a_timeout = setTimeout =>\r\n                    @_fireAlert(s)\r\n                , ALERT_TYPES[ code ].wait_for * 1000\r\n\r\n        else\r\n            # clear an alert state if it is set\r\n            if s = @_states[ code ][ key ]\r\n                # -- is there an alert timeout set? -- #\r\n                clearTimeout s.a_timeout if s.a_timeout\r\n                delete s.a_timeout\r\n\r\n                if s.alert_sent && !s.c_timeout\r\n                    # we had sent an alert, so send a note that the alert has cleared\r\n                    s.c_timeout = setTimeout =>\r\n                        @_fireAllClear(s)\r\n                    , ALERT_TYPES[ code ].wait_for * 1000\r\n                else\r\n                    # no harm, no foul\r\n            else\r\n                # they've always been good...\r\n\r\n    #----------\r\n\r\n    _fireAlert: (obj) ->\r\n        alert =\r\n            code:           obj.code\r\n            key:            obj.key\r\n            triggered_at:   obj.triggered_at\r\n            description:    ALERT_TYPES[ obj.code ].description\r\n\r\n        @logger.warn \"Alert: #{obj.key} : #{ alert.description }\", alert\r\n        @emit \"alert\", alert\r\n\r\n        # mark our alert as sent\r\n        obj.alert_sent = true\r\n\r\n    #----------\r\n\r\n    _fireAllClear: (obj) ->\r\n        alert =\r\n            code:           obj.code\r\n            key:            obj.key\r\n            triggered_at:   obj.triggered_at\r\n            last_seen_at:   obj.last_seen_at\r\n            description:    ALERT_TYPES[ obj.code ].description\r\n\r\n        @logger.warn \"Alert Cleared: #{obj.key} : #{ alert.description }\", alert\r\n        @emit \"alert_cleared\", alert\r\n\r\n        # we need to delete the alert now that it has been cleared. If the\r\n        # condition returns, it will be as a new event\r\n        delete @_states[ obj.code ][ obj.key ]\r\n\r\n    #----------\r\n\r\n    class @Email\r\n        constructor: (@alerts,@opts) ->\r\n            # -- set up the transport -- #\r\n\r\n            @transport = nodemailer.createTransport(@opts.mailer_type,@opts.mailer_options)\r\n\r\n            # -- register our listener -- #\r\n\r\n            @alerts.on \"alert\",         (msg) => @_sendAlert(msg)\r\n            @alerts.on \"alert_cleared\", (msg) => @_sendAllClear(msg)\r\n\r\n        #----------\r\n\r\n        _sendAlert: (msg) ->\r\n            email = _.extend {}, @opts.email_options,\r\n                subject: \"[StreamMachine/#{msg.key}] #{msg.code} Alert\"\r\n                generateTextFromHTML: true\r\n                html:   \"\"\"\r\n                        <p>StreamMachine has detected an alert condition of <b>#{msg.code}</b> for <b>#{msg.key}</b>.</p>\r\n\r\n                        <p>#{msg.description}</p>\r\n\r\n                        <p>Condition was first detected at <b>#{msg.triggered_at}</b>.</p>\r\n                        \"\"\"\r\n\r\n            @transport.sendMail email, (err,resp) =>\r\n                if err\r\n                    @alerts.logger.error \"Error sending alert email: #{err}\", error:err\r\n                    return false\r\n\r\n                @alerts.logger.debug \"Alert email sent to #{email.to}.\", code:msg.code, key:msg.key\r\n\r\n        #----------\r\n\r\n        _sendAllClear: (msg) ->\r\n            email = _.extend {}, @opts.email_options,\r\n                subject: \"[StreamMachine/#{msg.key}] #{msg.code} Cleared\"\r\n                generateTextFromHTML: true\r\n                html:   \"\"\"\r\n                        <p>StreamMachine has cleared an alert condition of <b>#{msg.code}</b> for <b>#{msg.key}</b>.</p>\r\n\r\n                        <p>#{msg.description}</p>\r\n\r\n                        <p>Condition was first detected at <b>#{msg.triggered_at}</b>.</p>\r\n\r\n                        <p>Condition was last seen at <b>#{msg.last_seen_at}</b>.</p>\r\n                        \"\"\"\r\n\r\n            @transport.sendMail email, (err,resp) =>\r\n                if err\r\n                    @alerts.logger.error \"Error sending all clear email: #{err}\", error:err\r\n                    return false\r\n\r\n                @alerts.logger.debug \"All clear email sent to #{email.to}.\", code:msg.code, key:msg.key\r\n\r\n    #----------\r\n\r\n    class @PagerDuty\r\n        constructor: (@alerts, @opts) ->\r\n            @pager = new pagerduty serviceKey:@opts.serviceKey\r\n            @incidentKeys = {}\r\n\r\n            @alerts.on \"alert\",         (msg) => @_sendAlert(msg)\r\n            @alerts.on \"alert_cleared\", (msg) => @_sendAllClear(msg)\r\n\r\n\r\n        #----------\r\n\r\n        # Create the initial alert in PagerDuty.\r\n        # In the callback, if the response contained an incident key,\r\n        # then we'll hold on to that so we can later resolve the alert\r\n        # using the same key.\r\n        _sendAlert: (msg) ->\r\n            details = @_details(msg)\r\n\r\n            @alerts.logger.debug \"Sending alert to PagerDuty.\", details:details\r\n\r\n            @pager.create\r\n                description : \"[StreamMachine/#{msg.key}] #{msg.code} Alert\"\r\n                details     : details\r\n\r\n                callback: (error, response) =>\r\n                    if response.incident_key\r\n                        @incidentKeys[details.key] = response.incident_key\r\n                    else\r\n                        @alerts.logger.error \"PagerDuty response did not include an incident key.\", response:response, error:error\r\n\r\n                    @_logResponse error, response,\r\n                        \"Alert sent to PagerDuty.\", msg\r\n\r\n\r\n        #----------\r\n\r\n        # Mark the alert as \"Resolved\" in PagerDuty\r\n        # In the callback, whether it was an error or success, we will\r\n        # delete the incident key from the stored keys.\r\n        _sendAllClear: (msg) ->\r\n            details = @_details(msg)\r\n\r\n            @alerts.logger.debug \"Sending allClear to PagerDuty.\", details:details\r\n\r\n            if @incidentKeys[details.key]\r\n                @pager.resolve\r\n                    incidentKey : @incidentKeys[details.key],\r\n                    description : \"[StreamMachine/#{msg.key}] #{msg.code} Cleared\"\r\n                    details     : details\r\n\r\n                    callback: (error, response) =>\r\n                        delete @incidentKeys[details.key]\r\n\r\n                        @_logResponse error, response,\r\n                            \"Alert marked as Resolved in PagerDuty.\", msg\r\n            else\r\n                @alerts.logger.error \"Could not send allClear to PagerDuty. No incident key in system.\", keys:@incidentKeys\r\n\r\n        #----------\r\n\r\n        # Details to send to PagerDuty. The properties are arbitrary\r\n        # * via  - Just so we know.\r\n        # * code - The alert code (\"sourceless\", \"disconnected\").\r\n        # * msg  - The alert description.\r\n        # * key  - A key to identify this alert. This is to help us find the\r\n        #          correct incidentKey when resolving an alert. It's possible\r\n        #          (but unlikely) that two alerts with the same key could\r\n        #          exist at the same time, which would result in the first\r\n        #          alert never being marked as \"resolved\" in PagerDuty.\r\n        _details: (msg) ->\r\n            via             : \"StreamMachine Alerts\"\r\n            code            : msg.code\r\n            description     : msg.description\r\n            key             : \"#{msg.code}/#{msg.key}\"\r\n\r\n        #----------\r\n\r\n        # Log the PagerDuty response, whether it was a success or an error.\r\n        _logResponse: (error, response, logText, msg) ->\r\n            if error\r\n                @alerts.logger.error \"Error sending alert to PagerDuty: #{error}\", error:error\r\n\r\n            else\r\n                @alerts.logger.debug logText, code:msg.code, key:msg.key\r\n"
  ]
}