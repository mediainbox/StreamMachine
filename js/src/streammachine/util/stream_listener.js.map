{
  "version": 3,
  "file": "stream_listener.js",
  "sourceRoot": "../../../../src/streammachine/util/",
  "sources": [
    "stream_listener.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "Icy = require \"icy\"\r\nhttp = require \"http\"\r\n\r\ndebug = require(\"debug\")(\"sm:util:stream_listener\")\r\n_ = require \"underscore\"\r\n\r\nmodule.exports = class StreamListener extends require(\"events\").EventEmitter\r\n    constructor: (@host,@port,@stream,@shoutcast=false) ->\r\n        super()\r\n        @bytesReceived = 0\r\n\r\n        @url = \"http://#{@host}:#{@port}/#{@stream}\"\r\n\r\n        @req = null\r\n        @res = null\r\n\r\n        debug \"Created new Stream Listener for #{@url}\"\r\n\r\n        @disconnected = false\r\n\r\n    #----------\r\n\r\n    connect: (timeout,cb) ->\r\n        if _.isFunction(timeout)\r\n            cb = timeout\r\n            timeout = null\r\n\r\n        aborted = false\r\n        if timeout\r\n            abortT = setTimeout =>\r\n                aborted = true\r\n                cb new Error(\"Reached timeout without successful connection.\")\r\n            , timeout\r\n\r\n        _connected = (res) =>\r\n            clearTimeout abortT if abortT\r\n\r\n            @res = res\r\n\r\n            debug \"Connected. Response code is #{ res.statusCode }.\"\r\n\r\n            if res.statusCode != 200\r\n                cb new Error(\"Non-200 Status code: #{ res.statusCode }\")\r\n                return false\r\n\r\n            cb?()\r\n            @emit \"connected\"\r\n\r\n            # -- listen for data -- #\r\n\r\n            @res.on \"metadata\", (meta) =>\r\n                @emit \"metadata\", Icy.parse(meta)\r\n\r\n            @res.on \"readable\", =>\r\n                while data = @res.read()\r\n                    @bytesReceived += data.length\r\n                    @emit \"bytes\"\r\n\r\n            # -- listen for an early exit -- #\r\n\r\n            @res.once \"error\", (err) =>\r\n                debug \"Listener connection error: #{err}\"\r\n                @emit \"error\" if !@disconnected\r\n\r\n            @res.once \"close\", =>\r\n                debug \"Listener connection closed.\"\r\n\r\n                @emit \"close\" if !@disconnected\r\n\r\n        connect_func = if @shoutcast then Icy.get else http.get\r\n\r\n        cLoop = =>\r\n            debug \"Attempting connect to #{@url}\"\r\n            @req = connect_func @url, _connected\r\n            @req.once \"socket\", (sock) => @emit \"socket\", sock\r\n            @req.once \"error\", (err) =>\r\n                if err.code == \"ECONNREFUSED\"\r\n                    setTimeout cLoop, 50 if !aborted\r\n                else\r\n                    cb err\r\n\r\n        cLoop()\r\n\r\n    #----------\r\n\r\n    disconnect: (cb) ->\r\n        @disconnected = true\r\n        @res.socket.destroy()\r\n        cb?()\r\n"
  ]
}