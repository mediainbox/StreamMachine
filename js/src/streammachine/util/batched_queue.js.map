{
  "version": 3,
  "file": "batched_queue.js",
  "sourceRoot": "../../../../src/streammachine/util/",
  "sources": [
    "batched_queue.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,YAAA,EAAA;;AAAA,KAAA,GAAQ,OAAA,CAAQ,OAAR,CAAA,CAAiB,uBAAjB;;AAER,MAAM,CAAC,OAAP,GAAuB,eAAN,MAAA,aAAA,QAA2B,OAAA,CAAQ,QAAR,CAAiB,CAAC,UAA7C;EACb,WAAa,QAAO,CAAA,CAAP,CAAA;;;;IAAC,IAAC,CAAA;IAGX,IAAC,CAAA,cAAc,CAAC,aAAhB,GAAgC,IAAC,CAAA,IAAI,CAAC,QAAN,IAAkB;IAClD,IAAC,CAAA,cAAc,CAAC,aAAhB,GAAgC,IAAC,CAAA,IAAI,CAAC,QAAN,IAAkB;IAElD,IAAC,CAAA,KAAD,GAAc,IAAC,CAAA,IAAI,CAAC,KAAN,IAAiB;IAC/B,IAAC,CAAA,QAAD,GAAc,IAAC,CAAA,IAAI,CAAC,OAAN,IAAiB;IAE/B,KAAA,CAAM,CAAA,qCAAA,CAAA,CAAwC,IAAC,CAAA,KAAzC,CAAA,oBAAA,CAAA,CAAqE,IAAC,CAAA,QAAtE,CAAA,EAAA,CAAN;IAEA,IAAC,CAAA,MAAD,GAAU;IACV,IAAC,CAAA,MAAD,GAAU;EAZD;;EAcb,UAAY,CAAC,GAAD,EAAK,QAAL,EAAc,EAAd,CAAA;IACR,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,GAAb;IAEA,IAAG,IAAC,CAAA,MAAM,CAAC,MAAR,IAAkB,IAAC,CAAA,KAAtB;MACI,KAAA,CAAM,mCAAN;AACA,aAAO,IAAC,CAAA,WAAD,CAAa,EAAb,EAFX;;IAIA,IAAG,CAAC,IAAC,CAAA,MAAL;MACI,IAAC,CAAA,MAAD,GAAU,UAAA,CAAW,CAAA,CAAA,GAAA;QACjB,KAAA,CAAM,0CAAN;eACA,IAAC,CAAA,WAAD,CAAA;MAFiB,CAAX,EAGR,IAAC,CAAA,QAHO,EADd;;WAMA,EAAA,CAAA;EAbQ;;EAeZ,MAAQ,CAAC,EAAD,CAAA;WACJ,IAAC,CAAA,WAAD,CAAa,EAAb;EADI;;EAGR,WAAa,CAAC,EAAD,CAAA;AACjB,QAAA;IAAQ,IAAG,IAAC,CAAA,MAAJ;MACI,YAAA,CAAa,IAAC,CAAA,MAAd;MACA,IAAC,CAAA,MAAD,GAAU,KAFd;;IAIA,KAAA,GAAQ,IAAC,CAAA,MAAM,CAAC,MAAR,CAAe,CAAf;IAER,KAAA,CAAM,CAAA,iBAAA,CAAA,CAAoB,KAAK,CAAC,MAA1B,CAAA,QAAA,CAAN;IAEA,IAAe,KAAK,CAAC,MAAN,GAAe,CAA9B;MAAA,IAAC,CAAA,IAAD,CAAM,KAAN,EAAA;;sCAEA;EAXS;;AAjCA",
  "sourcesContent": [
    "debug = require(\"debug\")(\"sm:util:batched_queue\")\r\n\r\nmodule.exports = class BatchedQueue extends require(\"stream\").Transform\r\n    constructor: (@opts={}) ->\r\n        super objectMode:true\r\n\r\n        @_writableState.highWaterMark = @opts.writable || 4096\r\n        @_readableState.highWaterMark = @opts.readable || 1\r\n\r\n        @_size      = @opts.batch   || 1000\r\n        @_latency   = @opts.latency || 200\r\n\r\n        debug \"Setting up BatchedQueue with size of #{@_size} and max latency of #{@_latency}ms\"\r\n\r\n        @_queue = []\r\n        @_timer = null\r\n\r\n    _transform: (obj,encoding,cb) ->\r\n        @_queue.push obj\r\n\r\n        if @_queue.length >= @_size\r\n            debug \"Calling writeQueue for batch size\"\r\n            return @_writeQueue cb\r\n\r\n        if !@_timer\r\n            @_timer = setTimeout =>\r\n                debug \"Calling writeQueue after latency timeout\"\r\n                @_writeQueue()\r\n            , @_latency\r\n\r\n        cb()\r\n\r\n    _flush: (cb) ->\r\n        @_writeQueue cb\r\n\r\n    _writeQueue: (cb) ->\r\n        if @_timer\r\n            clearTimeout @_timer\r\n            @_timer = null\r\n\r\n        batch = @_queue.splice(0)\r\n\r\n        debug \"Writing batch of #{batch.length} objects\"\r\n\r\n        @push batch if batch.length > 0\r\n\r\n        cb?()"
  ]
}