{
  "version": 3,
  "file": "icecast_source.js",
  "sourceRoot": "../../../../src/streammachine/util/",
  "sources": [
    "icecast_source.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,UAAA,EAAA,aAAA,EAAA,KAAA,EAAA;;AAAA,UAAA,GAAa,OAAA,CAAQ,wBAAR;;AACb,GAAA,GAAM,OAAA,CAAQ,KAAR;;AAEN,KAAA,GAAQ,OAAA,CAAQ,OAAR,CAAA,CAAiB,oBAAjB;;AAER,MAAM,CAAC,OAAP,GAAuB,gBAAN,MAAA,cAAA,QAA4B,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAA9C;EACb,WAAa,KAAA,CAAA;;IAAC,IAAC,CAAA;IAGX,IAAC,CAAA,UAAD,GAAc;IACd,IAAC,CAAA,IAAD,GAAQ,KAHhB;;IAMQ,IAAC,CAAA,OAAD,GAAW,IAAI,UAAJ,CAAe;MAAA,MAAA,EAAO,IAAC,CAAA,IAAI,CAAC,MAAb;MAAqB,QAAA,EAAS,IAAC,CAAA,IAAI,CAAC,QAApC;MAA8C,aAAA,EAAc;IAA5D,CAAf;IAEX,IAAC,CAAA,OAAO,CAAC,EAAT,CAAY,MAAZ,EAAoB,CAAC,KAAD,CAAA,GAAA;AAC5B,UAAA;4CAAiB,CAAE,KAAP,CAAa,KAAK,CAAC,IAAnB;IADgB,CAApB;EATS,CAAjB;;;EAcI,KAAO,CAAC,EAAD,CAAA;AACX,QAAA;IAAQ,KAAA,GAAQ,CAAA,CAAA,GAAA;MACJ,IAAC,CAAA,OAAO,CAAC,KAAT,CAAA;wCACA,GAAI;IAFA;IAIR,IAAG,IAAC,CAAA,IAAJ;aACI,KAAA,CAAA,EADJ;KAAA,MAAA;aAGI,IAAC,CAAA,QAAD,CAAU,CAAC,GAAD,CAAA,GAAA;QACN,IAAiB,GAAjB;AAAA,iBAAO,EAAA,CAAG,GAAH,EAAP;;QACA,IAAC,CAAA,UAAD,GAAc;eACd,KAAA,CAAA;MAHM,CAAV,EAHJ;;EALG,CAdX;;;EA6BI,KAAO,CAAA,CAAA;WACH,IAAC,CAAA,OAAO,CAAC,IAAT,CAAA;EADG,CA7BX;;;EAkCI,QAAU,CAAC,EAAD,CAAA,EAAA;;IAGN,IAAC,CAAA,IAAD,GAAQ,GAAG,CAAC,OAAJ,CAAY,IAAC,CAAA,IAAI,CAAC,IAAlB,EAAwB,IAAC,CAAA,IAAI,CAAC,IAA9B,EAAoC,CAAA,CAAA,GAAA;AACpD,UAAA,IAAA,EAAA;MAAY,KAAA,CAAM,YAAN;MAEA,WAAA,GAAc,KAF1B;;MAKY,IAAC,CAAA,IAAI,CAAC,IAAN,CAAW,UAAX,EAAuB,CAAA,CAAA,GAAA;AACnC,YAAA,GAAA,EAAA;QAAgB,IAAA,GAAO,IAAC,CAAA,IAAI,CAAC,IAAN,CAAA;QACP,YAAA,CAAa,WAAb;QAEA,IAAG,IAAA,IAAQ,oBAAoB,CAAC,IAArB,CAA0B,IAAI,CAAC,QAAL,CAAA,CAA1B,CAAX;UACI,KAAA,CAAM,kCAAN;iBACA,EAAA,CAAG,IAAH,EAFJ;SAAA,MAAA;UAKI,GAAA,GAAM,CAAA,kBAAA,CAAA,CAAsB,IAAI,CAAC,QAAL,CAAA,CAAtB,CAAA;UACN,KAAA,CAAM,GAAN;UACA,EAAA,CAAG,IAAI,KAAJ,CAAU,GAAV,CAAH;iBACA,IAAC,CAAA,UAAD,CAAA,EARJ;;MAJmB,CAAvB;MAcA,IAAC,CAAA,IAAI,CAAC,KAAN,CAAY,CAAA,QAAA,CAAA,CAAW,IAAC,CAAA,IAAI,CAAC,MAAjB,CAAA,aAAA,CAAZ,EAnBZ;;MAuBY,IAAG,IAAC,CAAA,IAAI,CAAC,QAAT;;QAEI,IAAA,GAAO,MAAM,CAAC,IAAP,CAAY,CAAA,OAAA,CAAA,CAAU,IAAC,CAAA,IAAI,CAAC,QAAhB,CAAA,CAAZ,EAAuC,OAAvC,CAA+C,CAAC,QAAhD,CAAyD,QAAzD;QACP,IAAC,CAAA,IAAI,CAAC,KAAN,CAAY,CAAA,qBAAA,CAAA,CAAwB,IAAxB,CAAA,QAAA,CAAZ;QACA,KAAA,CAAM,CAAA,kBAAA,CAAA,CAAsB,IAAtB,CAAA,CAAA,CAAN,EAJJ;OAAA,MAAA;QAOI,IAAC,CAAA,IAAI,CAAC,KAAN,CAAY,MAAZ,EAPJ;;aASA,WAAA,GAAc,UAAA,CAAW,CAAA,CAAA,GAAA;AACrC,YAAA;QAAgB,GAAA,GAAM;QACN,KAAA,CAAM,GAAN;QACA,EAAA,CAAG,IAAI,KAAJ,CAAU,GAAV,CAAH;eACA,IAAC,CAAA,UAAD,CAAA;MAJqB,CAAX,EAKZ,IALY;IAjC0B,CAApC;WAwCR,IAAC,CAAA,IAAI,CAAC,IAAN,CAAW,OAAX,EAAoB,CAAC,GAAD,CAAA,GAAA;MAChB,KAAA,CAAM,CAAA,cAAA,CAAA,CAAiB,GAAjB,CAAA,CAAN;aACA,IAAC,CAAA,UAAD,CAAA;IAFgB,CAApB;EA3CM,CAlCd;;;EAmFI,UAAY,CAAA,CAAA;AAChB,QAAA;IAAQ,IAAC,CAAA,UAAD,GAAc;;SACT,CAAE,GAAP,CAAA;;IACA,IAAC,CAAA,IAAD,GAAQ;WACR,IAAC,CAAA,IAAD,CAAM,YAAN;EAJQ;;AApFC",
  "sourcesContent": [
    "FileSource = require \"../sources/file_source\"\r\nnet = require \"net\"\r\n\r\ndebug = require(\"debug\")(\"sm:sources:icecast\")\r\n\r\nmodule.exports = class IcecastSource extends require(\"events\").EventEmitter\r\n    constructor: (@opts) ->\r\n        super()\r\n\r\n        @_connected = false\r\n        @sock = null\r\n\r\n        # we'll use FileSource to read the file and chunk it for us\r\n        @fsource = new FileSource format:@opts.format, filePath:@opts.filePath, chunkDuration:0.2\r\n\r\n        @fsource.on \"data\", (chunk) =>\r\n            @sock?.write chunk.data\r\n\r\n    #----------\r\n\r\n    start: (cb) ->\r\n        sFunc = =>\r\n            @fsource.start()\r\n            cb? null\r\n\r\n        if @sock\r\n            sFunc()\r\n        else\r\n            @_connect (err) =>\r\n                return cb err if err\r\n                @_connected = true\r\n                sFunc()\r\n\r\n    #----------\r\n\r\n    pause: ->\r\n        @fsource.stop()\r\n\r\n    #----------\r\n\r\n    _connect: (cb) ->\r\n        # -- Open our connection to the server -- #\r\n\r\n        @sock = net.connect @opts.port, @opts.host, =>\r\n            debug \"Connected!\"\r\n\r\n            authTimeout = null\r\n\r\n            # we really only care about the first thing we see\r\n            @sock.once \"readable\", =>\r\n                resp = @sock.read()\r\n                clearTimeout authTimeout\r\n\r\n                if resp && /^HTTP\\/1\\.0 200 OK/.test(resp.toString())\r\n                    debug \"Got HTTP OK. Starting streaming.\"\r\n                    cb null\r\n\r\n                else\r\n                    err = \"Unknown response: #{ resp.toString() }\"\r\n                    debug err\r\n                    cb new Error err\r\n                    @disconnect()\r\n\r\n            @sock.write \"SOURCE /#{@opts.stream} HTTP/1.0\\r\\n\"\r\n\r\n            #@sock.write \"User-Agent: StreamMachine IcecastSource\"\r\n\r\n            if @opts.password\r\n                # username doesn't matter.\r\n                auth = Buffer.from(\"source:#{@opts.password}\",'ascii').toString(\"base64\")\r\n                @sock.write \"Authorization: Basic #{auth}\\r\\n\\r\\n\"\r\n                debug \"Writing auth with #{ auth }.\"\r\n\r\n            else\r\n                @sock.write \"\\r\\n\"\r\n\r\n            authTimeout = setTimeout =>\r\n                err = \"Timed out waiting for authentication.\"\r\n                debug err\r\n                cb new Error err\r\n                @disconnect()\r\n            , 5000\r\n\r\n        @sock.once \"error\", (err) =>\r\n            debug \"Socket error: #{err}\"\r\n            @disconnect()\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        @_connected = false\r\n        @sock?.end()\r\n        @sock = null\r\n        @emit \"disconnect\"\r\n"
  ]
}