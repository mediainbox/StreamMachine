{
  "version": 3,
  "file": "fake_ad_server.js",
  "sourceRoot": "../../../../src/streammachine/util/",
  "sources": [
    "fake_ad_server.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,YAAA,EAAA,KAAA,EAAA,OAAA,EAAA;;AAAA,OAAA,GAAU,OAAA,CAAQ,SAAR;;AACV,KAAA,GAAQ,OAAA,CAAQ,OAAR,CAAA,CAAiB,wBAAjB;;AACR,EAAA,GAAK,OAAA,CAAQ,IAAR;;AAEL,MAAM,CAAC,OAAP,GAAuB,eAAN,MAAA,aAAA,QAA2B,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAA7C;EACb,WAAa,KAAA,UAAA,EAAiB,EAAjB,CAAA;AACjB,QAAA,CAAA,EAAA;;IADkB,IAAC,CAAA;IAAK,IAAC,CAAA,oBACzB;;IAIQ,MAAA,GAAS;IACT,KAAA,CAAM,CAAA,YAAA,CAAA,CAAe,IAAC,CAAA,QAAhB,CAAA,CAAN;IACA,CAAA,GAAI,EAAE,CAAC,gBAAH,CAAoB,IAAC,CAAA,QAArB;IACJ,CAAC,CAAC,EAAF,CAAK,UAAL,EAAiB,CAAA,CAAA,GAAA;AACzB,UAAA,CAAA,EAAA;AAAY;aAAkB,CAAA,GAAI,CAAC,CAAC,IAAF,CAAA,CAAtB;qBAAA,MAAA,IAAU;MAAV,CAAA;;IADa,CAAjB;IAGA,CAAC,CAAC,IAAF,CAAO,KAAP,EAAc,CAAA,CAAA,GAAA;MACV,KAAA,CAAM,wBAAN,EAAZ;;MAGY,IAAC,CAAA,OAAD,GAAW;MAEX,IAAC,CAAA,GAAD,GAAO,OAAA,CAAA;MAEP,IAAC,CAAA,GAAG,CAAC,GAAL,CAAS,aAAT,EAAwB,CAAC,GAAD,EAAK,GAAL,CAAA,GAAA;AACpC,YAAA;QAAgB,MAAA,GAAS,GAAG,CAAC,KAAK,CAAC,QAAD;QAClB,IAAC,CAAA,IAAD,CAAM,YAAN,EAAoB,MAApB;eACA,GAAG,CAAC,MAAJ,CAAW,GAAX,CAAe,CAAC,GAAhB,CAAoB,EAApB;MAHoB,CAAxB;MAKA,IAAC,CAAA,GAAG,CAAC,GAAL,CAAS,KAAT,EAAgB,CAAC,GAAD,EAAK,GAAL,CAAA,GAAA;AAC5B,YAAA,EAAA,EAAA;QAAgB,MAAA,GAAS,IAAC,CAAA;QACV,IAAC,CAAA,OAAD,IAAY;QAEZ,EAAA,GAAK,MACD,CAAC,OADA,CACQ,YADR,EACqB,CAAA,iBAAA,CAAA,CAAoB,IAAC,CAAA,IAArB,CAAA,mBAAA,CAAA,CAA+C,MAA/C,CAAA,CADrB;QAGL,IAAC,CAAA,IAAD,CAAM,IAAN,EAAY,MAAZ;eACA,GAAG,CAAC,MAAJ,CAAW,GAAX,CAAe,CAAC,IAAhB,CAAqB,UAArB,CAAgC,CAAC,GAAjC,CAAqC,EAArC;MARY,CAAhB;MAUA,CAAA,GAAI,IAAC,CAAA,GAAG,CAAC,MAAL,CAAY,IAAC,CAAA,IAAb;MAEJ,IAA4B,IAAC,CAAA,IAAD,KAAS,CAArC;QAAA,IAAC,CAAA,IAAD,GAAQ,CAAC,CAAC,OAAF,CAAA,CAAW,CAAC,KAApB;;MAEA,KAAA,CAAM,gBAAN;wCACA,GAAI,MAAM;IA5BA,CAAd;EAXS;;AADA",
  "sourcesContent": [
    "express = require \"express\"\r\ndebug = require(\"debug\")(\"sm:util:fake_ad_server\")\r\nfs = require \"fs\"\r\n\r\nmodule.exports = class FakeAdServer extends require(\"events\").EventEmitter\r\n    constructor: (@port,@template,cb) ->\r\n        super()\r\n\r\n        # -- read our template -- #\r\n\r\n        xmldoc = \"\"\r\n        debug \"Template is #{@template}\"\r\n        s = fs.createReadStream @template\r\n        s.on \"readable\", =>\r\n            xmldoc += r while r = s.read()\r\n\r\n        s.once \"end\", =>\r\n            debug \"Template read complete\"\r\n            # -- prepare ad server -- #\r\n\r\n            @counter = 0\r\n\r\n            @app = express()\r\n\r\n            @app.get \"/impression\", (req,res) =>\r\n                req_id = req.query[\"req_id\"]\r\n                @emit \"impression\", req_id\r\n                res.status(200).end \"\"\r\n\r\n            @app.get \"/ad\", (req,res) =>\r\n                req_id = @counter\r\n                @counter += 1\r\n\r\n                ad = xmldoc\r\n                    .replace(\"IMPRESSION\",\"http://127.0.0.1:#{@port}/impression?req_id=#{req_id}\")\r\n\r\n                @emit \"ad\", req_id\r\n                res.status(200).type(\"text/xml\").end ad\r\n\r\n            s = @app.listen @port\r\n\r\n            @port = s.address().port if @port == 0\r\n\r\n            debug \"Setup complete\"\r\n            cb? null, @\r\n\r\n"
  ]
}