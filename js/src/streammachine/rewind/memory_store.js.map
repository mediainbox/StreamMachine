{
  "version": 3,
  "file": "memory_store.js",
  "sourceRoot": "../../../../src/streammachine/rewind/",
  "sources": [
    "memory_store.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "bs = require 'binary-search'\r\n\r\ndebug = require(\"debug\")(\"sm:rewind:memory_store\")\r\n\r\nmodule.exports = class MemoryStore extends require(\"./base_store\")\r\n    constructor: (@max_length = null) ->\r\n        super()\r\n\r\n        @buffer = []\r\n\r\n    #----------\r\n\r\n    reset: (cb) ->\r\n        @buffer = []\r\n        cb? null\r\n\r\n    #----------\r\n\r\n    length: ->\r\n        @buffer.length\r\n\r\n    #----------\r\n\r\n    _findTimestampOffset: (ts) ->\r\n        foffset = bs @buffer, {ts:ts}, (a,b) -> Number(a.ts) - Number(b.ts)\r\n\r\n        if foffset >= 0\r\n            # if exact, return right away\r\n            return @buffer.length - 1 - foffset\r\n\r\n        else if foffset == -1\r\n            # our timestamp would be the first one in the buffer. Return\r\n            # whatever is there, regardless of how close\r\n            return @buffer.length - 1\r\n\r\n        else\r\n            foffset = Math.abs(foffset) - 1\r\n\r\n            # Look at this index, and the buffer before it, to see which is\r\n            # more appropriate\r\n\r\n            a = @buffer[ foffset - 1 ]\r\n            b = @buffer[ foffset ]\r\n\r\n            if Number(a.ts) <= Number(ts) < Number(a.ts) + a.duration\r\n                # it's within a\r\n                return @buffer.length - foffset\r\n            else\r\n                # is it closer to the end of a, or the beginning of b?\r\n\r\n                da = Math.abs( Number(a.ts) + a.duration - ts )\r\n                db = Math.abs( b.ts - ts )\r\n\r\n                if da > db\r\n                    return @buffer.length - foffset - 1\r\n                else\r\n                    return @buffer.length - foffset\r\n\r\n    #----------\r\n\r\n    at: (offset,cb) ->\r\n        if offset instanceof Date\r\n            offset = @_findTimestampOffset offset\r\n\r\n            if offset == -1\r\n                return cb new Error \"Timestamp not found in RewindBuffer\"\r\n\r\n        else\r\n            offset = @buffer.length - 1 if offset > @buffer.length\r\n            offset = 0 if offset < 0\r\n\r\n        cb null, @buffer[ @buffer.length - 1 - offset ]\r\n\r\n    #----------\r\n\r\n    range: (offset,length,cb) ->\r\n        if offset instanceof Date\r\n            offset = @_findTimestampOffset offset\r\n\r\n            if offset == -1\r\n                return cb new Error \"Timestamp not found in RewindBuffer\"\r\n\r\n        else\r\n            offset = @buffer.length - 1 if offset > @buffer.length\r\n            offset = 0 if offset < 0\r\n\r\n        length = offset if length > offset\r\n\r\n        start = @buffer.length - 1 - offset\r\n        end = start + length\r\n\r\n        cb null, @buffer.slice(start,end)\r\n\r\n    #----------\r\n\r\n    first: ->\r\n        @buffer[0]\r\n\r\n    last: ->\r\n        @buffer[ @buffer.length - 1 ]\r\n\r\n    #----------\r\n\r\n    clone: (cb) ->\r\n        buf_copy = @buffer.slice(0)\r\n        cb null, buf_copy\r\n\r\n    #----------\r\n\r\n    insert: (chunk) ->\r\n        fb = @buffer[ 0 ]\r\n        lb = @buffer[ @buffer.length - 1 ]\r\n\r\n        fb = Number(fb.ts) if fb\r\n        lb = Number(lb.ts) if lb\r\n        cts = Number(chunk.ts)\r\n\r\n        # If there is no last chunk (= no chunks) or current chunk's timestamp\r\n        # is greather than the last one's, insert it at the end\r\n        if !lb || cts > lb\r\n            # append\r\n            @buffer.push chunk\r\n            @emit \"push\", chunk\r\n\r\n        # If the current chunk's timestamp is lower than the first one's, i\r\n        # insert it at the beginning of the array\r\n        else if cts < fb\r\n            # prepend\r\n            @buffer.unshift chunk\r\n            @emit \"unshift\", chunk\r\n\r\n        # If the current chunk's timestamp matches the last chunk's,\r\n        # it's probable that insert() was called again using the same chunk\r\n        # Often related to dangling event handlers that were not properly removed\r\n        else if cts == fb\r\n            debug \"Chunk timestamp already found in the buffer! [cts: #{cts}, fb: #{fb}, lb: #{lb}]\"\r\n\r\n        else\r\n            # need to insert in the middle.\r\n            debug \"Push in the middle not implemented! [cts: #{cts}, fb: #{fb}, lb: #{lb}]\"\r\n\r\n        @_truncate()\r\n\r\n        true\r\n\r\n    #----------\r\n\r\n    _truncate: ->\r\n        # -- should we remove? -- #\r\n\r\n        while @max_length && @buffer.length > @max_length\r\n            b = @buffer.shift()\r\n            @emit \"shift\", b\r\n\r\n    #----------\r\n\r\n    info: ->\r\n\r\n    #----------\r\n"
  ]
}