{
  "version": 3,
  "file": "dump_restore.js",
  "sourceRoot": "../../../../src/streammachine/rewind/",
  "sources": [
    "dump_restore.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,iBAAA,EAAA,CAAA,EAAA,EAAA,EAAA;;AAAA,IAAA,GAAU,OAAA,CAAQ,MAAR;;AACV,EAAA,GAAU,OAAA,CAAQ,IAAR;;AACV,CAAA,GAAU,OAAA,CAAQ,YAAR,EAFV;;;;;;;AAWA,MAAM,CAAC,OAAP,GAAuB;;;EAAN,MAAA,kBAAA,QAAgC,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAAlD;IACb,WAAa,OAAA,UAAA,CAAA;AACjB,UAAA,GAAA,EAAA,GAAA,EAAA,IAAA,EAAA;;MADkB,IAAC,CAAA;MAAO,IAAC,CAAA;MAGnB,IAAC,CAAA,QAAD,GAAkB,CAAA;MAClB,IAAC,CAAA,MAAD,GAAkB;MAClB,IAAC,CAAA,QAAD,GAAkB;MAClB,IAAC,CAAA,WAAD,GAAkB;MAElB,IAAC,CAAA,GAAD,GAAO,IAAC,CAAA,MAAM,CAAC,GAAG,CAAC,KAAZ,CAAkB;QAAA,MAAA,EAAO;MAAP,CAAlB,EAPf;;MAWQ,IAAC,CAAA,KAAD,GAAS,EAAE,CAAC,YAAH,CAAiB,IAAI,CAAC,OAAL,CAAc,OAAO,CAAC,GAAR,CAAA,CAAd,EAA6B,IAAC,CAAA,QAAQ,CAAC,GAAvC,CAAjB;MAET,uDAA4B,CAAE,WAA3B,CAAA,UAAH;AAAA;OAAA,MAAA;;QAGI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,wBAAA,CAAA,CAA2B,IAAC,CAAA,KAA5B,CAAA,aAAA,CAAX;AACA,eAAO,MAJX;;AAQA;;MAAA,KAAA,SAAA;;QACI,IAAC,CAAA,QAAQ,CAAE,CAAF,CAAT,GAAiB,IAAI,MAAJ,CAAW,CAAX,EAAc,GAAG,CAAC,MAAlB,EAA0B,IAAC,CAAA,KAA3B;QAEjB,GAAG,CAAC,IAAJ,CAAS,SAAT,EAAoB,CAAA,CAAA,GAAA;iBAChB,OAAO,IAAC,CAAA,QAAQ,CAAC,CAAD;QADA,CAApB;MAHJ,CArBR;;MA4BQ,IAAC,CAAA,MAAM,CAAC,EAAR,CAAW,YAAX,EAAyB,CAAC,MAAD,CAAA,GAAA;QACrB,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,kCAAA,CAAA,CAAqC,MAAM,CAAC,GAA5C,CAAA,CAAX;eACA,IAAC,CAAA,QAAQ,CAAC,MAAM,CAAC,GAAR,CAAT,GAAwB,IAAI,MAAJ,CAAW,MAAM,CAAC,GAAlB,EAAuB,MAAM,CAAC,MAA9B,EAAsC,IAAC,CAAA,KAAvC;MAFH,CAAzB,EA5BR;;MAkCQ,IAAG,CAAC,IAAC,CAAA,QAAQ,CAAC,SAAV,IAAqB,CAAC,CAAvB,CAAA,GAA4B,CAA/B;QACI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,+CAAA,CAAA,CAAmD,IAAC,CAAA,QAAQ,CAAC,SAA7D,CAAA,SAAA,CAAX;QACA,IAAC,CAAA,IAAD,GAAQ,WAAA,CAAY,CAAA,CAAA,GAAA;iBAChB,IAAC,CAAA,aAAD,CAAA;QADgB,CAAZ,EAEN,IAAC,CAAA,QAAQ,CAAC,SAAV,GAAoB,IAFd,EAFZ;;IAnCS,CAAjB;;;IA4CI,IAAM,CAAC,EAAD,CAAA;AACV,UAAA,KAAA,EAAA,CAAA,EAAA,CAAA,EAAA,MAAA,EAAA;MAAQ,IAAC,CAAA,WAAD,GAAe;MAEf,MAAA;;AAAW;AAAA;QAAA,KAAA,QAAA;;wBAAA;QAAA,CAAA;;;MAEX,OAAA,GAAU;QAAA,OAAA,EAAQ,CAAR;QAAW,MAAA,EAAO;MAAlB;MAEV,KAAA,GAAQ,CAAA,CAAA,GAAA;QACJ,IAAG,CAAA,GAAI,MAAM,CAAC,KAAP,CAAA,CAAP;iBACI,CAAC,CAAC,QAAF,CAAW,CAAC,GAAD,EAAK,KAAL,CAAA,GAAA;YACP,IAAG,GAAH;cACI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,SAAA,CAAA,CAAa,CAAC,CAAC,GAAf,CAAA,UAAA,CAAA,CAAgC,GAAhC,CAAA,CAAX,EAAkD;gBAAA,MAAA,EAAO,CAAC,CAAC;cAAT,CAAlD;cACA,OAAO,CAAC,MAAR,IAAkB,EAFtB;aAAA,MAAA;cAII,OAAO,CAAC,OAAR,IAAmB,EAJvB;;mBAMA,KAAA,CAAA;UAPO,CAAX,EADJ;SAAA,MAAA;;UAWI,IAAC,CAAA,GAAG,CAAC,IAAL,CAAU,kCAAV,EAA8C;YAAA,OAAA,EAAQ,OAAO,CAAC,OAAhB;YAAyB,MAAA,EAAO,OAAO,CAAC;UAAxC,CAA9C;4CACA,GAAI,MAAM,kBAZd;;MADI;aAeR,KAAA,CAAA;IAtBE,CA5CV;;;IAsEI,aAAe,CAAC,EAAD,CAAA;AACnB,UAAA,CAAA,EAAA;MAAQ,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,sBAAX;MACA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,GAAA;;AAAE;AAAA;QAAA,KAAA,QAAA;;wBAAA;QAAA,CAAA;;mBAAF,CAAb;MAEA,IAAa,CAAC,IAAC,CAAA,QAAf;eAAA,IAAC,CAAA,KAAD,CAAO,EAAP,EAAA;;IAJW,CAtEnB;;;IA8EI,KAAO,CAAC,EAAD,CAAA;AACX,UAAA;MAAQ,IAAC,CAAA,QAAD,GAAY;MAEZ,IAAG,CAAA,GAAI,IAAC,CAAA,MAAM,CAAC,KAAR,CAAA,CAAP;eACI,CAAC,CAAC,KAAF,CAAQ,CAAC,GAAD,EAAK,IAAL,EAAU,MAAV,CAAA,GAAA;UACJ,IAAG,GAAH;YACI,IAAG,CAAC,CAAC,MAAL;cACI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,SAAA,CAAA,CAAY,CAAC,CAAC,GAAd,CAAA,UAAA,CAAA,CAA8B,GAA9B,CAAA,CAAX,EAAgD;gBAAA,MAAA,EAAO,CAAC,CAAC,MAAM,CAAC;cAAhB,CAAhD,EADJ;aAAA,MAAA;cAGI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,SAAA,CAAA,CAAY,CAAC,CAAC,GAAd,CAAA,2BAAA,CAAA,CAA+C,GAA/C,CAAA,CAAX,EAHJ;aADJ;WAAhB;;UAMgB,IAAC,CAAA,IAAD,CAAM,OAAN,EAAe,MAAf,EAAuB,CAAC,CAAC,GAAzB,EAA8B,GAA9B,EAAmC;YAAA,IAAA,EAAK,IAAL;YAAW,MAAA,EAAO;UAAlB,CAAnC;iBAEA,IAAC,CAAA,KAAD,CAAO,EAAP;QATI,CAAR,EADJ;OAAA,MAAA;QAaI,IAAC,CAAA,QAAD,GAAY;0CACZ,cAdJ;;IAHG;;EA/EM;;;EAoGP,SAAN,MAAA,OAAA,QAAqB,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAAvC;IACI,WAAa,IAAA,QAAA,OAAA,CAAA;;MAAC,IAAC,CAAA;MAAI,IAAC,CAAA;MAAO,IAAC,CAAA;MAGxB,IAAC,CAAA,EAAD,GAAkB;MAClB,IAAC,CAAA,OAAD,GAAkB;MAClB,IAAC,CAAA,OAAD,GAAkB;MAClB,IAAC,CAAA,WAAD,GAAkB;MAElB,IAAC,CAAA,SAAD,GAAa,IAAI,CAAC,IAAL,CAAU,IAAC,CAAA,KAAX,EAAiB,CAAA,CAAA,CAAG,IAAC,CAAA,MAAM,CAAC,KAAX,CAAA,KAAA,CAAjB;IARJ,CAArB;;;IAYQ,QAAU,CAAC,EAAD,CAAA;AAClB,UAAA,EAAA;;MACY,EAAA,GAAK,EAAE,CAAC,gBAAH,CAAoB,IAAC,CAAA,SAArB;MAEL,EAAE,CAAC,IAAH,CAAQ,OAAR,EAAiB,CAAC,GAAD,CAAA,GAAA;QACb,IAAC,CAAA,UAAD,CAAY,KAAZ;QAEA,IAAG,GAAG,CAAC,IAAJ,KAAY,QAAf;;AAEI,iBAAO,EAAA,CAAG,IAAH,EAFX;;eAIA,EAAA,CAAG,GAAH;MAPa,CAAjB;aASA,EAAE,CAAC,IAAH,CAAQ,MAAR,EAAgB,CAAA,CAAA,GAAA;eACZ,IAAC,CAAA,MAAM,CAAC,UAAR,CAAmB,EAAnB,EAAuB,CAAC,GAAD,EAAK,KAAL,CAAA,GAAA;UACnB,IAAC,CAAA,UAAD,CAAY,IAAZ;iBACA,EAAA,CAAG,IAAH,EAAS,KAAT;QAFmB,CAAvB;MADY,CAAhB;IAbM,CAZlB;;;IAgCQ,UAAY,CAAC,MAAD,CAAA;MACR,IAAC,CAAA,OAAD,GAAkB;MAClB,IAAC,CAAA,WAAD,GAAkB;aAClB,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,MAAhB;IAHQ,CAhCpB;;;IAuCQ,WAAa,CAAC,EAAD,CAAA;MACT,IAAG,IAAC,CAAA,WAAJ;0CACI,cADJ;OAAA,MAAA;eAGI,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,EAAhB,EAHJ;;IADS,CAvCrB;;;IA+CQ,KAAO,CAAC,EAAD,CAAA;AACf,UAAA,QAAA,EAAA;MAAY,IAAG,IAAC,CAAA,OAAJ;QACI,EAAA,CAAG,IAAI,KAAJ,CAAU,CAAA,wCAAA,CAAA,CAA4C,IAAC,CAAA,MAAM,CAAC,KAApD,CAAA,CAAV,CAAH;AACA,eAAO,MAFX;;MAIA,IAAG,IAAC,CAAA,MAAM,CAAC,SAAR,CAAA,CAAH;QACI,EAAA,CAAG,IAAI,KAAJ,CAAU,2DAAV,CAAH;AACA,eAAO,MAFX;;MAIA,IAAC,CAAA,OAAD,GAAW;MACX,QAAA,GAAW,CAAC,CAAC,GAAF,CAAA;MAEX,EAAA,GAAK,CAAC,CAAC,IAAF,CAAO,EAAP,EAXjB;;;;;MAkBY,CAAA,GAAI,EAAE,CAAC,iBAAH,CAAqB,CAAA,CAAA,CAAG,IAAC,CAAA,SAAJ,CAAA,IAAA,CAArB;MAEJ,CAAC,CAAC,IAAF,CAAO,MAAP,EAAe,CAAA,CAAA,GAAA;eACX,IAAC,CAAA,MAAM,CAAC,UAAR,CAAmB,CAAC,GAAD,EAAK,MAAL,CAAA,GAAA;UACf,MAAM,CAAC,IAAP,CAAY,CAAZ;iBAEA,CAAC,CAAC,IAAF,CAAO,OAAP,EAAgB,CAAA,CAAA,GAAA;AACpC,gBAAA;YAAwB,IAAG,CAAC,CAAC,YAAF,KAAkB,CAArB;cACI,GAAA,GAAM;cACN,EAAA,GAAK,CAAC,CAAC,KAAF,CAAQ,CAAR,EAAW,CAAA,CAAA,GAAA;AAC5C,oBAAA;gBAAgC,MAAA,GAAS,CAAC,CAAC,GAAF,CAAA;gBACT,IAAC,CAAA,OAAD,GAAW;uBACX,EAAA,CAAG,GAAH,EAAQ,IAAR,EAAc,MAAA,GAAS,QAAvB;cAHY,CAAX;cAKL,EAAE,CAAC,MAAH,CAAU,CAAA,CAAA,CAAG,IAAC,CAAA,SAAJ,CAAA,IAAA,CAAV,EAA+B,CAAC,CAAD,CAAA,GAAA;gBAC3B,IAAW,CAAX;kBAAA,GAAA,GAAM,EAAN;;uBACA,EAAA,CAAA;cAF2B,CAA/B,EAN5B;;qBAW4B,EAAE,CAAC,MAAH,CAAU,IAAC,CAAA,SAAX,EAAsB,CAAC,CAAD,CAAA,GAAA;gBAClB,IAAW,CAAA,IAAK,CAAC,CAAC,IAAF,KAAU,QAA1B;kBAAA,GAAA,GAAM,EAAN;;uBACA,EAAA,CAAA;cAFkB,CAAtB,EAZJ;aAAA,MAAA;qBAiBI,EAAE,CAAC,MAAH,CAAU,CAAA,CAAA,CAAG,IAAC,CAAA,SAAJ,CAAA,IAAA,CAAV,EAA+B,IAAC,CAAA,SAAhC,EAA2C,CAAC,GAAD,CAAA,GAAA;AACvE,oBAAA;gBAAgC,IAAG,GAAH;kBACI,EAAA,CAAG,GAAH;AACA,yBAAO,MAFX;;gBAIA,MAAA,GAAS,CAAC,CAAC,GAAF,CAAA;gBACT,IAAC,CAAA,OAAD,GAAW;uBACX,EAAA,CAAG,IAAH,EAAS,IAAC,CAAA,SAAV,EAAqB,MAAA,GAAS,QAA9B;cAPuC,CAA3C,EAjBJ;;UADY,CAAhB;QAHe,CAAnB;MADW,CAAf;aA+BA,CAAC,CAAC,EAAF,CAAK,OAAL,EAAc,CAAC,GAAD,CAAA,GAAA;eACV,EAAA,CAAG,GAAH;MADU,CAAd;IApDG;;EAhDX",
  "sourcesContent": [
    "path    = require \"path\"\r\nfs      = require \"fs\"\r\n_       = require \"underscore\"\r\n\r\n\r\n# RewindDumpRestore is in charge of making periodic backups of a RewindBuffer's\r\n# data. This is important for helping a crashed process get back up to\r\n# speed quickly. The `settings` should define the directory to write\r\n# dump files into and the frequency in seconds with which dumps should\r\n# occur.\r\n\r\nmodule.exports = class RewindDumpRestore extends require('events').EventEmitter\r\n    constructor: (@master,@settings) ->\r\n        super()\r\n\r\n        @_streams       = {}\r\n        @_queue         = []\r\n        @_working       = false\r\n        @_shouldLoad    = false\r\n\r\n        @log = @master.log.child(module:\"rewind_dump_restore\")\r\n\r\n        # -- make sure directory is valid -- #\r\n\r\n        @_path = fs.realpathSync( path.resolve( process.cwd(), @settings.dir ) )\r\n\r\n        if (s = fs.statSync(@_path))?.isDirectory()\r\n            # good\r\n        else\r\n            @log.error \"RewindDumpRestore path (#{@_path}) is invalid.\"\r\n            return false\r\n\r\n        # -- create agents for each stream -- #\r\n\r\n        for s,obj of @master.streams\r\n            @_streams[ s ] = new Dumper s, obj.rewind, @_path\r\n\r\n            obj.once \"destroy\", =>\r\n                delete @_streams[s]\r\n\r\n        # watch for new streams\r\n        @master.on \"new_stream\", (stream) =>\r\n            @log.debug \"RewindDumpRestore got new stream: #{stream.key}\"\r\n            @_streams[stream.key] = new Dumper stream.key, stream.rewind, @_path\r\n\r\n        # -- set our interval -- #\r\n\r\n        if (@settings.frequency||-1) > 0\r\n            @log.debug \"RewindDumpRestore initialized with interval of #{ @settings.frequency } seconds.\"\r\n            @_int = setInterval =>\r\n                @_triggerDumps()\r\n            , @settings.frequency*1000\r\n\r\n\r\n    #----------\r\n\r\n    load: (cb) ->\r\n        @_shouldLoad = true\r\n\r\n        load_q = ( d for k,d of @_streams )\r\n\r\n        results = success:0, errors:0\r\n\r\n        _load = =>\r\n            if d = load_q.shift()\r\n                d._tryLoad (err,stats) =>\r\n                    if err\r\n                        @log.error \"Load for #{ d.key } errored: #{err}\", stream:d.key\r\n                        results.errors += 1\r\n                    else\r\n                        results.success += 1\r\n\r\n                    _load()\r\n            else\r\n                # done\r\n                @log.info \"RewindDumpRestore load complete.\", success:results.success, errors:results.errors\r\n                cb? null, results\r\n\r\n        _load()\r\n\r\n    #----------\r\n\r\n    _triggerDumps: (cb) ->\r\n        @log.silly \"Queuing Rewind dumps\"\r\n        @_queue.push ( d for k,d of @_streams )...\r\n\r\n        @_dump cb if !@_working\r\n\r\n    #----------\r\n\r\n    _dump: (cb) ->\r\n        @_working = true\r\n\r\n        if d = @_queue.shift()\r\n            d._dump (err,file,timing) =>\r\n                if err\r\n                    if d.stream\r\n                        @log.error \"Dump for #{d.key} errored: #{err}\", stream:d.stream.key\r\n                    else\r\n                        @log.error \"Dump for #{d.key} errored (with no stream): #{err}\"\r\n                # for tests...\r\n                @emit \"debug\", \"dump\", d.key, err, file:file, timing:timing\r\n\r\n                @_dump cb\r\n\r\n        else\r\n            @_working = false\r\n            cb?()\r\n\r\n    #----------\r\n\r\n    class Dumper extends require('events').EventEmitter\r\n        constructor: (@key,@rewind,@_path) ->\r\n            super()\r\n\r\n            @_i             = null\r\n            @_active        = false\r\n            @_loaded        = null\r\n            @_tried_load    = false\r\n\r\n            @_filepath = path.join(@_path,\"#{@rewind._rkey}.dump\")\r\n\r\n        #----------\r\n\r\n        _tryLoad: (cb) ->\r\n            # try loading our filepath. catch the error if it is not found\r\n            rs = fs.createReadStream @_filepath\r\n\r\n            rs.once \"error\", (err) =>\r\n                @_setLoaded false\r\n\r\n                if err.code == \"ENOENT\"\r\n                    # not an error. just doesn't exist\r\n                    return cb null\r\n\r\n                cb err\r\n\r\n            rs.once \"open\", =>\r\n                @rewind.loadBuffer rs, (err,stats) =>\r\n                    @_setLoaded true\r\n                    cb null, stats\r\n\r\n        #----------\r\n\r\n        _setLoaded: (status) ->\r\n            @_loaded        = status\r\n            @_tried_load    = true\r\n            @emit \"loaded\", status\r\n\r\n        #----------\r\n\r\n        once_loaded: (cb) ->\r\n            if @_tried_load\r\n                cb?()\r\n            else\r\n                @once \"loaded\", cb\r\n\r\n        #----------\r\n\r\n        _dump: (cb) ->\r\n            if @_active\r\n                cb new Error \"RewindDumper failed: Already active for #{ @rewind._rkey }\"\r\n                return false\r\n\r\n            if @rewind.isLoading()\r\n                cb new Error \"RewindDumper: Cannot dump while rewind buffer is loading.\"\r\n                return false\r\n\r\n            @_active = true\r\n            start_ts = _.now()\r\n\r\n            cb = _.once cb\r\n\r\n            # -- open our output file -- #\r\n\r\n            # To make sure we don't crash mid-write, we want to write to a temp file\r\n            # and then get renamed to our actual filepath location.\r\n\r\n            w = fs.createWriteStream \"#{@_filepath}.new\"\r\n\r\n            w.once \"open\", =>\r\n                @rewind.dumpBuffer (err,writer) =>\r\n                    writer.pipe(w)\r\n\r\n                    w.once \"close\", =>\r\n                        if w.bytesWritten == 0\r\n                            err = null\r\n                            af = _.after 2, =>\r\n                                end_ts = _.now()\r\n                                @_active = false\r\n                                cb err, null, end_ts - start_ts\r\n\r\n                            fs.unlink \"#{@_filepath}.new\", (e) =>\r\n                                err = e if e\r\n                                af()\r\n\r\n                            # we also want to unlink any existing dump file\r\n                            fs.unlink @_filepath, (e) =>\r\n                                err = e if e && e.code != \"ENOENT\"\r\n                                af()\r\n\r\n                        else\r\n                            fs.rename \"#{@_filepath}.new\", @_filepath, (err) =>\r\n                                if err\r\n                                    cb err\r\n                                    return false\r\n\r\n                                end_ts = _.now()\r\n                                @_active = false\r\n                                cb null, @_filepath, end_ts - start_ts\r\n\r\n            w.on \"error\", (err) =>\r\n                cb err\r\n"
  ]
}