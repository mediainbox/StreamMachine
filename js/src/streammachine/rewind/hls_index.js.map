{
  "version": 3,
  "file": "hls_index.js",
  "sourceRoot": "../../../../src/streammachine/rewind/",
  "sources": [
    "hls_index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\n\r\nmodule.exports = class HLSIndex\r\n    constructor: (@stream,@tz,@group) ->\r\n        @_shouldRun = false\r\n        @_running   = false\r\n\r\n        @_segment_idx       = {}\r\n        @_segments          = []\r\n        @_segment_length    = null\r\n\r\n        @_header = null\r\n        @_index  = null\r\n\r\n        @_short_header   = null\r\n        @_short_index    = null\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        @stream = null\r\n\r\n    #----------\r\n\r\n    loadSnapshot: (snapshot) ->\r\n        if snapshot\r\n            @_segments          = snapshot.segments\r\n            @_segment_duration  = snapshot.segment_duration\r\n            @queueIndex()\r\n\r\n    #----------\r\n\r\n    queueIndex: ->\r\n        @_shouldRun = true\r\n        @_runIndex()\r\n\r\n    #----------\r\n\r\n    _runIndex: ->\r\n        return false if @_running || !@stream\r\n\r\n        @_running   = true\r\n        @_shouldRun = false\r\n\r\n        _after = =>\r\n            # -- should we run again? -- #\r\n\r\n            @_running = false\r\n            @_runIndex() if @_shouldRun\r\n\r\n        # clone the segments array, in case it changes while we're running\r\n        segs = @_segments.slice(0)\r\n\r\n        if segs.length < 3\r\n            # not enough buffer for a playlist yet\r\n            @header = null\r\n            @_index  = null\r\n\r\n            _after()\r\n            return false\r\n\r\n        # -- Determine Short Index Start -- #\r\n\r\n        _short_length   = 120 / @_segment_duration\r\n        _short_start    = segs.length - 1 - _short_length\r\n        _short_start    = 2 if _short_start < 2\r\n\r\n        # -- build our header -- #\r\n\r\n        head = Buffer.from \"\"\"\r\n        #EXTM3U\r\n        #EXT-X-VERSION:3\r\n        #EXT-X-TARGETDURATION:#{@_segment_duration}\r\n        #EXT-X-MEDIA-SEQUENCE:#{segs[2].id}\r\n        #EXT-X-DISCONTINUITY-SEQUENCE:#{segs[2].discontinuitySeq}\r\n        #EXT-X-INDEPENDENT-SEGMENTS\r\n\r\n        \"\"\"\r\n\r\n        short_head = Buffer.from \"\"\"\r\n        #EXTM3U\r\n        #EXT-X-VERSION:3\r\n        #EXT-X-TARGETDURATION:#{@_segment_duration}\r\n        #EXT-X-MEDIA-SEQUENCE:#{segs[_short_start].id}\r\n        #EXT-X-DISCONTINUITY-SEQUENCE:#{segs[_short_start].discontinuitySeq}\r\n        #EXT-X-INDEPENDENT-SEGMENTS\r\n\r\n        \"\"\"\r\n\r\n        # run through segments and build the index\r\n        # We skip the first three segments for the index, but we'll use\r\n        # segment #2 for our next ts\r\n\r\n        idx_segs    = []\r\n        idx_length  = 0\r\n\r\n        # what ids are in this segment list?\r\n        seg_ids = (String(seg.id) for seg in segs)\r\n\r\n        # -- loop through remaining segments -- #\r\n\r\n        dseq = segs[1].discontinuitySeq\r\n\r\n        for seg,i in segs[2..]\r\n            if !@_segment_idx[ seg.id ]\r\n                # is the segment where we expect it in the timeline?\r\n                has_disc = !(seg.discontinuitySeq == dseq)\r\n\r\n                seg.idx_buffer = Buffer.from \"\"\"\r\n                #{ if has_disc then \"#EXT-X-DISCONTINUITY\\n\" else \"\" }#EXTINF:#{seg.duration / 1000},\r\n                #EXT-X-PROGRAM-DATE-TIME:#{@tz(seg.ts_actual,\"%FT%T.%3N%:z\")}\r\n                /#{@stream.key}/ts/#{seg.id}.#{@stream.opts.format}\r\n                \"\"\"\r\n\r\n                @_segment_idx[ seg.id ] = seg\r\n\r\n            b = @_segment_idx[ seg.id ].idx_buffer\r\n            idx_length += b.length\r\n            idx_segs.push b\r\n\r\n            dseq = seg.discontinuitySeq\r\n\r\n        # -- build the segment map -- #\r\n\r\n        seg_map = {}\r\n        for s in segs\r\n            seg_map[ s.id ] = s\r\n\r\n        # -- set these as active -- #\r\n\r\n        @_header        = head\r\n        @_index         = idx_segs\r\n        @_index_length  = idx_length\r\n\r\n        @_short_header  = short_head\r\n        @_short_index   = idx_segs[ _short_start.. ]\r\n\r\n        short_length    = 0\r\n        short_length += b.length for b in @_short_index\r\n\r\n        @_short_length  = short_length\r\n\r\n        # what segments should be removed from our index?\r\n        old_seg_ids = Object.keys(@_segment_idx)\r\n\r\n        for id in _(old_seg_ids).difference(seg_ids)\r\n            delete @_segment_idx[ id ] if @_segment_idx[ id ]\r\n\r\n        _after()\r\n\r\n    #----------\r\n\r\n    short_index: (session,cb) ->\r\n        session = if session then Buffer.from(session+\"\\n\") else Buffer.from(\"\\n\")\r\n\r\n        if !@_short_header\r\n            return cb null, null\r\n\r\n        writer = new HLSIndex.Writer @_short_header, @_short_index, @_short_length, session\r\n        cb null, writer\r\n\r\n    #----------\r\n\r\n    index: (session,cb) ->\r\n        session = if session then Buffer.from(session+\"\\n\") else Buffer.from(\"\\n\")\r\n\r\n        if !@_header\r\n            return cb null, null\r\n\r\n        writer = new HLSIndex.Writer @_header, @_index, @_index_length, session\r\n        cb null, writer\r\n\r\n    #----------\r\n\r\n    pumpSegment: (rewinder,id,cb) ->\r\n        # given a segment id, look the segment up in our store to get start ts\r\n        # and duration, then ask the RewindBuffer for the appropriate data\r\n\r\n        if s = @_segment_idx[ Number(id) ]\r\n            # valid segment...\r\n            dur = @stream.secsToOffset s.duration / 1000\r\n            @stream.pumpFrom rewinder, s.ts_actual, dur, false, (err,info) =>\r\n                if err\r\n                    cb err\r\n                else\r\n                    cb null, _.extend info, pts:s.pts\r\n        else\r\n            cb \"Segment not found in index.\"\r\n\r\n    #----------\r\n\r\n    class @Writer extends require(\"stream\").Readable\r\n        constructor: (@header,@index,@ilength,@session) ->\r\n            super()\r\n\r\n            @_sentHeader = false\r\n            @_idx = 0\r\n\r\n            # determine total length\r\n            @_length = @header.length + @ilength + (@session.length * @index.length)\r\n\r\n        length: ->\r\n            @_length\r\n\r\n        _read: (size) ->\r\n            sent = 0\r\n\r\n            bufs = []\r\n\r\n            if !@_sentHeader\r\n                bufs.push @header\r\n                @_sentHeader = true\r\n                sent += @header.length\r\n\r\n            loop\r\n                bufs.push @index[@_idx]\r\n                bufs.push @session\r\n\r\n                sent += @index[@_idx].length\r\n                sent += @session.length\r\n\r\n                @_idx += 1\r\n\r\n                break if (sent > size) || @_idx == @index.length\r\n\r\n            @push Buffer.concat(bufs,sent)\r\n\r\n            if @_idx == @index.length\r\n                @push null\r\n"
  ]
}