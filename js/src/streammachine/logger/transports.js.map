{
  "version": 3,
  "file": "transports.js",
  "sourceRoot": "../../../../src/streammachine/logger/",
  "sources": [
    "transports.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "winston = require \"winston\"\r\nWinstonCommon = require \"winston/lib/winston/common\"\r\nfs          = require \"fs\"\r\npath        = require \"path\"\r\nstrftime    = require(\"prettydate\").strftime\r\nTransport   = require('winston-transport')\r\ndebug = require(\"debug\")\r\n\r\nclass DebugTransport extends Transport\r\n    name: \"debug\"\r\n\r\n    constructor: (opts) ->\r\n        super opts\r\n        @defaultFn = require(\"debug\")(\"sm:log\")\r\n        @debugFnByComponent = {}\r\n\r\n    getDebugFn: (component) ->\r\n        fn = @debugFnByComponent[component]\r\n\r\n        if (!fn)\r\n            fn = debug('sm:' + component)\r\n            @debugFnByComponent[component] = fn\r\n\r\n        return fn\r\n\r\n    log: (info, callback) ->\r\n        fn = if info.component then @getDebugFn(info.component) else @defaultFn\r\n        fn (\"[#{info.level.toUpperCase()}] #{info.message}\")\r\n        callback null, true\r\n\r\n#----------\r\n\r\n\r\n\r\nclass ConsoleTransport extends winston.transports.Console\r\n    constructor: (opts) ->\r\n        super opts\r\n        @opts = opts\r\n        @ignore_levels = (@opts.ignore||\"\").split(\",\")\r\n\r\n    log: (info, callback) ->\r\n        if @silent\r\n            return callback null, true\r\n\r\n        if @ignore_levels.indexOf(level) != -1\r\n            return callback null, true\r\n\r\n        # extract prefix elements from meta\r\n        prefixes = []\r\n        for k in ['pid','mode','component']\r\n            if info[k]\r\n                prefixes.push info[k]\r\n                delete info[k]\r\n\r\n        output = WinstonCommon.log\r\n            colorize:    this.colorize\r\n            json:        this.json\r\n            level:       level\r\n            message:     msg\r\n            meta:        info\r\n            stringify:   this.stringify\r\n            timestamp:   this.timestamp\r\n            prettyPrint: this.prettyPrint\r\n            raw:         this.raw\r\n            label:       this.label\r\n\r\n        if prefixes.length > 0\r\n            output = prefixes.join(\"/\") + \" -- \" + output\r\n\r\n        if level == 'error' || level == 'debug'\r\n            process.stderr.write output + \"\\n\"\r\n        else\r\n            process.stdout.write output + \"\\n\"\r\n\r\n        @emit \"logged\"\r\n        callback null, true\r\n\r\n#----------\r\n\r\nclass W3CLogger extends winston.Transport\r\n    name: \"w3c\"\r\n\r\n    constructor: (options) ->\r\n        super(options)\r\n\r\n        @options = options\r\n\r\n        @_opening   = false\r\n        @_file      = null\r\n        @_queue = []\r\n\r\n        process.addListener \"SIGHUP\", =>\r\n            console.log \"w3c reloading log file\"\r\n            @close => @open()\r\n\r\n#----------\r\n\r\n    log: (level,msg,meta,cb) ->\r\n        # unlike a normal logging endpoint, we only care about our request entries\r\n        if level == @options.level\r\n        # for a valid w3c log, level should == \"request\", meta.\r\n            logline = \"#{meta.ip} #{strftime(new Date(meta.time),\"%F %T\")} #{meta.path} 200 #{escape(meta.ua)} #{meta.bytes} #{meta.seconds}\"\r\n\r\n            @_queue.push logline\r\n            @_runQueue()\r\n\r\n#----------\r\n\r\n    _runQueue:  ->\r\n        if @_file\r\n            # we're open, so do a write...\r\n            if @_queue.length > 0\r\n                line = @_queue.shift()\r\n                @_file.write line+\"\\n\", \"utf8\", =>\r\n                    @_runQueue if @_queue.length > 0\r\n\r\n        else\r\n            @open (err) => @_runQueue()\r\n\r\n#----------\r\n\r\n    open: (cb) ->\r\n        if @_opening\r\n            console.log \"W3C already opening... wait.\"\r\n            # we're already trying to open.  return an error so we queue the message\r\n            return false\r\n\r\n        console.log \"W3C opening log file.\"\r\n\r\n        # note that we're opening, and also set a timeout to make sure\r\n        # we don't get stuck\r\n        @_opening = setTimeout =>\r\n            console.log \"Failed to open w3c log within one second.\"\r\n            @_opening = false\r\n            @open(cb)\r\n        , 1000\r\n\r\n        # is this a new file or one that we're just re-opening?\r\n        initFile = true\r\n        if fs.existsSync(@options.filename)\r\n            # file exists...  see if there's anything in it\r\n            stats = fs.statSync(@options.filename)\r\n\r\n            if stats.size > 0\r\n                # existing file...  don't write headers, just open so we can\r\n                # start appending\r\n                initFile = false\r\n\r\n        @_file = fs.createWriteStream @options.filename, flags:(if initFile then \"w\" else \"r+\")\r\n\r\n        @_file.once \"open\", (err) =>\r\n            console.log \"w3c log open with \", err\r\n\r\n            _clear = =>\r\n                console.log \"w3c open complete\"\r\n                clearTimeout @_opening if @_opening\r\n                @_opening = null\r\n                cb?()\r\n\r\n            if initFile\r\n                # write our initial w3c lines before we return\r\n                @_file.write \"#Software: StreamMachine\\n#Version: 0.2.9\\n#Fields: c-ip date time cs-uri-stem c-status cs(User-Agent) sc-bytes x-duration\\n\", \"utf8\", =>\r\n                    _clear()\r\n\r\n            else\r\n                _clear()\r\n\r\n#----------\r\n\r\n    close: (cb) ->\r\n        @_file?.end null, null, =>\r\n            console.log \"W3C log file closed.\"\r\n        @_file = null\r\n\r\n#----------\r\n\r\n    flush: ->\r\n        @_runQueue()\r\n\r\n#----------\r\n\r\nclass SocketLogger extends winston.Transport\r\n    name: \"socket\"\r\n\r\n    constructor: (@io,opts) ->\r\n        super(opts)\r\n\r\n    log: (level,msg,meta,cb) ->\r\n        @io.log level:level, msg:msg, meta:meta\r\n        cb?()\r\n\r\n\r\nmodule.exports =\r\n    DebugTransport: DebugTransport\r\n    ConsoleTransport: ConsoleTransport\r\n    W3CLogger: W3CLogger\r\n    SocketLogger: SocketLogger\r\n"
  ]
}