{
  "version": 3,
  "file": "source_in.js",
  "sourceRoot": "../../../../src/streammachine/master/",
  "sources": [
    "source_in.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "net     = require \"net\"\r\nexpress = require \"express\"\r\n\r\ndebug = require(\"debug\")(\"sm:master:source_in\")\r\n\r\nIcecastSource = require \"../sources/icecast\"\r\n\r\nmodule.exports = class SourceIn extends require(\"events\").EventEmitter\r\n    constructor: (opts) ->\r\n        super()\r\n\r\n        @core = opts.core\r\n\r\n        @log = @core.log.child mode:\"sourcein\"\r\n\r\n        # grab our listening port\r\n        @port = opts.port\r\n\r\n        @behind_proxy = opts.behind_proxy\r\n\r\n        # create our server\r\n\r\n        @server = net.createServer (c) => @_connection(c)\r\n\r\n    listen: (spec=@port) ->\r\n        #@core.log.debug \"SourceIn listening on \", spec:spec\r\n        debug \"SourceIn listening on #{spec}\"\r\n        @server.listen spec\r\n\r\n    _connection: (sock) =>\r\n        @log.debug \"Incoming source attempt.\"\r\n\r\n        # immediately attach an error listener so that a connection reset\r\n        # doesn't crash the whole system\r\n        sock.on \"error\", (err) =>\r\n            @log.debug \"Source socket errored with #{err}\"\r\n\r\n        # set a timeout for successful / unsuccessful parsing\r\n        timer = setTimeout =>\r\n            @log.debug \"Incoming source connection failed to validate before timeout.\"\r\n\r\n            sock.write \"HTTP/1.0 400 Bad Request\\r\\n\"\r\n            sock.end \"Unable to validate source connection.\\r\\n\"\r\n        , 2000\r\n\r\n        # -- incoming data -- #\r\n\r\n        parser = new SourceIn.IcyParser SourceIn.IcyParser.REQUEST\r\n\r\n        readerF = =>\r\n            parser.execute d while d = sock.read()\r\n        sock.on \"readable\", readerF\r\n\r\n        parser.once \"invalid\", =>\r\n            # disconnect our reader\r\n            sock.removeListener \"readable\", readerF\r\n\r\n            # close the connection\r\n            sock.end \"HTTP/1.0 400 Bad Request\\n\\n\"\r\n\r\n        parser.once \"headersComplete\", (headers) =>\r\n            # cancel our timeout\r\n            clearTimeout timer\r\n\r\n            if /^(ICE|HTTP)$/.test(parser.info.protocol) && /^(SOURCE|PUT)$/.test(parser.info.method)\r\n                @log.debug \"ICY SOURCE attempt.\", url:parser.info.url\r\n                @_trySource sock, parser.info\r\n\r\n                # get out of the way\r\n                sock.removeListener \"readable\", readerF\r\n\r\n    _trySource: (sock,info) =>\r\n        _authFunc = (mount) =>\r\n            # first, make sure the authorization header contains the right password\r\n            @log.debug \"Trying to authenticate ICY source for #{mount.key}\"\r\n            if info.headers.authorization && @_authorize(mount.password,info.headers.authorization)\r\n                sock.write \"HTTP/1.0 200 OK\\n\\n\"\r\n                @log.debug \"ICY source authenticated for #{mount.key}.\"\r\n\r\n                # if we're behind a proxy, look for the true IP address\r\n                source_ip = sock.remoteAddress\r\n                if @behind_proxy && info.headers['x-forwarded-for']\r\n                    source_ip = info.headers['x-forwarded-for']\r\n\r\n                # now create a new source\r\n                source = new IcecastSource\r\n                    format:     mount.opts.format\r\n                    sock:       sock\r\n                    headers:    info.headers\r\n                    logger:     mount.log\r\n                    source_ip:  source_ip\r\n\r\n                mount.addSource source\r\n\r\n            else\r\n                @log.debug \"ICY source failed to authenticate for #{mount.key}.\"\r\n                sock.write \"HTTP/1.0 401 Unauthorized\\r\\n\"\r\n                sock.end \"Invalid source or password.\\r\\n\"\r\n\r\n\r\n        # -- source request... is the endpoint one that we recognize? -- #\r\n\r\n        if Object.keys(@core.source_mounts).length > 0 && m = ///^/(#{Object.keys(@core.source_mounts).join(\"|\")})///.exec info.url\r\n            debug \"Incoming source matched mount: #{m[1]}\"\r\n            mount = @core.source_mounts[ m[1] ]\r\n            _authFunc mount\r\n\r\n        else\r\n            debug \"Incoming source matched nothing. Disconnecting.\"\r\n            @log.debug \"ICY source attempted to connect to bad URL.\", url:info.url\r\n\r\n            sock.write \"HTTP/1.0 401 Unauthorized\\r\\n\"\r\n            sock.end \"Invalid source or password.\\r\\n\"\r\n\r\n    _tmp: ->\r\n        if ///^/admin/metadata///.match req.url\r\n            res.writeHead 200, headers\r\n            res.end \"OK\"\r\n\r\n        else\r\n            res.writeHead 400, headers\r\n            res.end \"Invalid method #{res.method}.\"\r\n\r\n    #----------\r\n\r\n    _authorize: (stream_passwd,header) ->\r\n        # split the auth type from the value\r\n        [type,value] = header.split \" \"\r\n\r\n        if type.toLowerCase() == \"basic\"\r\n            value = Buffer.from(value, 'base64').toString('ascii')\r\n            [user,pass] = value.split \":\"\r\n\r\n            if pass == stream_passwd\r\n                true\r\n            else\r\n                false\r\n        else\r\n            false\r\n\r\n    #----------\r\n\r\n    class @IcyParser extends require(\"events\").EventEmitter\r\n        constructor: (type) ->\r\n            super()\r\n\r\n            @[\"INIT_\"+type]()\r\n            @offset = 0\r\n\r\n        @REQUEST:    \"REQUEST\"\r\n        @RESPONSE:   \"RESPONSE\"\r\n\r\n        reinitialize: @\r\n\r\n        execute: (@chunk) ->\r\n            @offset = 0\r\n            @end = @chunk.length\r\n\r\n            while @offset < @end\r\n                @[@state]()\r\n                @offset++;\r\n\r\n            true\r\n\r\n        INIT_REQUEST: ->\r\n            @state = \"REQUEST_LINE\"\r\n            @lineState = \"DATA\"\r\n            @info = headers:{}\r\n\r\n        consumeLine: ->\r\n            @captureStart = @offset if !@captureStart?\r\n\r\n            byte = @chunk[@offset]\r\n            if byte == 0x0d && @lineState == \"DATA\" # \\r\r\n                @captureEnd = @offset\r\n                @lineState = \"ENDING\"\r\n                return\r\n\r\n            if @lineState == \"ENDING\"\r\n                @lineState = \"DATA\"\r\n                return if byte != 0x0a\r\n\r\n                line = @chunk.toString \"ascii\", @captureStart, @captureEnd\r\n\r\n                @captureStart = undefined\r\n                @captureEnd = undefined\r\n\r\n                debug \"Parser request line: #{line}\"\r\n                return line\r\n\r\n        requestExp: /^([A-Z]+) (.*) (ICE|HTTP)\\/(1).(0|1)$/;\r\n\r\n        REQUEST_LINE: ->\r\n            line = @consumeLine()\r\n\r\n            return if !line?\r\n\r\n            match = @requestExp.exec line\r\n\r\n            if match\r\n                [@info.method,@info.url,@info.protocol,@info.versionMajor,@info.versionMinor] = match[1..5]\r\n            else\r\n                # this isn't a request line that we understand... we should\r\n                # close the connection\r\n                @emit \"invalid\"\r\n\r\n            @info.request_offset = @offset\r\n            @info.request_line = line\r\n\r\n            @state = \"HEADER\"\r\n\r\n        headerExp: /^([^:]+): *(.*)$/\r\n\r\n        HEADER: ->\r\n            line = @consumeLine()\r\n\r\n            return if !line?\r\n\r\n            if line\r\n                match = @headerExp.exec line\r\n                @info.headers[match[1].toLowerCase()] = match[2]\r\n            else\r\n                @emit \"headersComplete\", @info.headers\r\n                #@state = \"BODY\"\r\n"
  ]
}