{
  "version": 3,
  "file": "monitoring.js",
  "sourceRoot": "../../../../src/streammachine/master/",
  "sources": [
    "monitoring.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\n\r\n# Monitoring component\r\n# - checks if a stream has no active sources\r\n# - checks if a slave is responsive/unresponsive\r\n# - checks if a slave buffer is out of sync with masters'\r\n\r\nmodule.exports = class Monitoring extends require(\"events\").EventEmitter\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @master = @ctx.master\r\n        @logger = @ctx.logger.child({\r\n            component: \"monitoring\"\r\n        })\r\n\r\n        # -- check monitored source mounts for sources -- #\r\n\r\n        @_streamInt = setInterval =>\r\n            for k,sm of @master.source_mounts\r\n                @master.alerts.update \"sourceless\", sm.key, !sm.source? if sm.config.monitored\r\n        , 5*1000\r\n\r\n        # -- Monitor Slave Status -- #\r\n\r\n        @_pollForSlaveSync() if @master.slaves\r\n\r\n    #----------\r\n\r\n    shutdown: ->\r\n        clearInterval @_streamInt if @_streamInt\r\n        clearInterval @_slaveInt if @_slaveInt\r\n        @master.slaves?.removeListener \"disconnect\", @_dFunc\r\n\r\n    #----------\r\n\r\n    _pollForSlaveSync: ->\r\n        # -- Monitor Slave IO for disconnects -- #\r\n\r\n        @_dFunc = (slave_id) =>\r\n            # set this in a timeout just in case we're mid-status at the time\r\n            setTimeout =>\r\n                # mark any alerts as cleared\r\n                for k in [\"slave_unsynced\",\"slave_unresponsive\"]\r\n                    @master.alerts.update k, slave_id, false\r\n            , 3000\r\n\r\n        @master.slaveServer.on \"disconnect\", @_dFunc\r\n\r\n        # -- poll for sync -- #\r\n\r\n        @_slaveInt = setInterval =>\r\n            # -- what is master's status? -- #\r\n\r\n            mstatus = @master._rewindStatus()\r\n\r\n            # -- Get slave status -- #\r\n\r\n            @master.slaveServer.pollForSync (err,statuses) =>\r\n\r\n                for stat in statuses\r\n                    # -- update slave responsiveness -- #\r\n\r\n                    if stat.UNRESPONSIVE\r\n                        @master.alerts.update \"slave_unresponsive\", stat.id, true\r\n                        break\r\n\r\n                    @master.alerts.update \"slave_unresponsive\", stat.id, false\r\n\r\n                    # -- are the rewind buffers synced to master? -- #\r\n\r\n                    # For this we need to run through each stream, and then\r\n                    # through each value inside to see if it is within an\r\n                    # acceptable range\r\n\r\n                    unsynced = false\r\n\r\n                    for key,mobj of mstatus\r\n                        if sobj = stat.status[key]\r\n                            for ts in [\"first_buffer_ts\",\"last_buffer_ts\"]\r\n                                sts = Number(new Date(sobj[ts]))\r\n                                mts = Number(mobj[ts])\r\n\r\n                                if ( _.isNaN(sts) && _.isNaN(mts) ) || (mts - 10*1000) < sts < (mts + 10*1000)\r\n                                    # ok\r\n                                else\r\n                                    @logger.info \"Slave #{stat.id} sync unhealthy on #{key}:#{ts}\", sts, mts\r\n                                    unsynced = true\r\n\r\n                        else\r\n                            unsynced = true\r\n\r\n                    @master.alerts.update \"slave_unsynced\", stat.id, unsynced\r\n        , 10*1000\r\n"
  ]
}