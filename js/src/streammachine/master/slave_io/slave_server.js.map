{
  "version": 3,
  "file": "slave_server.js",
  "sourceRoot": "../../../../../src/streammachine/master/slave_io/",
  "sources": [
    "slave_server.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\nSocketIO = require(\"socket.io\")\r\nSlaveConnection = require('./slave_connection')\r\n\r\nmodule.exports = class SlaveServer extends require(\"events\").EventEmitter\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @master = @ctx.master\r\n        @config = @ctx.config\r\n        @logger = @ctx.logger.child({\r\n            component:  \"slave_server\"\r\n        })\r\n\r\n        @io         = null\r\n        @slaves     = {}\r\n        @_config    = null\r\n\r\n        cUpdate = _.debounce =>\r\n            config = @master.config()\r\n            for id, s of @slaves\r\n                @logger.debug \"emit config to slave #{ id }\"\r\n                s.socket.emit \"config\", config\r\n        , 200\r\n\r\n        @master.on \"config_update\", cUpdate\r\n\r\n    #----------\r\n\r\n    updateConfig: (config) ->\r\n        @_config = config\r\n\r\n        for id,s of @slaves\r\n            s.socket.emit \"config\", config\r\n\r\n    #----------\r\n\r\n    listen: (server) ->\r\n        # fire up a socket listener on our slave port\r\n        @io = SocketIO.listen server\r\n\r\n        @logger.info \"Master now listening for slave connections.\"\r\n\r\n        # add our authentication\r\n        @io.use (socket,next) =>\r\n            @logger.debug \"Authenticating slave connection.\"\r\n            if @config.master.password == socket.request._query?.password\r\n                @logger.debug \"Slave password is valid.\"\r\n                next()\r\n            else\r\n                @logger.warn \"Slave password is incorrect.\"\r\n                next new Error \"Invalid slave password.\"\r\n\r\n        # look for slave connections\r\n        @io.on \"connection\", (sock) =>\r\n            @logger.debug \"Master got connection\"\r\n            # a slave may make multiple connections to test transports. we're\r\n            # only interested in the one that gives us the OK\r\n            sock.once \"ok\", (cb) =>\r\n                @logger.debug \"Got OK from incoming slave connection at #{sock.id}\"\r\n\r\n                # ping back to let the slave know we're here\r\n                cb \"OK\"\r\n\r\n                @logger.debug \"slave connection is #{sock.id}\"\r\n\r\n                sock.emit \"config\", @_config if @_config\r\n\r\n                @slaves[sock.id] = new SlaveConnection @ctx, sock\r\n\r\n                @slaves[sock.id].on \"disconnect\", =>\r\n                    delete @slaves[ sock.id ]\r\n                    @emit \"disconnect\", sock.id\r\n\r\n    #----------\r\n\r\n    broadcastAudio: (k,chunk) ->\r\n        for id,s of @slaves\r\n            s.socket.emit \"audio\", {stream:k,chunk:chunk}\r\n\r\n    #----------\r\n\r\n    pollForSync: (cb) ->\r\n        statuses = []\r\n\r\n        cb = _.once cb\r\n\r\n        af = _.after Object.keys(@slaves).length, =>\r\n            cb null, statuses\r\n\r\n        # -- now check the slaves -- #\r\n\r\n        for s,obj of @slaves\r\n            do (s,obj) =>\r\n                saf = _.once af\r\n\r\n                sstat = id:obj.id, UNRESPONSIVE:false, ERROR:null, status:{}\r\n                statuses.push sstat\r\n\r\n                pollTimeout = setTimeout =>\r\n                    @logger.error \"Slave #{s} failed to respond to status.\"\r\n                    sstat.UNRESPONSIVE = true\r\n                    saf()\r\n                , 1000\r\n\r\n                obj.status (err,stat) =>\r\n                    clearTimeout pollTimeout\r\n\r\n                    @logger.error \"Slave #{s} reported status error: #{err}\" if err\r\n\r\n                    sstat.ERROR = err\r\n                    sstat.status = stat\r\n                    saf()\r\n"
  ]
}