{
  "version": 3,
  "file": "stream.js",
  "sourceRoot": "../../../../src/streammachine/master/",
  "sources": [
    "stream.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,UAAA,EAAA,YAAA,EAAA,WAAA,EAAA,MAAA,EAAA,WAAA,EAAA,MAAA,EAAA,iBAAA,EAAA,GAAA,EAAA,CAAA,EAAA;;AAAA,CAAA,GAAU,OAAA,CAAQ,YAAR;;AACV,IAAA,GAAU,OAAA,CAAQ,WAAR;;AACV,GAAA,GAAU,OAAA,CAAQ,KAAR;;AAEV,MAAA,GAAsB,OAAA,CAAQ,kBAAR;;AACtB,UAAA,GAAsB,OAAA,CAAQ,iBAAR;;AACtB,WAAA,GAAsB,OAAA,CAAQ,kBAAR;;AACtB,iBAAA,GAAsB,OAAA,CAAQ,wBAAR;;AACtB,YAAA,GAAsB,OAAA,CAAQ,yBAAR;;AACtB,WAAA,GAAsB,OAAA,CAAQ,gBAAR;;AAEtB,MAAM,CAAC,OAAP,GAAuB;EAAN,MAAA,OAAA,QAAqB,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAAvC;IA6Bb,WAAa,IAAA,KAAA,OAAA,EAAkB,IAAlB,CAAA;AACjB,UAAA,SAAA,EAAA,GAAA,EAAA;;MADkB,IAAC,CAAA;MAAI,IAAC,CAAA;MAAI,IAAC,CAAA;MAGrB,IAAC,CAAA,IAAD,GAAQ,CAAC,CAAC,QAAF,CAAW,IAAA,IAAM,CAAA,CAAjB,EAAqB,IAAC,CAAA,cAAtB,EAFhB;;;;;;;;;MAaQ,IAAC,CAAA,UAAD,GAAc;MACd,IAAC,CAAA,MAAD,GAAU;MAEV,IAAG,IAAI,CAAC,WAAR;;QAEI,IAAC,CAAA,sBAAD,CAAA,EAFJ;OAAA,MAAA;;QAMI,IAAC,CAAA,MAAD,GAAU,IAAC,CAAA,MANf;OAhBR;;MAyBQ,IAAC,CAAA,OAAD,GAAW;MAEX,IAAC,CAAA,YAAD,GAAgB;MAEhB,IAAC,CAAA,MAAD,GAAU;MAEV,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,yBAAX,EA/BR;;;;;MAqCQ,IAAC,CAAA,GAAG,CAAC,IAAL,CAAU,8CAAV;MACA,IAAC,CAAA,MAAD,GAAU,IAAI,MAAJ,CACN;QAAA,OAAA,EAAY,IAAC,CAAA,IAAI,CAAC,OAAlB;QACA,KAAA,EAAY,IAAC,CAAA,IAAI,CAAC,KADlB;QAEA,GAAA,EAAY,CAAA,QAAA,CAAA,CAAW,IAAC,CAAA,GAAZ,CAAA,CAFZ;QAGA,GAAA,EAAY,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW;UAAA,MAAA,EAAO;QAAP,CAAX,CAHZ;QAIA,GAAA,qCAAqB,CAAE;MAJvB,CADM,EAtClB;;MA8CQ,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,QAAb,EAAuB,IAAvB,EA9CR;;MAiDQ,IAAC,CAAA,MAAM,CAAC,EAAR,CAAW,QAAX,EAAqB,CAAC,CAAD,CAAA,GAAA;eAAO,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,CAAhB;MAAP,CAArB,EAjDR;;MAoDQ,IAAG,qBAAH;QACI,IAAC,CAAA,MAAM,CAAC,aAAa,CAAC,EAAtB,CAAyB,UAAzB,EAAqC,CAAC,IAAD,CAAA,GAAA;iBACjC,IAAC,CAAA,IAAD,CAAM,cAAN,EAAsB,IAAtB;QADiC,CAArC,EADJ;OApDR;;MA0DQ,IAAC,CAAA,KAAD,GACI;QAAA,WAAA,EAAgB,IAAC,CAAA,IAAI,CAAC,SAAtB;QACA,SAAA,EAAgB;MADhB;MAGJ,IAAC,CAAA,cAAD,GAAkB,CAAC,IAAD,CAAA,GAAA;QACd,IAAG,IAAC,CAAA,IAAI,CAAC,gBAAT;iBACI,IAAC,CAAA,WAAD,CAAa,IAAb,EADJ;;MADc;MAIlB,IAAC,CAAA,QAAD,GAAY,CAAC,IAAD,CAAA,GAAA,EAAA;;eAER,IAAC,CAAA,IAAD,CAAM,MAAN,EAAc,CAAC,CAAC,MAAF,CAAS,CAAA,CAAT,EAAa,IAAb,EAAmB;UAAA,IAAA,EAAK,IAAC,CAAA;QAAN,CAAnB,CAAd;MAFQ;MAIZ,IAAC,CAAA,UAAD,GAAc,CAAC,MAAD,CAAA,GAAA;QACV,IAAC,CAAA,OAAD,GAAW;eACX,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,MAAhB;MAFU;MAId,IAAC,CAAA,MAAM,CAAC,EAAR,CAAW,MAAX,EAAmB,IAAC,CAAA,QAApB;MACA,IAAC,CAAA,MAAM,CAAC,EAAR,CAAW,QAAX,EAAqB,IAAC,CAAA,UAAtB,EA3ER;;;;;MAkFQ,IAAG,0BAAH;;QAEI,GAAA,GAAM,GAAG,CAAC,KAAJ,CAAU,IAAC,CAAA,IAAI,CAAC,QAAhB;QAEN,SAAA;AAAY,kBAAO,GAAG,CAAC,QAAX;AAAA,iBACH,OADG;qBAEJ,IAAI,UAAJ,CACI;gBAAA,MAAA,EAAY,IAAC,CAAA,IAAI,CAAC,MAAlB;gBACA,QAAA,EAAY,GAAG,CAAC,IADhB;gBAEA,MAAA,EAAY,IAAC,CAAA;cAFb,CADJ;AAFI,iBAOH,OAPG;AAAA,iBAOM,QAPN;qBAQJ,IAAI,WAAJ,CACI;gBAAA,MAAA,EAAY,IAAC,CAAA,IAAI,CAAC,MAAlB;gBACA,GAAA,EAAY,IAAC,CAAA,IAAI,CAAC,QADlB;gBAEA,OAAA,EAAY,IAAC,CAAA,IAAI,CAAC,OAFlB;gBAGA,QAAA,EAAY,IAHZ;gBAIA,MAAA,EAAY,IAAC,CAAA;cAJb,CADJ;AARI;qBAgBJ;AAhBI;;QAkBZ,IAAG,SAAH;UACI,SAAS,CAAC,IAAV,CAAe,SAAf,EAA0B,CAAA,CAAA,GAAA;mBACtB,IAAC,CAAA,SAAD,CAAW,SAAX,EAAsB,CAAC,GAAD,CAAA,GAAA;cAClB,IAAG,GAAH;uBACI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,uCAAX,EADJ;eAAA,MAAA;uBAGI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,4BAAX,EAHJ;;YADkB,CAAtB;UADsB,CAA1B;UAOA,SAAS,CAAC,EAAV,CAAa,OAAb,EAAsB,CAAC,GAAD,CAAA,GAAA;mBAClB,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,uBAAA,CAAA,CAA0B,GAA1B,CAAA,CAAX,EAA4C;cAAA,KAAA,EAAM;YAAN,CAA5C;UADkB,CAAtB,EARJ;SAAA,MAAA;UAYI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,6CAAA,CAAA,CAAgD,IAAC,CAAA,IAAI,CAAC,QAAtD,CAAA,CAAX,EAZJ;SAtBJ;;IAnFS,CA5BjB;;;IAqJI,sBAAwB,CAAA,CAAA;AAC5B,UAAA;MAAQ,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,kCAAA,CAAA,CAAsC,IAAC,CAAA,GAAvC,CAAA,CAAX,EAAR;;MAIQ,OAAA,GAAU,IAAI,iBAAJ,CACN;QAAA,MAAA,EAAgB,IAAC,CAAA,KAAjB;QACA,WAAA,EAAgB,IAAC,CAAA,IAAI,CAAC,WADtB;QAEA,MAAA,EAAgB,IAAC,CAAA,IAAI,CAAC,MAFtB;QAGA,MAAA,EAAgB,IAAC,CAAA;MAHjB,CADM;MAMV,IAAC,CAAA,MAAD,GAAU,QAVlB;;aAaQ,OAAO,CAAC,IAAR,CAAa,YAAb,EAA2B,CAAA,CAAA,GAAA;QACvB,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,4BAAA,CAAA,CAAgC,IAAC,CAAA,GAAjC,CAAA,CAAA,CAAX;QACA,IAAmD,CAAC,IAAC,CAAA,UAArD;iBAAA,OAAO,CAAC,QAAR,CAAiB,CAAC,CAAA,CAAA,GAAA;mBAAG,IAAC,CAAA,sBAAD,CAAA;UAAH,CAAD,CAAjB,EAAA;;MAFuB,CAA3B;IAdoB,CArJ5B;;;IAyKI,SAAW,CAAC,MAAD,EAAQ,EAAR,CAAA;aACP,IAAC,CAAA,MAAM,CAAC,SAAR,CAAkB,MAAlB,EAA0B,EAA1B;IADO,CAzKf;;;;;IAgLI,MAAQ,CAAA,CAAA;aACJ,IAAC,CAAA;IADG,CAhLZ;;;IAqLI,MAAQ,CAAC,EAAD,CAAA;AACZ,UAAA;MAAQ,MAAA,GAAS,CAAC,CAAD,CAAA,GAAA;0CACL,GAAI,MAAM;MADL;MAGT,IAAG,IAAC,CAAA,OAAJ;eACI,MAAA,CAAO,IAAC,CAAA,OAAR,EADJ;OAAA,MAAA;eAGI,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,MAAhB,EAHJ;;IAJI,CArLZ;;;IAgMI,cAAgB,CAAC,EAAD,CAAA;MACZ,IAAG,IAAC,CAAA,MAAM,CAAC,aAAX;eACI,IAAC,CAAA,MAAM,CAAC,aAAa,CAAC,QAAtB,CAA+B,EAA/B,EADJ;OAAA,MAAA;eAGI,EAAA,CAAG,6BAAH,EAHJ;;IADY,CAhMpB;;;IAwMI,YAAc,CAAC,EAAD,CAAA;MACV,IAAG,IAAC,CAAA,OAAJ;0CACI,GAAI,IAAC,CAAA,OAAO,CAAC,oBADjB;OAAA,MAAA;eAGI,IAAC,CAAA,IAAD,CAAM,QAAN,EAAgB,CAAA,CAAA,GAAA;4CAAG,GAAI,IAAC,CAAA,OAAO,CAAC;QAAhB,CAAhB,EAHJ;;IADU,CAxMlB;;;IAgNI,MAAQ,CAAA,CAAA;aAEJ,CAAA;;QAAA,GAAA,EAAY,IAAC,CAAA,GAAb;QACA,EAAA,EAAY,IAAC,CAAA,GADb;QAEA,MAAA,EAAY,IAAC,CAAA,OAFb;QAGA,MAAA,EAAY,IAAC,CAAA,MAAM,CAAC,MAAR,CAAA,CAHZ;QAIA,MAAA,EAAY,IAAC,CAAA,MAAM,CAAC,QAAR,CAAA;MAJZ;IAFI,CAhNZ;;;IA0NI,WAAa,CAAC,IAAD,EAAM,EAAN,CAAA;MACT,IAAG,0BAAA,IAAqB,oBAAxB;QACI,IAAC,CAAA,KAAK,CAAC,WAAP,GAAqB,IAAI,CAAC,WAAL,IAAkB,IAAI,CAAC,MADhD;;MAGA,IAAG,wBAAA,IAAmB,kBAAtB;QACI,IAAC,CAAA,KAAK,CAAC,SAAP,GAAmB,IAAI,CAAC,SAAL,IAAgB,IAAI,CAAC,IAD5C;;MAGA,IAAC,CAAA,IAAD,CAAM,MAAN,EAAc,IAAC,CAAA,KAAf;wCAEA,GAAI,MAAM,IAAC,CAAA;IATF,CA1NjB;;;IAuOI,SAAW,CAAC,QAAD,EAAU,EAAV,CAAA;AACf,UAAA,CAAA,EAAA,GAAA,EAAA;AACQ;;MAAA,KAAA,QAAA;;QACI,IAA0B,mBAA1B;UAAA,IAAC,CAAA,IAAI,CAAC,CAAD,CAAL,GAAW,QAAQ,CAAC,CAAD,EAAnB;;QAGA,IAA+B,CAAC,CAAC,QAAF,CAAW,IAAC,CAAA,cAAc,CAAC,CAAD,CAA1B,CAA/B;;UAAA,IAAC,CAAA,IAAI,CAAC,CAAD,CAAL,GAAW,MAAA,CAAO,IAAC,CAAA,IAAI,CAAC,CAAD,CAAZ,EAAX;;MAJJ;MAMA,IAAG,IAAC,CAAA,GAAD,KAAQ,IAAC,CAAA,IAAI,CAAC,GAAjB;QACI,IAAC,CAAA,GAAD,GAAO,IAAC,CAAA,IAAI,CAAC,IADjB;OAPR;;MAWQ,IAAG,QAAQ,CAAC,SAAZ;QACI,IAAC,CAAA,WAAD,CAAa;UAAA,KAAA,EAAM,QAAQ,CAAC;QAAf,CAAb,EADJ;OAXR;;MAeQ,IAAC,CAAA,MAAM,CAAC,SAAR,CAAkB,IAAC,CAAA,IAAI,CAAC,OAAxB,EAAiC,IAAC,CAAA,IAAI,CAAC,KAAvC;MAEA,IAAC,CAAA,IAAD,CAAM,QAAN;wCAEA,GAAI,MAAM,IAAC,CAAA,MAAD,CAAA;IApBH,CAvOf;;;IA+PI,SAAW,CAAC,EAAD,CAAA;aACP,IAAC,CAAA,MAAM,CAAC,UAAR,CAAmB,CAAC,GAAD,EAAK,MAAL,CAAA,GAAA;0CACf,GAAI,MAAM;MADK,CAAnB;IADO,CA/Pf;;;IAqQI,OAAS,CAAA,CAAA,EAAA;;MAEL,IAAC,CAAA,UAAD,GAAc;MAEd,IAAwB,IAAC,CAAA,MAAD,YAAmB,iBAA3C;QAAA,IAAC,CAAA,MAAM,CAAC,UAAR,CAAA,EAAA;;MACA,IAAC,CAAA,MAAM,CAAC,UAAR,CAAA;MAEA,IAAC,CAAA,MAAM,CAAC,cAAR,CAAuB,MAAvB,EAA+B,IAAC,CAAA,QAAhC;MACA,IAAC,CAAA,MAAM,CAAC,cAAR,CAAuB,QAAvB,EAAiC,IAAC,CAAA,UAAlC;MAEA,IAAC,CAAA,QAAD,GAAY,IAAC,CAAA,UAAD,GAAc,IAAC,CAAA,cAAD,GAAkB,QAAA,CAAA,CAAA,EAAA;MAE5C,IAAC,CAAA,IAAD,CAAM,SAAN;aACA;IAbK;;EAtQI;;mBACb,cAAA,GACI;IAAA,aAAA,EAAoB,KAApB;IACA,UAAA,EAAoB,OADpB;IAEA,GAAA,EAAoB,IAFpB;IAGA,OAAA,EAAqB,EAAA,GAAG,EAAH,GAAM,CAH3B;IAIA,KAAA,EAAoB,EAJpB;IAKA,eAAA,EAAoB,IALpB;IAMA,IAAA,EAAoB,IANpB;IAOA,QAAA,EAAoB,IAPpB;IAQA,gBAAA,EAAoB,KARpB;IASA,WAAA,EAAoB,IATpB;IAUA,SAAA,EAAoB,KAVpB;IAWA,SAAA,EAAoB,EAXpB;IAYA,OAAA,EAAoB,EAZpB;IAaA,MAAA,EAAoB,KAbpB;IAcA,OAAA,EAAoB,EAdpB;IAeA,WAAA,EAAoB,EAfpB;IAgBA,UAAA,EAAoB,EAhBpB;IAiBA,UAAA,EAAoB,KAjBpB;IAkBA,KAAA,EAAoB,IAlBpB;IAmBA,SAAA,EAAoB,CAnBpB;IAoBA,KAAA,EAAoB,IApBpB;IAqBA,WAAA,EAAoB,IArBpB;IAsBA,UAAA,EAAoB,IAtBpB;IAuBA,gBAAA,EAAoB,IAvBpB;IAwBA,YAAA,EAAoB,KAxBpB;IAyBA,OAAA,EAAoB;EAzBpB;;;EAqRE,MAAC,CAAA,cAAP,MAAA,YAAA,QAA2B,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAA7C;IACI,WAAa,IAAA,KAAA,CAAA;;MAAC,IAAC,CAAA;MAAI,IAAC,CAAA;MAGhB,IAAC,CAAA,OAAD,GAAkB,CAAA;MAClB,IAAC,CAAA,WAAD,GAAkB,CAAA;MAClB,IAAC,CAAA,UAAD,GAAkB;IALT,CAArB;;;IASQ,SAAW,CAAC,MAAD,CAAA;AACnB,UAAA,OAAA,EAAA;MAAY,IAAG,CAAC,IAAC,CAAA,OAAO,CAAE,MAAM,CAAC,GAAT,CAAZ;QACI,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,GAAA,CAAA,CAAM,IAAC,CAAA,GAAP,CAAA,gBAAA,CAAA,CAA6B,MAAM,CAAC,GAApC,CAAA,CAAX;QAEA,IAAC,CAAA,OAAO,CAAE,MAAM,CAAC,GAAT,CAAR,GAAyB,OAFzC;;QAKgB,OAAA,GAAU,CAAA,CAAA,GAAA;UACN,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,GAAA,CAAA,CAAM,IAAC,CAAA,GAAP,CAAA,uBAAA,CAAA,CAAqC,MAAM,CAAC,GAA5C,CAAA,CAAX;iBACA,OAAO,IAAC,CAAA,OAAO,CAAE,MAAM,CAAC,GAAT;QAFT;QAIV,MAAM,CAAC,EAAP,CAAU,YAAV,EAAwB,OAAxB;QAEA,MAAM,CAAC,EAAP,CAAU,QAAV,EAAoB,CAAA,CAAA,GAAA;UAChB,IAAa,MAAM,CAAC,IAAI,CAAC,KAAZ,KAAqB,IAAC,CAAA,GAAnC;mBAAA,OAAA,CAAA,EAAA;;QADgB,CAApB,EAXhB;;gEAe2C,CAAE,WAA7B,CAAyC,IAAzC,WAhBJ;;IADO,CATnB;;;IA8BQ,MAAQ,CAAA,CAAA;AAChB,UAAA,CAAA,EAAA,GAAA,EAAA,CAAA,EAAA;MAAY,OAAA,GAAU,CAAA;AACV;MAAA,KAAA,QAAA;;QAAA,OAAO,CAAC,CAAD,CAAP,GAAa,CAAC,CAAC,MAAF,CAAA;MAAb;aAEA;QAAA,EAAA,EAAY,IAAC,CAAA,GAAb;QACA,OAAA,EAAY;MADZ;IAJI,CA9BhB;;;IAuCQ,mBAAqB,CAAC,EAAD,CAAA;AAC7B,UAAA;MAAY,IAAG,CAAC,IAAC,CAAA,UAAF,IAAgB,EAAA,GAAK,IAAC,CAAA,UAAzB;QACI,IAAA,GAAO,IAAC,CAAA;QACR,IAAC,CAAA,UAAD,GAAc;QACd,IAAC,CAAA,IAAD,CAAM,wBAAN,EAAgC,EAAhC;eACA,IAAC,CAAA,GAAG,CAAC,KAAL,CAAW,CAAA,wBAAA,CAAA,CAA2B,EAA3B,CAAA,cAAA,CAAA,CAA8C,IAA9C,CAAA,CAAA,CAAX,EAJJ;;IADiB;;EAxCzB;;;;;;AAlSJ",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nuuid    = require \"node-uuid\"\r\nURL     = require \"url\"\r\n\r\nRewind              = require '../rewind_buffer'\r\nFileSource          = require \"../sources/file\"\r\nProxySource         = require '../sources/proxy'\r\nTranscodingSource   = require \"../sources/transcoding\"\r\nHLSSegmenter        = require \"../rewind/hls_segmenter\"\r\nSourceMount         = require \"./source_mount\"\r\n\r\nmodule.exports = class Stream extends require('events').EventEmitter\r\n    DefaultOptions:\r\n        meta_interval:      32768\r\n        max_buffer:         4194304 # 4 megabits (64 seconds of 64k audio)\r\n        key:                null\r\n        seconds:            (60*60*4) # 4 hours\r\n        burst:              30\r\n        source_password:    null\r\n        host:               null\r\n        fallback:           null\r\n        acceptSourceMeta:   false\r\n        log_minutes:        true\r\n        monitored:          false\r\n        metaTitle:          \"\"\r\n        metaUrl:            \"\"\r\n        format:             \"mp3\"\r\n        preroll:            \"\"\r\n        preroll_key:        \"\"\r\n        transcoder:         \"\"\r\n        root_route:         false\r\n        group:              null\r\n        bandwidth:          0\r\n        codec:              null\r\n        ffmpeg_args:        null\r\n        stream_key:         null\r\n        impression_delay:   5000\r\n        log_interval:       30000\r\n        geolock:            null\r\n\r\n    constructor: (@key,@log,@mount,opts)->\r\n        super()\r\n\r\n        @opts = _.defaults opts||{}, @DefaultOptions\r\n\r\n        # We have three options for what source we're going to use:\r\n        # a) Internal: Create our own source mount and manage our own sources.\r\n        #    Basically the original stream behavior.\r\n        # b) Source Mount: Connect to a source mount and use its source\r\n        #    directly. You'll get whatever incoming format the source gets.\r\n        # c) Source Mount w/ Transcoding: Connect to a source mount, but run a\r\n        #    transcoding source between it and us, so that we always get a\r\n        #    certain format as our input.\r\n\r\n        @destroying = false\r\n        @source = null\r\n\r\n        if opts.ffmpeg_args\r\n            # Source Mount w/ transcoding\r\n            @_initTranscodingSource()\r\n\r\n        else\r\n            # Source Mount directly\r\n            @source = @mount\r\n\r\n        # Cache the last stream vitals we've seen\r\n        @_vitals = null\r\n\r\n        @emitDuration = 0\r\n\r\n        @STATUS = \"Initializing\"\r\n\r\n        @log.event \"Stream is initializing.\"\r\n\r\n        # -- Initialize Master Rewinder -- #\r\n\r\n        # set up a rewind buffer, for use in bringing new slaves up to speed\r\n        # or to transfer to a new master when restarting\r\n        @log.info \"Initializing RewindBuffer for master stream.\"\r\n        @rewind = new Rewind\r\n            seconds:    @opts.seconds\r\n            burst:      @opts.burst\r\n            key:        \"master__#{@key}\"\r\n            log:        @log.child(module:\"rewind\")\r\n            hls:        @opts.hls?.segment_duration\r\n\r\n        # Rewind listens to us, not to our source\r\n        @rewind.emit \"source\", @\r\n\r\n        # Pass along buffer loads\r\n        @rewind.on \"buffer\", (c) => @emit \"buffer\", c\r\n\r\n        # if we're doing HLS, pass along new segments\r\n        if @opts.hls?\r\n            @rewind.hls_segmenter.on \"snapshot\", (snap) =>\r\n                @emit \"hls_snapshot\", snap\r\n\r\n        # -- Set up data functions -- #\r\n\r\n        @_meta =\r\n            StreamTitle:    @opts.metaTitle\r\n            StreamUrl:      \"\"\r\n\r\n        @sourceMetaFunc = (meta) =>\r\n            if @opts.acceptSourceMeta\r\n                @setMetadata meta\r\n\r\n        @dataFunc = (data) =>\r\n            # inject our metadata into the data object\r\n            @emit \"data\", _.extend {}, data, meta:@_meta\r\n\r\n        @vitalsFunc = (vitals) =>\r\n            @_vitals = vitals\r\n            @emit \"vitals\", vitals\r\n\r\n        @source.on \"data\", @dataFunc\r\n        @source.on \"vitals\", @vitalsFunc\r\n\r\n        # -- Hardcoded Source -- #\r\n\r\n        # This is an initial source like a proxy that should be connected from\r\n        # our end, rather than waiting for an incoming connection\r\n\r\n        if @opts.fallback?\r\n            # what type of a fallback is this?\r\n            uri = URL.parse @opts.fallback\r\n\r\n            newsource = switch uri.protocol\r\n                when \"file:\"\r\n                    new FileSource\r\n                        format:     @opts.format\r\n                        filePath:   uri.path\r\n                        logger:     @log\r\n\r\n                when \"http:\", \"https:\"\r\n                    new ProxySource\r\n                        format:     @opts.format\r\n                        url:        @opts.fallback\r\n                        headers:    @opts.headers\r\n                        fallback:   true\r\n                        logger:     @log\r\n\r\n                else\r\n                    null\r\n\r\n            if newsource\r\n                newsource.once \"connect\", =>\r\n                    @addSource newsource, (err) =>\r\n                        if err\r\n                            @log.error \"Connection to fallback source failed.\"\r\n                        else\r\n                            @log.event \"Fallback source connected.\"\r\n\r\n                newsource.on \"error\", (err) =>\r\n                    @log.error \"Fallback source error: #{err}\", error:err\r\n\r\n            else\r\n                @log.error \"Unable to determine fallback source type for #{@opts.fallback}\"\r\n\r\n    #----------\r\n\r\n    _initTranscodingSource: ->\r\n        @log.debug \"Setting up transcoding source for #{ @key }\"\r\n\r\n        # -- create a transcoding source -- #\r\n\r\n        tsource = new TranscodingSource\r\n            stream:         @mount\r\n            ffmpeg_args:    @opts.ffmpeg_args\r\n            format:         @opts.format\r\n            logger:         @log\r\n\r\n        @source = tsource\r\n\r\n        # if our transcoder goes down, restart it\r\n        tsource.once \"disconnect\", =>\r\n            @log.error \"Transcoder disconnected for #{ @key }.\"\r\n            process.nextTick (=> @_initTranscodingSource()) if !@destroying\r\n\r\n    #----------\r\n\r\n    addSource: (source,cb) ->\r\n        @source.addSource source, cb\r\n\r\n    #----------\r\n\r\n    # Return our configuration\r\n\r\n    config: ->\r\n        @opts\r\n\r\n    #----------\r\n\r\n    vitals: (cb) ->\r\n        _vFunc = (v) =>\r\n            cb? null, v\r\n\r\n        if @_vitals\r\n            _vFunc @_vitals\r\n        else\r\n            @once \"vitals\", _vFunc\r\n\r\n    #----------\r\n\r\n    getHLSSnapshot: (cb) ->\r\n        if @rewind.hls_segmenter\r\n            @rewind.hls_segmenter.snapshot cb\r\n        else\r\n            cb \"Stream does not support HLS\"\r\n\r\n    #----------\r\n\r\n    getStreamKey: (cb) ->\r\n        if @_vitals\r\n            cb? @_vitals.streamKey\r\n        else\r\n            @once \"vitals\", => cb? @_vitals.streamKey\r\n\r\n    #----------\r\n\r\n    status: ->\r\n        # id is DEPRECATED in favor of key\r\n        key:        @key\r\n        id:         @key\r\n        vitals:     @_vitals\r\n        source:     @source.status()\r\n        rewind:     @rewind._rStatus()\r\n\r\n    #----------\r\n\r\n    setMetadata: (opts,cb) ->\r\n        if opts.StreamTitle? || opts.title?\r\n            @_meta.StreamTitle = opts.StreamTitle||opts.title\r\n\r\n        if opts.StreamUrl? || opts.url?\r\n            @_meta.StreamUrl = opts.StreamUrl||opts.url\r\n\r\n        @emit \"meta\", @_meta\r\n\r\n        cb? null, @_meta\r\n\r\n    #----------\r\n\r\n    configure: (new_opts,cb) ->\r\n        # allow updates, but only to keys that are present in @DefaultOptions.\r\n        for k,v of @DefaultOptions\r\n            @opts[k] = new_opts[k] if new_opts[k]?\r\n\r\n            # convert to a number if necessary\r\n            @opts[k] = Number(@opts[k]) if _.isNumber(@DefaultOptions[k])\r\n\r\n        if @key != @opts.key\r\n            @key = @opts.key\r\n\r\n        # did they update the metaTitle?\r\n        if new_opts.metaTitle\r\n            @setMetadata title:new_opts.metaTitle\r\n\r\n        # Update our rewind settings\r\n        @rewind.setRewind @opts.seconds, @opts.burst\r\n\r\n        @emit \"config\"\r\n\r\n        cb? null, @config()\r\n\r\n    #----------\r\n\r\n    getRewind: (cb) ->\r\n        @rewind.dumpBuffer (err,writer) =>\r\n            cb? null, writer\r\n\r\n    #----------\r\n\r\n    destroy: ->\r\n        # shut down our sources and go away\r\n        @destroying = true\r\n\r\n        @source.disconnect() if @source instanceof TranscodingSource\r\n        @rewind.disconnect()\r\n\r\n        @source.removeListener \"data\", @dataFunc\r\n        @source.removeListener \"vitals\", @vitalsFunc\r\n\r\n        @dataFunc = @vitalsFunc = @sourceMetaFunc = ->\r\n\r\n        @emit \"destroy\"\r\n        true\r\n\r\n    #----------\r\n\r\n    class @StreamGroup extends require(\"events\").EventEmitter\r\n        constructor: (@key,@log) ->\r\n            super()\r\n\r\n            @streams        = {}\r\n            @transcoders    = {}\r\n            @hls_min_id     = null\r\n\r\n        #----------\r\n\r\n        addStream: (stream) ->\r\n            if !@streams[ stream.key ]\r\n                @log.debug \"SG #{@key}: Adding stream #{stream.key}\"\r\n\r\n                @streams[ stream.key ] = stream\r\n\r\n                # listen in case it goes away\r\n                delFunc = =>\r\n                    @log.debug \"SG #{@key}: Stream disconnected: #{ stream.key }\"\r\n                    delete @streams[ stream.key ]\r\n\r\n                stream.on \"disconnect\", delFunc\r\n\r\n                stream.on \"config\", =>\r\n                    delFunc() if stream.opts.group != @key\r\n\r\n                # if HLS is enabled, sync the stream to the rest of the group\r\n                stream.rewind.hls_segmenter?.syncToGroup @\r\n\r\n        #----------\r\n\r\n        status: ->\r\n            sstatus = {}\r\n            sstatus[k] = s.status() for k,s of @streams\r\n\r\n            id:         @key\r\n            streams:    sstatus\r\n\r\n        #----------\r\n\r\n        hlsUpdateMinSegment: (id) ->\r\n            if !@hls_min_id || id > @hls_min_id\r\n                prev = @hls_min_id\r\n                @hls_min_id = id\r\n                @emit \"hls_update_min_segment\", id\r\n                @log.debug \"New HLS min segment id: #{id} (Previously: #{prev})\"\r\n\r\n        #----------\r\n"
  ]
}