{
  "version": 3,
  "file": "source_in.js",
  "sourceRoot": "../../../../../src/streammachine/master/sources/",
  "sources": [
    "source_in.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "net     = require \"net\"\r\nexpress = require \"express\"\r\n\r\nIcecastSource = require \"../../sources/icecast_source\"\r\nIcyParser = require \"./icy_parser\"\r\n\r\nmodule.exports = class SourceIn extends require(\"events\").EventEmitter\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @config = @ctx.config\r\n        @port = @ctx.config.port\r\n        @behind_proxy = @ctx.config.behind_proxy\r\n\r\n        @logger = @ctx.logger.child({\r\n            component: \"source_in\"\r\n        })\r\n\r\n        # create our server\r\n        @server = net.createServer (c) => @_connection(c)\r\n\r\n    listen: (port=@port) ->\r\n        @logger.info \"source_in listening on port #{port}\"\r\n        @server.listen port\r\n\r\n    _connection: (sock) =>\r\n        @logger.debug \"Incoming source attempt.\"\r\n\r\n        # immediately attach an error listener so that a connection reset\r\n        # doesn't crash the whole system\r\n        sock.on \"error\", (err) =>\r\n            @logger.debug \"Source socket errored with #{err}\"\r\n\r\n        # set a timeout for successful / unsuccessful parsing\r\n        timer = setTimeout =>\r\n            @logger.debug \"Incoming source connection failed to validate before timeout.\"\r\n\r\n            sock.write \"HTTP/1.0 400 Bad Request\\r\\n\"\r\n            sock.end \"Unable to validate source connection.\\r\\n\"\r\n        , 2000\r\n\r\n        # -- incoming data -- #\r\n\r\n        parser = new IcyParser IcyParser.REQUEST\r\n\r\n        readerF = =>\r\n            parser.execute d while d = sock.read()\r\n        sock.on \"readable\", readerF\r\n\r\n        parser.once \"invalid\", =>\r\n            # disconnect our reader\r\n            sock.removeListener \"readable\", readerF\r\n\r\n            # close the connection\r\n            sock.end \"HTTP/1.0 400 Bad Request\\n\\n\"\r\n\r\n        parser.once \"headersComplete\", (headers) =>\r\n            # cancel our timeout\r\n            clearTimeout timer\r\n\r\n            if /^(ICE|HTTP)$/.test(parser.info.protocol) && /^(SOURCE|PUT)$/.test(parser.info.method)\r\n                @logger.debug \"ICY SOURCE attempt.\", url:parser.info.url\r\n                @_trySource sock, parser.info\r\n\r\n                # get out of the way\r\n                sock.removeListener \"readable\", readerF\r\n\r\n    _trySource: (sock,info) =>\r\n        _authFunc = (mount) =>\r\n            # first, make sure the authorization header contains the right password\r\n            @logger.debug \"Trying to authenticate ICY source for #{mount.key}\"\r\n            if info.headers.authorization && @_authorize(mount.password,info.headers.authorization)\r\n                sock.write \"HTTP/1.0 200 OK\\n\\n\"\r\n                @logger.debug \"ICY source authenticated for #{mount.key}.\"\r\n\r\n                # if we're behind a proxy, look for the true IP address\r\n                source_ip = sock.remoteAddress\r\n                if @behind_proxy && info.headers['x-forwarded-for']\r\n                    source_ip = info.headers['x-forwarded-for']\r\n\r\n                # now create a new source\r\n                source = new IcecastSource\r\n                    format:     mount.opts.format\r\n                    sock:       sock\r\n                    headers:    info.headers\r\n                    logger:     mount.log\r\n                    source_ip:  source_ip\r\n\r\n                mount.addSource source\r\n\r\n            else\r\n                @logger.debug \"ICY source failed to authenticate for #{mount.key}.\"\r\n                sock.write \"HTTP/1.0 401 Unauthorized\\r\\n\"\r\n                sock.end \"Invalid source or password.\\r\\n\"\r\n\r\n\r\n        # -- source request... is the endpoint one that we recognize? -- #\r\n\r\n        if Object.keys(@ctx.master.source_mounts).length > 0 && m = ///^/(#{Object.keys(@ctx.master.source_mounts).join(\"|\")})///.exec info.url\r\n            @logger.debug \"Incoming source matched mount: #{m[1]}\"\r\n            mount = @ctx.master.source_mounts[ m[1] ]\r\n            _authFunc mount\r\n\r\n        else\r\n            @logger.debug \"ICY source attempted to connect to bad URL.\", url:info.url\r\n\r\n            sock.write \"HTTP/1.0 401 Unauthorized\\r\\n\"\r\n            sock.end \"Invalid source or password.\\r\\n\"\r\n\r\n    _tmp: ->\r\n        if ///^/admin/metadata///.match req.url\r\n            res.writeHead 200, headers\r\n            res.end \"OK\"\r\n\r\n        else\r\n            res.writeHead 400, headers\r\n            res.end \"Invalid method #{res.method}.\"\r\n\r\n    #----------\r\n\r\n    _authorize: (stream_passwd,header) ->\r\n        # split the auth type from the value\r\n        [type,value] = header.split \" \"\r\n\r\n        if type.toLowerCase() == \"basic\"\r\n            value = Buffer.from(value, 'base64').toString('ascii')\r\n            [user,pass] = value.split \":\"\r\n\r\n            if pass == stream_passwd\r\n                true\r\n            else\r\n                false\r\n        else\r\n            false\r\n"
  ]
}