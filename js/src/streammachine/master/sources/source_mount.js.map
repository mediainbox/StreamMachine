{
  "version": 3,
  "file": "source_mount.js",
  "sourceRoot": "../../../../../src/streammachine/master/sources/",
  "sources": [
    "source_mount.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\n\r\nmodule.exports = class SourceMount extends require(\"events\").EventEmitter\r\n    DefaultOptions:\r\n        monitored:          false\r\n        password:           false\r\n        source_password:    false\r\n        format:             \"mp3\"\r\n\r\n    constructor: (@key,logger,opts) ->\r\n        super()\r\n\r\n        @config = _.defaults opts||{}, @DefaultOptions\r\n        @logger = logger.child(\r\n            component: \"source_mount:#{@key}\"\r\n        )\r\n\r\n        @sources = []\r\n        @source = null\r\n\r\n        # Support the old streams-style password key\r\n        @password = @config.password || @config.source_password\r\n\r\n        @_vitals = null\r\n\r\n        @logger.debug \"initialize source mount stream #{@key}\"\r\n\r\n        @dataFunc = (data) =>\r\n            @emit \"data\", data\r\n\r\n        @vitalsFunc = (vitals) =>\r\n            @_vitals = vitals\r\n            @emit \"vitals\", vitals\r\n\r\n    #----------\r\n\r\n    status: ->\r\n        key:        @key\r\n        sources:    s.status() for s in @sources\r\n\r\n    #----------\r\n\r\n    getConfig: ->\r\n        @config\r\n\r\n    #----------\r\n\r\n    configure: (new_opts,cb) ->\r\n        # allow updates, but only to keys that are present in @DefaultOptions.\r\n        for k,v of @DefaultOptions\r\n            @config[k] = new_opts[k] if new_opts[k]?\r\n\r\n            # convert to a number if necessary\r\n            @config[k] = Number(@config[k]) if _.isNumber(@DefaultOptions[k])\r\n\r\n        # support changing our key\r\n        if @key != @config.key\r\n            @key = @config.key\r\n\r\n        # Support the old streams-style password key\r\n        @password = @config.password || @config.source_password\r\n\r\n        @emit \"config\"\r\n\r\n        cb? null, @config()\r\n\r\n    #----------\r\n\r\n    vitals: (cb) ->\r\n        _vFunc = (v) =>\r\n            cb? null, v\r\n\r\n        if @_vitals\r\n            _vFunc @_vitals\r\n        else\r\n            @once \"vitals\", _vFunc\r\n\r\n    #----------\r\n\r\n    addSource: (source,cb) ->\r\n        # add a disconnect monitor\r\n        source.once \"disconnect\", =>\r\n            # remove it from the list\r\n            @sources = _(@sources).without source\r\n\r\n            # was this our current source?\r\n            if @source == source\r\n                # yes...  need to promote the next one (if there is one)\r\n                if @sources.length > 0\r\n                    @useSource @sources[0]\r\n                    @emit \"disconnect\", active:true, count:@sources.length, source:@source\r\n                else\r\n                    @logger.warn \"Source disconnected. No sources remaining.\"\r\n                    @_disconnectSource @source\r\n                    @source = null\r\n                    @emit \"disconnect\", active:true, count:0, source:null\r\n            else\r\n                # no... just remove it from the list\r\n                @logger.info \"Inactive source disconnected.\"\r\n                @emit \"disconnect\", active:false, count:@sources.length, source:@source\r\n\r\n        # -- Add the source to our list -- #\r\n\r\n        @sources.push source\r\n\r\n        # -- Should this source be made active? -- #\r\n\r\n        # check whether this source should be made active. It should be if\r\n        # the active source is defined as a fallback\r\n\r\n        if @sources[0] == source || @sources[0]?.isFallback\r\n            # our new source should be promoted\r\n            @logger.info \"Promoting new source to active.\", source:(source.TYPE?() ? source.TYPE)\r\n            @useSource source, cb\r\n\r\n        else\r\n            # add the source to the end of our list\r\n            @logger.info \"Source connected.\", source:(source.TYPE?() ? source.TYPE)\r\n\r\n            # and emit our source event\r\n            @emit \"add_source\", source\r\n\r\n            cb? null\r\n\r\n    #----------\r\n\r\n    _disconnectSource: (source) ->\r\n        #source.removeListener \"metadata\",   @sourceMetaFunc\r\n        source.removeListener \"data\",       @dataFunc\r\n        source.removeListener \"vitals\",     @vitalsFunc\r\n\r\n    #----------\r\n\r\n    useSource: (newsource,cb) ->\r\n        # stash our existing source if we have one\r\n        old_source = @source || null\r\n\r\n        # set a five second timeout for the switchover\r\n        alarm = setTimeout =>\r\n            @logger.error \"useSource failed to get switchover within five seconds.\",\r\n                new_source: (newsource.TYPE?() ? newsource.TYPE)\r\n                old_source: (old_source?.TYPE?() ? old_source?.TYPE)\r\n\r\n            cb? new Error \"Failed to switch.\"\r\n        , 5000\r\n\r\n        # Look for a header before switching\r\n        newsource.vitals (err,vitals) =>\r\n            if @source && old_source != @source\r\n                # source changed while we were waiting for vitals. we'll\r\n                # abort our change attempt\r\n                @logger.info \"Source changed while waiting for vitals.\",\r\n                    new_source:     (newsource.TYPE?() ? newsource.TYPE)\r\n                    old_source:     (old_source?.TYPE?() ? old_source?.TYPE)\r\n                    current_source: (@source.TYPE?() ? @source.TYPE)\r\n\r\n                return cb? new Error \"Source changed while waiting for vitals.\"\r\n\r\n            if old_source\r\n                # unhook from the old source's events\r\n                @_disconnectSource(old_source)\r\n\r\n            @source = newsource\r\n\r\n            # connect to the new source's events\r\n            #newsource.on \"metadata\",   @sourceMetaFunc\r\n            newsource.on \"data\",       @dataFunc\r\n            newsource.on \"vitals\",     @vitalsFunc\r\n\r\n            # how often will we be emitting?\r\n            @emitDuration = vitals.emitDuration\r\n\r\n            # note that we've got a new source\r\n            process.nextTick =>\r\n                @logger.info \"New source is active.\",\r\n                    new_source: (newsource.TYPE?() ? newsource.TYPE)\r\n                    old_source: (old_source?.TYPE?() ? old_source?.TYPE)\r\n\r\n                @emit \"source\", newsource\r\n                @vitalsFunc vitals\r\n\r\n            # jump our new source to the front of the list (and remove it from\r\n            # anywhere else in the list)\r\n            @sources = _.flatten [newsource,_(@sources).without newsource]\r\n\r\n            # cancel our timeout\r\n            clearTimeout alarm\r\n\r\n            # give the a-ok to the callback\r\n            cb? null\r\n\r\n    #----------\r\n\r\n    promoteSource: (uuid,cb) ->\r\n        # do we have a source with this UUID?\r\n        if ns = _(@sources).find( (s) => s.uuid == uuid )\r\n            # we do...\r\n            # make sure it isn't already the active source, though\r\n            if ns == @sources[0]\r\n                # it is.  nothing to be done.\r\n                cb? null, msg:\"Source is already active\", uuid:uuid\r\n            else\r\n                # it isn't. we can try to promote it\r\n                @useSource ns, (err) =>\r\n                    if err\r\n                        cb? err\r\n                    else\r\n                        cb? null, msg:\"Promoted source to active.\", uuid:uuid\r\n\r\n        else\r\n            cb? \"Unable to find a source with that UUID on #{@key}\"\r\n\r\n    #----------\r\n\r\n    dropSource: (uuid,cb) ->\r\n\r\n    #----------\r\n\r\n    destroy: ->\r\n        s.disconnect() for s in @sources\r\n        @emit \"destroy\"\r\n        \r\n        @removeAllListeners()\r\n"
  ]
}