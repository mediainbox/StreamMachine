{
  "version": 3,
  "file": "slave_server.js",
  "sourceRoot": "../../../../src/streammachine/master/",
  "sources": [
    "slave_server.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\nSocketIO = require(\"socket.io\")\r\n\r\nmodule.exports = class SlaveServer extends require(\"events\").EventEmitter\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @master = @ctx.master\r\n        @config = @ctx.config\r\n        @logger = @ctx.logger.child({\r\n            component:  \"slave_server\"\r\n        })\r\n\r\n        @io         = null\r\n        @slaves     = {}\r\n        @_config    = null\r\n\r\n        cUpdate = _.debounce =>\r\n            config = @master.config()\r\n            for id, s of @slaves\r\n                @logger.debug \"emit config to slave #{ id }\"\r\n                s.sock.emit \"config\", config\r\n        , 200\r\n\r\n        @master.on \"config_update\", cUpdate\r\n\r\n    #----------\r\n\r\n    updateConfig: (config) ->\r\n        @_config = config\r\n\r\n        for id,s of @slaves\r\n            s.sock.emit \"config\", config\r\n\r\n    #----------\r\n\r\n    listen: (server) ->\r\n        # fire up a socket listener on our slave port\r\n        @io = SocketIO.listen server\r\n\r\n        @logger.info \"Master now listening for slave connections.\"\r\n\r\n        # add our authentication\r\n        @io.use (socket,next) =>\r\n            @logger.debug \"Authenticating slave connection.\"\r\n            if @config.master.password == socket.request._query?.password\r\n                @logger.debug \"Slave password is valid.\"\r\n                next()\r\n            else\r\n                @logger.warn \"Slave password is incorrect.\"\r\n                next new Error \"Invalid slave password.\"\r\n\r\n        # look for slave connections\r\n        @io.on \"connection\", (sock) =>\r\n            @logger.debug \"Master got connection\"\r\n            # a slave may make multiple connections to test transports. we're\r\n            # only interested in the one that gives us the OK\r\n            sock.once \"ok\", (cb) =>\r\n                @logger.debug \"Got OK from incoming slave connection at #{sock.id}\"\r\n\r\n                # ping back to let the slave know we're here\r\n                cb \"OK\"\r\n\r\n                @logger.debug \"slave connection is #{sock.id}\"\r\n\r\n                sock.emit \"config\", @_config if @_config\r\n\r\n                @slaves[sock.id] = new Slave @, sock\r\n\r\n                @slaves[sock.id].on \"disconnect\", =>\r\n                    delete @slaves[ sock.id ]\r\n                    @emit \"disconnect\", sock.id\r\n\r\n    #----------\r\n\r\n    broadcastHLSSnapshot: (k,snapshot) ->\r\n        for id,s of @slaves\r\n            s.sock.emit \"hls_snapshot\", {stream:k,snapshot:snapshot}\r\n\r\n    #----------\r\n\r\n    broadcastAudio: (k,chunk) ->\r\n        for id,s of @slaves\r\n            s.sock.emit \"audio\", {stream:k,chunk:chunk}\r\n\r\n    #----------\r\n\r\n    pollForSync: (cb) ->\r\n        statuses = []\r\n\r\n        cb = _.once cb\r\n\r\n        af = _.after Object.keys(@slaves).length, =>\r\n            cb null, statuses\r\n\r\n        # -- now check the slaves -- #\r\n\r\n        for s,obj of @slaves\r\n            do (s,obj) =>\r\n                saf = _.once af\r\n\r\n                sstat = id:obj.id, UNRESPONSIVE:false, ERROR:null, status:{}\r\n                statuses.push sstat\r\n\r\n                pollTimeout = setTimeout =>\r\n                    @logger.error \"Slave #{s} failed to respond to status.\"\r\n                    sstat.UNRESPONSIVE = true\r\n                    saf()\r\n                , 1000\r\n\r\n                obj.status (err,stat) =>\r\n                    clearTimeout pollTimeout\r\n\r\n                    @logger.error \"Slave #{s} reported status error: #{err}\" if err\r\n\r\n                    sstat.ERROR = err\r\n                    sstat.status = stat\r\n                    saf()\r\n\r\n    #----------\r\n\r\n    class Slave extends require(\"events\").EventEmitter\r\n        constructor: (@sio,@sock) ->\r\n            super()\r\n\r\n            @id             = @sock.id\r\n            @last_status    = null\r\n            @last_err       = null\r\n            @connected_at   = new Date()\r\n\r\n            # -- wire up logging -- #\r\n\r\n            @socklogger = @sio.log.child slave:@sock.id\r\n            @sock.on \"log\", (obj = {}) =>\r\n                @socklogger[obj.level||'debug'].apply @socklogger, [obj.msg||\"\",obj.meta||{}]\r\n\r\n            # -- RPC Handlers -- #\r\n\r\n            @sock.on \"vitals\", (key, cb) =>\r\n                # respond with the stream's vitals\r\n                @sio.master.vitals key, cb\r\n\r\n            @sock.on \"hls_snapshot\", (key,cb) =>\r\n                # respond with the current array of HLS segments for this stream\r\n                @sio.master.getHLSSnapshot key, cb\r\n\r\n            # attach disconnect handler\r\n            @sock.on \"disconnect\", =>\r\n                @_handleDisconnect()\r\n\r\n        #----------\r\n\r\n        status: (cb) ->\r\n            @sock.emit \"status\", (err,status) =>\r\n                @last_status    = status\r\n                @last_err       = err\r\n\r\n                cb err, status\r\n\r\n        #----------\r\n\r\n        _handleDisconnect: ->\r\n            connected = Math.round( (Number(new Date()) - Number(@connected_at)) / 1000 )\r\n            @sio.log.debug \"Slave disconnect from #{@sock.id}. Connected for #{ connected } seconds.\"\r\n\r\n            @emit \"disconnect\"\r\n"
  ]
}