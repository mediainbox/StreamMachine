{
  "version": 3,
  "file": "live_streaming.js",
  "sourceRoot": "../../../../src/streammachine/outputs/",
  "sources": [
    "live_streaming.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,UAAA,EAAA,aAAA,EAAA,OAAA,EAAA,CAAA,EAAA,CAAA,EAAA,EAAA,EAAA;;AAAA,CAAA,GAAM,OAAA,CAAQ,YAAR;;AACN,EAAA,GAAM,OAAA,CAAQ,UAAR;;AACN,IAAA,GAAO,OAAA,CAAQ,WAAR;;AAEP,UAAA,GAAa,OAAA,CAAQ,QAAR;;AAEb,OAAA,GAAU,MAAM,CAAC,IAAP;;AAAY;;;;AAAA;EAAA,KAAA,qCAAA;;iBAAA,MAAA,CAAO,CAAA,EAAA,CAAA,CAAK,CAAL,CAAA,CAAP;EAAA,CAAA;;IAAZ;;AAOV,MAAM,CAAC,OAAP,GAAuB;EAAN,MAAA,cAAA,QAA4B,WAA5B;IACb,WAAa,OAAA,MAAA,CAAA;;MAAC,IAAC,CAAA;MAAO,IAAC,CAAA;MAInB,IAAC,CAAA,MAAM,CAAC,MAAR,CAAe,IAAf,EACI;QAAA,YAAA,EAAgB,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,GAAjC;QACA,QAAA,EAAgB;MADhB,CADJ,EAGE,CAAC,GAAD,EAAK,QAAL,EAAc,IAAd,CAAA,GAAA;AACV,YAAA,OAAA,EAAA;QAAY,IAAG,GAAH;UACI,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,MAAV,CAAiB,GAAjB,CAAqB,CAAC,GAAtB,CAA0B,oBAA1B;AACA,iBAAO,MAFX;SAAZ;;QAKY,GAAA,GAAM;QACN,IAAG,IAAI,CAAC,GAAR;UACI,GAAA,GAAM,MAAM,CAAC,IAAP,CAAY,OAAZ,EAAtB;;;UAGgB,IAAG,IAAI,CAAC,GAAL,GAAW,IAAI,CAAC,GAAL,CAAS,CAAT,EAAW,EAAX,CAAA,GAAe,CAA7B;YACI,GAAG,CAAC,IAAD,CAAH,GAAY;YACZ,GAAG,CAAC,aAAJ,CAAkB,IAAI,CAAC,GAAL,GAAS,CAAC,IAAI,CAAC,GAAL,CAAS,CAAT,EAAW,EAAX,CAAA,GAAe,CAAhB,CAA3B,EAA8C,IAA9C,EAFJ;WAAA,MAAA;YAII,GAAG,CAAC,aAAJ,CAAkB,IAAI,CAAC,GAAvB,EAA2B,IAA3B,EAJJ;WAJJ;;QAUA,OAAA,GACI;UAAA,cAAA,EACO,IAAC,CAAA,MAAM,CAAC,IAAI,CAAC,MAAb,KAAuB,KAA1B,GAA6C,YAA7C,GACQ,IAAC,CAAA,MAAM,CAAC,IAAI,CAAC,MAAb,KAAuB,KAA1B,GAAwC,WAAxC,GACA,SAHT;UAIA,YAAA,EAAwB,OAJxB;UAKA,gBAAA,EAAwB,IAAI,CAAC,MAAL,kBAAc,GAAG,CAAE,gBAAnB,IAA2B;QALnD,EAjBhB;;QAyBY,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,SAAV,CAAoB,GAApB,EAAyB,OAAzB;QAEA,IAAuB,GAAvB;UAAA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAV,CAAgB,GAAhB,EAAA;SA3BZ;;QA8BY,QAAQ,CAAC,IAAT,CAAc,IAAC,CAAA,IAAI,CAAC,GAApB;QAEA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,EAAV,CAAa,QAAb,EAAuB,CAAA,CAAA,GAAA;iBACnB,QAAQ,CAAC,UAAT,CAAA;QADmB,CAAvB;QAGA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,EAAV,CAAa,OAAb,EAAyB,CAAA,CAAA,GAAA;iBAAG,QAAQ,CAAC,UAAT,CAAA;QAAH,CAAzB;eACA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,EAAV,CAAa,KAAb,EAAyB,CAAA,CAAA,GAAA;iBAAG,QAAQ,CAAC,UAAT,CAAA;QAAH,CAAzB;MArCF,CAHF;IAJS,CAAjB;;;IAgDI,cAAgB,CAAC,EAAD,CAAA,EAAA;;aAEZ,EAAA,CAAG,IAAH;IAFY;;EAjDH;;;EAuDP,aAAC,CAAA,QAAP,MAAA,MAAA,QAAqB,WAArB;IACI,WAAa,OAAA,MAAA,CAAA;AACrB,UAAA,OAAA,EAAA;;MADsB,IAAC,CAAA;MAAO,IAAC,CAAA;MAGnB,YAAA,GAAkB,IAAC,CAAA,MAAM,CAAC,UAAR,IAAsB,IAAC,CAAA,MAAM,CAAC,YAAjC,GACZ,CAAA,YAAA,CAAA,CAAe,IAAC,CAAA,MAAM,CAAC,UAAvB,CAAA,CADY,GAAA,OAF3B;;;MAOY,IAAG,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAnB;QACI,YAAA,GAAkB,YAAH,GAAqB,CAAA,CAAA,CAAG,YAAH,CAAA,IAAA,CAAA,CAAsB,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAtC,CAAA,CAArB,GAAqE,CAAA,IAAA,CAAA,CAAO,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAvB,CAAA,EADxF;;MAGA,IAAG,CAAC,IAAC,CAAA,MAAM,CAAC,GAAZ;QACI,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,MAAV,CAAiB,GAAjB,CAAqB,CAAC,GAAtB,CAA0B,UAA1B;AACA,eAFJ;OAVZ;;MAeY,OAAA,GAAU,CAAC,GAAD,EAAK,MAAL,CAAA,GAAA;QACN,IAAG,MAAH;UACI,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,SAAV,CAAoB,GAApB,EACI;YAAA,cAAA,EAAoB,+BAApB;YACA,gBAAA,EAAoB,MAAM,CAAC,MAAP,CAAA;UADpB,CADJ;iBAIA,MAAM,CAAC,IAAP,CAAY,IAAC,CAAA,IAAI,CAAC,GAAlB,EALJ;SAAA,MAAA;iBAQG,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,MAAV,CAAiB,GAAjB,CAAqB,CAAC,GAAtB,CAA0B,UAA1B,EARH;;MADM;MAWV,IAAG,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,SAAb;QACI,IAAC,CAAA,MAAM,CAAC,GAAG,CAAC,WAAZ,CAAwB,YAAxB,EAAsC,OAAtC,EADJ;OAAA,MAAA;QAGI,IAAC,CAAA,MAAM,CAAC,GAAG,CAAC,KAAZ,CAAkB,YAAlB,EAAgC,OAAhC,EAHJ;;IA3BS;;EADjB;;;EAmCM,aAAC,CAAA,aAAP,MAAA,WAAA,QAA0B,WAA1B;IACI,WAAa,MAAA,MAAA,CAAA;;MAAC,IAAC,CAAA;MAAM,IAAC,CAAA;MAIlB,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,SAAV,CAAoB,GAApB,EACI;QAAA,cAAA,EAAgB;MAAhB,CADJ,EAFZ;;MAMY,IAAC,CAAA,KAAK,CAAC,YAAP,CAAoB,IAAC,CAAA,MAArB,EAA6B,CAAC,GAAD,CAAA,GAAA;AACzC,YAAA,GAAA,EAAA,GAAA,EAAA,YAAA,EAAA;QAAgB,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAV,CAAgB,CAAA;AAAA,CAAhB;AAKA;QAAA,KAAA,UAAA;;UACI,GAAA,GAAM,CAAA,CAAA,CAAA,CAAI,CAAC,CAAC,GAAN,CAAA,KAAA;UACN,YAAA,GAAe;UAEf,IAAG,IAAC,CAAA,MAAM,CAAC,YAAX;YACI,YAAY,CAAC,IAAb,CAAkB,CAAA,WAAA,CAAA,CAAc,IAAC,CAAA,MAAM,CAAC,UAAtB,CAAA,CAAlB,EADJ;;UAGA,IAAG,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAnB;YACI,YAAY,CAAC,IAAb,CAAkB,CAAA,GAAA,CAAA,CAAM,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,EAAtB,CAAA,CAAlB,EADJ;;UAGA,IAAG,YAAY,CAAC,MAAb,GAAsB,CAAzB;YACI,GAAA,GAAM,CAAA,CAAA,CAAG,GAAH,CAAA,CAAA,CAAA,CAAU,YAAY,CAAC,IAAb,CAAkB,GAAlB,CAAV,CAAA,EADV;;UAGA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,KAAV,CAAgB,CAAA,4BAAA,CAAA,CACc,CAAC,CAAC,IAAI,CAAC,SADrB,CAAA,SAAA,CAAA,CAC0C,CAAC,CAAC,IAAI,CAAC,KADjD,CAAA;AAAA,CAAA,CAEd,GAFc,CAAA,EAAA,CAAhB;QAbJ;eAkBA,IAAC,CAAA,IAAI,CAAC,GAAG,CAAC,GAAV,CAAA;MAxByB,CAA7B;IARS;;EADjB",
  "sourcesContent": [
    "_   = require \"underscore\"\r\ntz  = require \"timezone\"\r\nuuid = require \"node-uuid\"\r\n\r\nBaseOutput = require \"./base\"\r\n\r\nPTS_TAG = Buffer.from(Number(\"0x#{s}\") for s in \"\"\"\r\n    49 44 33 04 00 00 00 00 00 3F 50 52 49 56 00 00 00 35 00 00 63 6F 6D\r\n    2E 61 70 70 6C 65 2E 73 74 72 65 61 6D 69 6E 67 2E 74 72 61 6E 73 70\r\n    6F 72 74 53 74 72 65 61 6D 54 69 6D 65 73 74 61 6D 70 00 00 00 00 00\r\n    00 00 00 00\r\n    \"\"\".split(/\\s+/))\r\n\r\nmodule.exports = class LiveStreaming extends BaseOutput\r\n    constructor: (@stream,@opts) ->\r\n\r\n        super \"live_streaming\"\r\n\r\n        @stream.listen @,\r\n            live_segment:   @opts.req.params.seg\r\n            pumpOnly:       true\r\n        , (err,playHead,info) =>\r\n            if err\r\n                @opts.res.status(404).end \"Segment not found.\"\r\n                return false\r\n\r\n            # write our PTS tag\r\n            tag = null\r\n            if info.pts\r\n                tag = Buffer.from(PTS_TAG)\r\n                # node 0.10 doesn't know how to write ints over 32-bit, so\r\n                # we do some gymnastics to get around it\r\n                if info.pts > Math.pow(2,32)-1\r\n                    tag[0x44] = 0x01\r\n                    tag.writeUInt32BE(info.pts-(Math.pow(2,32)-1),0x45)\r\n                else\r\n                    tag.writeUInt32BE(info.pts,0x45)\r\n\r\n            headers =\r\n                \"Content-Type\":\r\n                    if @stream.opts.format == \"mp3\"         then \"audio/mpeg\"\r\n                    else if @stream.opts.format == \"aac\"    then \"audio/aac\"\r\n                    else \"unknown\"\r\n                \"Connection\":           \"close\"\r\n                \"Content-Length\":       info.length + tag?.length||0\r\n\r\n            # write out our headers\r\n            @opts.res.writeHead 200, headers\r\n\r\n            @opts.res.write tag if tag\r\n\r\n            # send our pump buffer to the client\r\n            playHead.pipe(@opts.res)\r\n\r\n            @opts.res.on \"finish\", =>\r\n                playHead.disconnect()\r\n\r\n            @opts.res.on \"close\",    => playHead.disconnect()\r\n            @opts.res.on \"end\",      => playHead.disconnect()\r\n\r\n    #----------\r\n\r\n    prepForHandoff: (cb) ->\r\n        # we don't do handoffs, so send skip = true\r\n        cb true\r\n\r\n    #----------\r\n\r\n    class @Index extends BaseOutput\r\n        constructor: (@stream,@opts) ->\r\n            super \"live_streaming\"\r\n\r\n            session_info = if @client.session_id && @client.pass_session\r\n               \"?session_id=#{@client.session_id}\"\r\n\r\n            # HACK: This is needed to get ua information on segments until we\r\n            # can fix client ua for AppleCoreMedia\r\n            if @opts.req.query.ua\r\n                session_info = if session_info then \"#{session_info}&ua=#{@opts.req.query.ua}\" else \"?ua=#{@opts.req.query.ua}\"\r\n\r\n            if !@stream.hls\r\n                @opts.res.status(500).end \"No data.\"\r\n                return\r\n\r\n            # which index should we give them?\r\n            outFunc = (err,writer) =>\r\n                if writer\r\n                    @opts.res.writeHead 200,\r\n                        \"Content-type\":     \"application/vnd.apple.mpegurl\"\r\n                        \"Content-length\":   writer.length()\r\n\r\n                    writer.pipe(@opts.res)\r\n\r\n                else\r\n                   @opts.res.status(500).end \"No data.\"\r\n\r\n            if @opts.req.hls_limit\r\n                @stream.hls.short_index session_info, outFunc\r\n            else\r\n                @stream.hls.index session_info, outFunc\r\n\r\n    #----------\r\n\r\n    class @GroupIndex extends BaseOutput\r\n        constructor: (@group,@opts) ->\r\n\r\n            super \"live_streaming\"\r\n\r\n            @opts.res.writeHead 200,\r\n                \"Content-type\": \"application/vnd.apple.mpegurl\"\r\n\r\n            # who do we ask for the session id?\r\n            @group.startSession @client, (err) =>\r\n                @opts.res.write \"\"\"\r\n                #EXTM3U\r\n\r\n                \"\"\"\r\n\r\n                for key,s of @group.streams\r\n                    url = \"/#{s.key}.m3u8\"\r\n                    session_bits = []\r\n\r\n                    if @client.pass_session\r\n                        session_bits.push \"session_id=#{@client.session_id}\"\r\n\r\n                    if @opts.req.query.ua\r\n                        session_bits.push \"ua=#{@opts.req.query.ua}\"\r\n\r\n                    if session_bits.length > 0\r\n                        url = \"#{url}?#{session_bits.join(\"&\")}\"\r\n\r\n                    @opts.res.write \"\"\"\r\n                    #EXT-X-STREAM-INF:BANDWIDTH=#{s.opts.bandwidth},CODECS=\"#{s.opts.codec}\"\r\n                    #{url}\\n\r\n                    \"\"\"\r\n\r\n                @opts.res.end()\r\n"
  ]
}