{
  "version": 3,
  "file": "shoutcast.js",
  "sourceRoot": "../../../../src/streammachine/outputs/",
  "sources": [
    "shoutcast.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require 'underscore'\r\nIcy     = require \"icy\"\r\n\r\nBaseOutput = require \"./base\"\r\n\r\ndebug = require(\"debug\")(\"sm:outputs:shoutcast\")\r\n\r\nmodule.exports = class Shoutcast extends BaseOutput\r\n    constructor: (@stream,@opts) ->\r\n        super \"shoutcast\"\r\n\r\n        @disconnected = false\r\n        @id = null\r\n\r\n\r\n        @pump = true\r\n\r\n        @_lastMeta = null\r\n\r\n        if @opts.req && @opts.res\r\n            debug \"Incoming Request Headers: \", @opts.req.headers\r\n            # -- startup mode...  sending headers -- #\r\n\r\n            @client.offsetSecs  = @opts.req.query.offset || -1\r\n            @client.meta_int    = @stream.opts.meta_interval\r\n\r\n            @opts.res.chunkedEncoding = false\r\n            @opts.res.useChunkedEncodingByDefault = false\r\n\r\n            @headers =\r\n                \"Content-Type\":\r\n                    if @stream.opts.format == \"mp3\"         then \"audio/mpeg\"\r\n                    else if @stream.opts.format == \"aac\"    then \"audio/aacp\"\r\n                    else \"unknown\"\r\n                \"icy-name\":             @stream.StreamTitle\r\n                \"icy-url\":              @stream.StreamUrl\r\n                \"icy-metaint\":          @client.meta_int\r\n                \"Accept-Ranges\":        \"none\"\r\n\r\n            # write out our headers\r\n            @opts.res.writeHead 200, @headers\r\n            @opts.res._send ''\r\n\r\n            @stream.startSession @client, (err,session_id) =>\r\n                debug \"Incoming connection given session_id of #{session_id}\"\r\n                @client.session_id = session_id\r\n                process.nextTick => @_startAudio(true)\r\n\r\n        else if @opts.socket\r\n            # -- socket mode... just data -- #\r\n\r\n            @pump = false\r\n            process.nextTick => @_startAudio(false)\r\n\r\n        # register our various means of disconnection\r\n        @socket.on \"end\",   => @disconnect()\r\n        @socket.on \"close\", => @disconnect()\r\n        @socket.on \"error\", => @disconnect()\r\n\r\n    #----------\r\n\r\n    _startAudio: (initial) ->\r\n        # -- create an Icecast creator to inject metadata -- #\r\n\r\n        # the initial interval value that we pass in may be different than\r\n        # the one we want to use later.  Since the initializer queues the\r\n        # first read, we can set both in succession without having to worry\r\n        # about timing\r\n        @ice = new Icy.Writer @client.bytesToNextMeta||@client.meta_int\r\n        @ice.metaint = @client.meta_int\r\n        delete @client.bytesToNextMeta\r\n\r\n        # connect the icecast metadata injector to our output\r\n        @ice.pipe(@socket)\r\n\r\n        if initial && @stream.preroll && !@opts.req.query.preskip\r\n            debug \"Pumping preroll\"\r\n            @stream.preroll.pump @, @ice, (err) =>\r\n                debug \"Back from preroll. Connecting to stream.\"\r\n                @connectToStream()\r\n        else\r\n            @connectToStream()\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        super =>\r\n            @ice?.unpipe()\r\n            @source?.disconnect()\r\n            @socket?.end() unless @socket?.destroyed\r\n\r\n    #----------\r\n\r\n    prepForHandoff: (cb) ->\r\n        # we need to know where we are in relation to the icecast metaint\r\n        # boundary so that we can set up our new stream and keep everything\r\n        # in sync\r\n\r\n        @client.bytesToNextMeta = @ice._parserBytesLeft\r\n\r\n        # remove the initial client.offsetSecs if it exists\r\n        delete @client.offsetSecs\r\n\r\n        cb?()\r\n\r\n    #----------\r\n\r\n    connectToStream: ->\r\n        unless @disconnected\r\n            @stream.listen @,\r\n                offsetSecs:     @client.offsetSecs,\r\n                offset:         @client.offset,\r\n                pump:           @pump,\r\n                startTime:      @opts.startTime,\r\n                (err,@source) =>\r\n                    if err\r\n                        if @opts.res?\r\n                            @opts.res.status(500).end err\r\n                        else\r\n                            @socket?.end()\r\n\r\n                        return false\r\n\r\n                    # set our offset (in chunks) now that it's been checked for availability\r\n                    @client.offset = @source.offset()\r\n\r\n                    @source.onFirstMeta (err,meta) =>\r\n                        @ice.queue meta if meta\r\n\r\n                    @metaFunc = (data) =>\r\n                        unless @_lastMeta && _(data).isEqual(@_lastMeta)\r\n                            @ice.queue data\r\n                            @_lastMeta = data\r\n\r\n                    # -- pipe source audio to icecast -- #\r\n\r\n                    @source.pipe @ice\r\n                    @source.on \"meta\", @metaFunc\r\n\r\n    #----------\r\n\r\n"
  ]
}