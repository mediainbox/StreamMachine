{
  "version": 3,
  "file": "standalone.js",
  "sourceRoot": "../../../../src/streammachine/modes/",
  "sources": [
    "standalone.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nexpress = require \"express\"\r\nnconf   = require \"nconf\"\r\n\r\nLogger  = require \"../logger\"\r\nMaster  = require \"../master\"\r\nSlave   = require \"../slave\"\r\n\r\ndebug = require(\"debug\")(\"sm:modes:standalone\")\r\n\r\nmodule.exports = class StandaloneMode extends require(\"./base_mode\")\r\n    MODE: \"StandAlone\"\r\n    constructor: (@opts,cb) ->\r\n        super(opts)\r\n\r\n        # -- Set up logging -- #\r\n\r\n        @log = (new Logger @opts.log).child pid:process.pid\r\n        @log.debug(\"StreamMachine standalone initialized.\")\r\n\r\n        process.title = \"StreamMachine\"\r\n\r\n        @streams = {}\r\n\r\n        # -- Set up master and slave -- #\r\n\r\n        @master = new Master _.extend {}, @opts, logger:@log.child(mode:\"master\")\r\n        @slave  = new Slave _.extend {}, @opts, logger:@log.child(mode:\"slave\")\r\n\r\n        # -- Set up our server(s) -- #\r\n\r\n        @server = express()\r\n        @api_server = null\r\n        @api_handle = null\r\n\r\n        if @opts.api_port\r\n            @api_server = express()\r\n            @api_server.use \"/api\", @master.api.app\r\n\r\n        else\r\n            @log.error \"USING API ON MAIN PORT IS UNSAFE! See api_port documentation.\"\r\n            @server.use \"/api\", @master.api.app\r\n\r\n        @server.use @slave.server.app\r\n\r\n        # -- set up RPC -- #\r\n\r\n        if process.send?\r\n            @_rpc = new RPC process, functions:\r\n                OK: (msg,handle,cb) ->\r\n                    cb null, \"OK\"\r\n\r\n                standalone_port: (msg,handle,cb) =>\r\n                    cb null, @handle?.address().port||\"NONE\"\r\n\r\n                source_port: (msg,handle,cb) =>\r\n                    cb null, @master.sourcein?.server.address()?.port||\"NONE\"\r\n\r\n                api_port: (msg,handle,cb) =>\r\n                    cb null, api_handle?.address()?.port||\"NONE\"\r\n\r\n                stream_listener: (msg,handle,cb) =>\r\n                    @slave.landListener msg, handle, cb\r\n\r\n                config: (config,handle,cb) =>\r\n                    @master.configure config, (err) =>\r\n                        cb err, @master.config()\r\n\r\n                status: (msg,handle,cb) =>\r\n                    @status cb\r\n\r\n        # -- Proxy data events from master -> slave -- #\r\n\r\n        @master.on \"streams\", (streams) =>\r\n            debug \"Standalone saw master streams event\"\r\n            @slave.once \"streams\", =>\r\n                debug \"Standalone got followup slave streams event\"\r\n                for k,v of @master.streams\r\n                    debug \"Checking stream #{k}\"\r\n\r\n                    if @slave.streams[k]?\r\n                        debug \"Mapping master -> slave for #{k}\"\r\n                        @log.debug \"mapping master -> slave on #{k}\"\r\n                        @slave.streams[k].useSource v if !@slave.streams.source\r\n                    else\r\n                        @log.error \"Unable to map master -> slave for #{k}\"\r\n\r\n            @slave.configureStreams @master.config().streams\r\n\r\n        @log.debug \"Standalone is listening on port #{@opts.port}\"\r\n\r\n        # -- Handoff? -- #\r\n\r\n        if nconf.get(\"handoff\")\r\n            @_handoffStart cb\r\n        else\r\n            @_normalStart cb\r\n\r\n    #----------\r\n\r\n    _handoffStart: (cb) ->\r\n        @_acceptHandoff (err) =>\r\n            if err\r\n                @log.error \"_handoffStart Failed! Falling back to normal start: #{err}\"\r\n                @_normalStart cb\r\n\r\n    #----------\r\n\r\n    _normalStart: (cb) ->\r\n        @log.info \"Attaching listeners.\"\r\n        @master.sourcein.listen()\r\n        @handle = @server.listen @opts.port\r\n\r\n        if @api_server\r\n            @log.info \"Starting API server on port #{@opts.api_port}\"\r\n            @api_handle = @api_server.listen @opts.api_port\r\n\r\n        cb? null, @\r\n\r\n    #----------\r\n\r\n    status: (cb) ->\r\n        status = master:null, slave:null\r\n\r\n        aF = _.after 2, =>\r\n            cb null, status\r\n\r\n        # master status\r\n        status.master = @master.status()\r\n        aF()\r\n\r\n        # slave status\r\n        @slave._streamStatus (err,s) =>\r\n            return cb err if err\r\n            status.slave = s\r\n            aF()\r\n\r\n    #----------\r\n\r\n    _sendHandoff: (rpc) ->\r\n        @log.event \"Got handoff signal from new process.\"\r\n\r\n        debug \"In _sendHandoff. Waiting for config.\"\r\n\r\n        rpc.once \"configured\", (msg,handle,cb) =>\r\n            debug \"... got configured. Syncing running config.\"\r\n\r\n            # send stream/source info so we make sure our configs are matched\r\n            rpc.request \"config\", @master.config(), (err,streams) =>\r\n                if err\r\n                    @log.error \"Error setting config on new process: #{err}\"\r\n                    cb \"Error sending config: #{err}\"\r\n                    return false\r\n\r\n                @log.info \"New process confirmed configuration.\"\r\n                debug \"New process confirmed configuration.\"\r\n\r\n                # basically we leave the config request open while we send streams\r\n                cb()\r\n\r\n                @master.sendHandoffData rpc, (err) =>\r\n                    @log.event \"Sent master data to new process.\"\r\n\r\n                    _afterSockets = _.after 3, =>\r\n                        debug \"Socket transfer is done.\"\r\n                        @log.info \"Sockets transferred. Sending listeners.\"\r\n\r\n                        # Send slave listener data\r\n                        debug \"Beginning listener transfer.\"\r\n                        @slave.ejectListeners (obj,h,lcb) =>\r\n                            debug \"Sending a listener...\", obj\r\n                            @_rpc.request \"stream_listener\", obj, h, (err) =>\r\n                                debug \"Listener transfer error: #{err}\" if err\r\n                                lcb()\r\n                        , (err) =>\r\n                            @log.error \"Error sending listeners during handoff: #{err}\" if err\r\n\r\n                            @log.info \"Standalone handoff has sent all information. Exiting.\"\r\n                            debug \"Standalone handoff complete. Exiting.\"\r\n\r\n                            # Exit\r\n                            process.exit()\r\n\r\n                    # Hand over our public listening port\r\n                    @log.info \"Hand off standalone socket.\"\r\n                    rpc.request \"standalone_handle\", null, @handle, (err) =>\r\n                        @log.error \"Error sending standalone handle: #{err}\" if err\r\n                        debug \"Standalone socket sent: #{err}\"\r\n                        @handle.unref()\r\n                        _afterSockets()\r\n\r\n                    # Hand over the source port\r\n                    @log.info \"Hand off source socket.\"\r\n                    rpc.request \"source_socket\", null, @master.sourcein.server, (err) =>\r\n                        @log.error \"Error sending source socket: #{err}\" if err\r\n                        debug \"Source socket sent: #{err}\"\r\n                        @master.sourcein.server.unref()\r\n                        _afterSockets()\r\n\r\n                    @log.info \"Hand off API socket (if it exists).\"\r\n                    rpc.request \"api_handle\", null, @api_handle, (err) =>\r\n                        @log.error \"Error sending API socket: #{err}\" if err\r\n                        debug \"API socket sent: #{err}\"\r\n                        @api_handle?.unref()\r\n                        _afterSockets()\r\n\r\n    #----------\r\n\r\n    _acceptHandoff: (cb) ->\r\n        @log.info \"Initializing handoff receptor.\"\r\n\r\n        debug \"In _acceptHandoff\"\r\n\r\n        if !@_rpc\r\n            cb new Error \"Handoff called, but no RPC interface set up.\"\r\n            return false\r\n\r\n        # If we don't get HANDOFF_GO quickly, something is probably wrong.\r\n        # Perhaps we've been asked to start via handoff when there's no process\r\n        # out there to send us data.\r\n        handoff_timer = setTimeout =>\r\n            debug \"Handoff failed to handshake. Done waiting.\"\r\n            cb new Error \"Handoff failed to handshake within five seconds.\"\r\n        , 5000\r\n\r\n        debug \"Waiting for HANDOFF_GO\"\r\n        @_rpc.once \"HANDOFF_GO\", (msg,handle,ccb) =>\r\n            clearTimeout handoff_timer\r\n\r\n            debug \"HANDOFF_GO received.\"\r\n\r\n            ccb null, \"GO\"\r\n\r\n            debug \"Waiting for internal configuration signal.\"\r\n            @master.once_configured =>\r\n                # signal that we're ready\r\n                debug \"Telling handoff sender that we're configured.\"\r\n                @_rpc.request \"configured\", @master.config(), (err,reply) =>\r\n                    if err\r\n                        @log.error \"Failed to send config broadcast when starting handoff: #{err}\"\r\n                        return false\r\n\r\n                    debug \"Handoff sender ACKed config.\"\r\n\r\n                    @log.info \"Handoff initiator ACKed our config broadcast.\"\r\n\r\n                    @master.loadHandoffData @_rpc, =>\r\n                        @log.info \"Master handoff receiver believes all stream and source data has arrived.\"\r\n\r\n                    aFunc = _.after 3, =>\r\n                        @log.info \"All handles are up.\"\r\n                        cb? null, @\r\n\r\n                    @_rpc.once \"source_socket\", (msg,handle,cb) =>\r\n                        @log.info \"Source socket is incoming.\"\r\n                        @master.sourcein.listen handle\r\n                        debug \"Now listening on source socket.\"\r\n                        cb null\r\n                        aFunc()\r\n\r\n                    @_rpc.once \"standalone_handle\", (msg,handle,cb) =>\r\n                        @log.info \"Standalone socket is incoming.\"\r\n                        @handle = @server.listen handle\r\n                        debug \"Now listening on standalone socket.\"\r\n                        cb null\r\n                        aFunc()\r\n\r\n                    @_rpc.once \"api_handle\", (msg,handle,cb) =>\r\n                        if handle && @api_server\r\n                            debug \"Handoff sent API socket and we have API server\"\r\n                            @log.info \"API socket is incoming.\"\r\n                            @api_handle = @api_server.listen handle\r\n                            debug \"Now listening on API socket.\"\r\n                        else\r\n                            @log.info \"Handoff sent no API socket\"\r\n                            debug \"Handoff sent no API socket.\"\r\n\r\n                            if @api_server\r\n                                debug \"Handoff sent no API socket, but we have API server. Listening.\"\r\n                                @api_handle = @api_server.listen @opts.api_port\r\n\r\n                        cb null\r\n                        aFunc()\r\n"
  ]
}