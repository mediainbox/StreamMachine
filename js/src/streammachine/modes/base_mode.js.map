{
  "version": 3,
  "file": "base_mode.js",
  "sourceRoot": "../../../../src/streammachine/modes/",
  "sources": [
    "base_mode.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,QAAA,EAAA,CAAA,EAAA,YAAA,EAAA;;AAAA,KAAA,GAAU,OAAA,CAAQ,OAAR;;AACV,CAAA,GAAU,OAAA,CAAQ,YAAR;;AACV,CAAA,CAAE,YAAF,CAAA,GAAmB,OAAA,CAAQ,WAAR,CAAnB;;AAEA,MAAM,CAAC,OAAP,GAAuB,WAAN,MAAA,SAAA,QAAuB,OAAA,CAAQ,QAAR,CAAiB,CAAC,aAAzC;EACb,WAAa,OAAA,CAAA;;IAAC,IAAC,CAAA;IAGX,IAAC,CAAA,GAAD,GAAO;MACH,MAAA,EAAQ,IAAC,CAAA,MADN;MAEH,MAAA,EAAQ,YAAA,CAAa,IAAC,CAAA,MAAd,CAFL;MAGH,SAAA,EAAW,CAAA;IAHR;IAMP,IAAC,CAAA,MAAD,GAAU,IAAC,CAAA,GAAG,CAAC,MAAM,CAAC,KAAZ,CAAkB;MACxB,SAAA,EAAW,KAAA,GAAQ,IAAC,CAAA,MAAM,CAAC;IADH,CAAlB;IAGV,IAAC,CAAA,GAAD,GAAO,IAAC,CAAA,OAXhB;;;IAeQ,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,0CAAd;IAEA,IAAG,OAAO,CAAC,SAAR,CAAkB,SAAlB,CAA4B,CAAC,MAA7B,GAAsC,CAAzC;MACI,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,kFAAb,EADJ;KAAA,MAAA;;MAII,OAAO,CAAC,EAAR,CAAW,SAAX,EAAsB,CAAA,CAAA,GAAA;QAClB,IAAG,IAAC,CAAA,WAAJ;AACI,iBAAO,MADX;;QAGA,IAAC,CAAA,WAAD,GAAe;QAKf,IAAG,CAAC,IAAC,CAAA,IAAL;UACE,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,qFAAd;UACA,IAAC,CAAA,WAAD,GAAe;AACf,iBAAO,MAHT;;QAKA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,uDAAb;eAEA,IAAC,CAAA,IAAI,CAAC,OAAN,CAAc,YAAd,EAA4B,IAA5B,EAAkC,IAAlC,EAAwC;UAAA,OAAA,EAAQ;QAAR,CAAxC,EAAuD,CAAC,GAAD,EAAK,KAAL,CAAA,GAAA;UACnD,IAAG,GAAH;YACI,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,2BAAA,CAAA,CAA8B,GAA9B,CAAA,CAAd;YACA,IAAC,CAAA,WAAD,GAAe;AACf,mBAAO,MAHX;;UAKA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,8CAAb;iBACA,IAAC,CAAA,YAAD,CAAc,IAAC,CAAA,IAAf;QAPmD,CAAvD;MAhBkB,CAAtB,EAJJ;;EAlBS,CAAjB;;;;;EAmDI,UAAY,CAAA,CAAA;AAChB,QAAA,CAAA,EAAA,GAAA,EAAA,OAAA,EAAA;AAAQ;AAAA;IAAA,KAAA,QAAA;;mBAAA,CAAC,CAAC,IAAF,CAAA;IAAA,CAAA;;EADQ;;AApDC;;AAJjB",
  "sourcesContent": [
    "nconf   = require \"nconf\"\r\n_       = require \"underscore\"\r\n{ createLogger } = require \"../logger\"\r\n\r\nmodule.exports = class BaseMode extends require(\"events\").EventEmitter\r\n    constructor: (@config) ->\r\n        super()\r\n\r\n        @ctx = {\r\n            config: @config\r\n            logger: createLogger(@config)\r\n            providers: {}\r\n        }\r\n\r\n        @logger = @ctx.logger.child({\r\n            component: 'sm:' + @config.mode\r\n        })\r\n        @log = @logger # compatibility\r\n\r\n\r\n        # see runner for restart trigger based on SIGUSR2\r\n        @logger.debug \"Attaching listener for SIGUSR2 restarts.\"\r\n\r\n        if process.listeners(\"SIGUSR2\").length > 0\r\n            @logger.info \"Skipping SIGUSR2 registration for handoffs since another listener is registered.\"\r\n        else\r\n            # Support a handoff trigger via USR2\r\n            process.on \"SIGUSR2\", =>\r\n                if @_restarting\r\n                    return false\r\n\r\n                @_restarting = true\r\n\r\n                # replacement process is spawned externally\r\n\r\n                # make sure there's an external process out there...\r\n                if !@_rpc\r\n                  @logger.error \"StreamMachine process was asked for external handoff, but there is no RPC interface\"\r\n                  @_restarting = false\r\n                  return false\r\n\r\n                @logger.info \"Sending process for USR2. Starting handoff via proxy.\"\r\n\r\n                @_rpc.request \"HANDOFF_GO\", null, null, timeout:20000, (err,reply) =>\r\n                    if err\r\n                        @logger.error \"Error handshaking handoff: #{err}\"\r\n                        @_restarting = false\r\n                        return false\r\n\r\n                    @logger.info \"Sender got handoff handshake. Starting send.\"\r\n                    @_sendHandoff @_rpc\r\n\r\n    #----------\r\n\r\n    # Build a hash of stream information, including sources and listener counts\r\n\r\n    streamInfo: ->\r\n        s.info() for k,s of @streams\r\n\r\n    #----------\r\n"
  ]
}