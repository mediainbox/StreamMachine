{
  "version": 3,
  "file": "slave_backup.js",
  "sourceRoot": "../../../../src/streammachine/modes/",
  "sources": [
    "slave_backup.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nnconf   = require \"nconf\"\r\npath    = require \"path\"\r\nRPC     = require \"ipc-rpc\"\r\nnet     = require \"net\"\r\nCP      = require \"child_process\"\r\n\r\nLogger  = require \"../logger\"\r\nSlave   = require \"../slave\"\r\n\r\ndebug = require(\"debug\")(\"sm:modes:slave\")\r\n\r\n#----------\r\n\r\nmodule.exports = class SlaveMode extends require(\"./base\")\r\n\r\n    MODE: \"Slave\"\r\n    constructor: (@opts,cb) ->\r\n        super()\r\n\r\n        @log = (new Logger @opts.log).child({mode:'slave',pid:process.pid})\r\n        @log.debug \"Slave Instance initialized\"\r\n\r\n        debug \"Slave Mode init\"\r\n\r\n        process.title = \"StreamM:slave\"\r\n\r\n        @_handle        = null\r\n        @_haveHandle    = false\r\n        @_shuttingDown  = false\r\n        @_inHandoff     = false\r\n\r\n        @_lastAddress   = null\r\n        @_initFull      = false\r\n\r\n        # -- Set up Internal RPC -- #\r\n\r\n        if process.send?\r\n            debug \"Setting up RPC\"\r\n            @_rpc = new RPC process, timeout:5000, functions:\r\n                OK: (msg,handle,cb) ->\r\n                    cb null, \"OK\"\r\n\r\n                slave_port: (msg,handle,cb) =>\r\n                    cb null, @slavePort()\r\n\r\n                #---\r\n\r\n                workers: (msg,handle,cb) =>\r\n\r\n                #---\r\n\r\n                stream_listener: (msg,handle,cb) =>\r\n                    @_landListener null, msg, handle, cb\r\n\r\n                #---\r\n\r\n                ready: (msg,handle,cb) =>\r\n                    # We're \"ready\" once we have one loaded worker\r\n                    @pool.once_loaded cb\r\n\r\n                #---\r\n\r\n                status: (msg,handle,cb) =>\r\n                    @status cb\r\n\r\n        # -- Set up Clustered Worker Pool -- #\r\n\r\n        @pool = new SlaveMode.WorkerPool @, @opts.cluster, @opts\r\n        @pool.on \"full_strength\", => @emit \"full_strength\"\r\n\r\n        process.on \"SIGTERM\", =>\r\n            @pool.shutdown (err) =>\r\n                @log.info \"Pool destroyed.\"\r\n                process.exit()\r\n\r\n        # -- set up server -- #\r\n\r\n        # We handle incoming connections here in the slave process, and then\r\n        # distribute them to our ready workers.\r\n\r\n        # If we're doing a handoff, we wait to receive a server handle from\r\n        # the sending process. If not, we should go ahead and start a server\r\n        # ourself.\r\n\r\n        if nconf.get(\"handoff\")\r\n            @_acceptHandoff cb\r\n        else\r\n            # we'll listen via our configured port\r\n            @_openServer null, cb\r\n\r\n    #----------\r\n\r\n    slavePort: ->\r\n        @_server?.address().port\r\n\r\n    #----------\r\n\r\n    _openServer: (handle,cb) ->\r\n        @_server = net.createServer pauseOnConnect:true, allowHalfOpen:true\r\n        @_server.listen handle || @opts.port, (err) =>\r\n            if err\r\n                @log.error \"Failed to start slave server: #{err}\"\r\n                throw err\r\n\r\n            @_server.on \"connection\", (conn) =>\r\n                # FIXME: This is nasty...\r\n                # https://github.com/joyent/node/issues/7905\r\n                if /^v0.10/.test(process.version)\r\n                    conn._handle.readStop()\r\n\r\n                conn.pause()\r\n                @_distributeConnection conn\r\n\r\n            @log.info \"Slave server is up and listening.\"\r\n\r\n            cb? null, @\r\n\r\n    #----------\r\n\r\n    _distributeConnection: (conn) ->\r\n        w = @pool.getWorker()\r\n\r\n        if !w\r\n            @log.debug \"Listener arrived before any ready workers. Waiting.\"\r\n            @pool.once \"worker_loaded\", =>\r\n                @log.debug \"Distributing listener now that worker is ready.\"\r\n                @_distributeConnection conn\r\n\r\n            return\r\n\r\n        @log.silly \"Distributing listener to worker #{w.id} (#{w.pid})\"\r\n        w.rpc.request \"connection\", null, conn, (err) =>\r\n            if err\r\n                @log.error \"Failed to land incoming connection: #{err}\"\r\n                conn.destroy()\r\n\r\n    #----------\r\n\r\n    shutdownWorker: (id,cb) ->\r\n        @pool.shutdownWorker id, cb\r\n\r\n    #----------\r\n\r\n    status: (cb) ->\r\n        # send back a status for each of our workers\r\n        @pool.status cb\r\n\r\n    #----------\r\n\r\n    _listenerFromWorker: (id,msg,handle,cb) ->\r\n        @log.debug \"Landing listener from worker.\", inHandoff:@_inHandoff\r\n        if @_inHandoff\r\n            # we're in a handoff. ship the listener out there\r\n            @_inHandoff.request \"stream_listener\", msg, handle, (err) =>\r\n                cb err\r\n        else\r\n            # we can hand the listener to any slave except the one\r\n            # it came from\r\n            @_landListener id, msg, handle, cb\r\n\r\n    #----------\r\n\r\n    # Distribute a listener to one of our ready slave workers. This could be\r\n    # an external request via handoff, or it could be an internal request from\r\n    # a worker instance that is shutting down.\r\n\r\n    _landListener: (sender,obj,handle,cb) ->\r\n        w = @pool.getWorker sender\r\n\r\n        if w\r\n            @log.debug \"Asking to land listener on worker #{w.id}\"\r\n            w.rpc.request \"land_listener\", obj, handle, (err) =>\r\n                cb err\r\n        else\r\n            @log.debug \"No worker ready to land listener!\"\r\n            cb \"No workers ready to receive listeners.\"\r\n\r\n    #----------\r\n\r\n    _sendHandoff: (rpc) ->\r\n        @log.info \"Starting slave handoff.\"\r\n\r\n        # don't try to spawn new workers\r\n        @_shuttingDown  = true\r\n        @_inHandoff     = rpc\r\n\r\n        # Coordinate handing off our server handle\r\n\r\n        rpc.request \"server_socket\", {}, @_server?._handle, (err) =>\r\n            if err\r\n                @log.error \"Error sending socket across handoff: #{err}\"\r\n                # FIXME: Proceed? Cancel?\r\n\r\n            @log.info \"Server socket transferred. Sending listener connections.\"\r\n\r\n            # Ask the pool to shut down its workers.\r\n            @pool.shutdown (err) =>\r\n                @log.event \"Sent slave data to new process. Exiting.\"\r\n\r\n                # Exit\r\n                process.exit()\r\n\r\n    #----------\r\n\r\n    _acceptHandoff: (cb) ->\r\n        @log.info \"Initializing handoff receptor.\"\r\n\r\n        if !@_rpc\r\n            @log.error \"Handoff called, but no RPC interface set up. Aborting.\"\r\n            return false\r\n\r\n        @_rpc.once \"HANDOFF_GO\", (msg,handle,hgcb) =>\r\n            @_rpc.once \"server_socket\", (msg,handle,sscb) =>\r\n                @log.info \"Incoming server handle.\"\r\n                @_openServer handle, (err) =>\r\n                    if err\r\n                        # FIXME: How should we recover from this?\r\n                        @log.error \"Failed to start server using transferred handle.\"\r\n                        return false\r\n\r\n                    @log.info \"Server started with handle received during handoff.\"\r\n\r\n                _go = =>\r\n                    # let our sender know we're ready... we're already listening for\r\n                    # the stream_listener requests on our rpc, so our job in here is\r\n                    # done. The rest is on the sender.\r\n                    sscb null\r\n                    cb? null\r\n\r\n                # wait until we're at full strength to start transferring listeners\r\n                if @_initFull\r\n                    _go()\r\n                else\r\n                    @once \"full_strength\", => _go()\r\n\r\n\r\n            hgcb null, \"GO\"\r\n\r\n        if !process.send?\r\n            @log.error \"Handoff called, but process has no send function. Aborting.\"\r\n            return false\r\n\r\n        process.send \"HANDOFF_GO\"\r\n\r\n    #----------\r\n\r\n    class @WorkerPool extends require(\"events\").EventEmitter\r\n        constructor: (@s,@size,@config) ->\r\n            super()\r\n\r\n            @workers    = {}\r\n            @_shutdown  = false\r\n\r\n            debug \"Worker pool init with size of #{@size}.\"\r\n\r\n            @log = @s.log.child component:\"worker_pool\"\r\n\r\n            @_nextId = 1\r\n\r\n            @_spawn()\r\n\r\n            # poll each worker for its status every second\r\n            @_statusPoll = setInterval =>\r\n                for w in @workers\r\n                    do (w) =>\r\n                        return if !w.rpc\r\n                        w.rpc.request \"status\", (err,s) =>\r\n                            @log.error \"Worker status error: #{err}\" if err\r\n                            w.status = id:id, listening:w._listening, loaded:w._loaded, streams:s, pid:w.pid, ts:Number(new Date)\r\n            , 1000\r\n\r\n            process.on \"exit\", =>\r\n                # try one last effort to make sure workers are closed\r\n                w.w.kill() for id,w of @workers\r\n\r\n        #----------\r\n\r\n        _spawn: ->\r\n            if @count() >= @size\r\n                debug \"Pool is now at #{ @count() }. Full strength.\"\r\n                @log.debug \"Pool is at full strength\"\r\n                @emit \"full_strength\"\r\n                return false\r\n\r\n            id = @_nextId\r\n            @_nextId += 1\r\n\r\n            debug \"Spawning worker #{id}.\"\r\n            p = CP.fork path.resolve(__dirname,\"./slave_worker.js\")\r\n            debug \"Worker #{id} forked with pid of #{p.pid}\"\r\n\r\n            @log.debug \"Spawning new worker.\", count:@count(), target:@size\r\n\r\n            w = new SlaveMode.Worker\r\n                id:         id\r\n                w:          p\r\n                rpc:        null\r\n                pid:        p.pid\r\n                status:     null\r\n                _loaded:    false\r\n                _config:    false\r\n\r\n            w.rpc = new RPC p, functions:\r\n\r\n                # triggered by the worker once it has its streams configured\r\n                # (though they may not yet have data to give out)\r\n                worker_configured: (msg,handle,cb) =>\r\n                    @log.debug \"Worker #{w.id} is configured.\"\r\n                    w._config = true\r\n                    cb null\r\n\r\n                #---\r\n\r\n                # sent by the worker once its stream rewinds are loaded.\r\n                # tells us that it's safe to trigger a new worker launch\r\n                rewinds_loaded: (msg,handle,cb) =>\r\n                    @log.debug \"Worker #{w.id} is loaded.\"\r\n                    w._loaded = true\r\n                    @emit \"worker_loaded\"\r\n\r\n                    # ACK\r\n                    cb null\r\n\r\n                    # now that we're done, see if any more workers need to start\r\n                    debug \"Worker #{w.id} rewind loaded. Attempting new spawn.\"\r\n                    @_spawn()\r\n\r\n                #---\r\n\r\n                # a worker is allowed to shed listeners at any point by\r\n                # sending them here. This could be part of a handoff (where\r\n                # we've asked for the listeners), or part of the worker\r\n                # crashing / shutting down\r\n                send_listener: (msg,handle,cb) =>\r\n                    @s._listenerFromWorker w.id, msg, handle, cb\r\n\r\n                #---\r\n\r\n                # triggered by the worker to request configuration\r\n                config: (msg,handle,cb) =>\r\n                    cb null, @config\r\n\r\n            , (err) =>\r\n                if err\r\n                    @log.error \"Error setting up RPC for new worker: #{err}\"\r\n                    worker.kill()\r\n                    return false\r\n\r\n                @log.debug \"Worker #{w.id} is set up.\", id:w.id, pid:w.pid\r\n                debug \"Worker #{w.id} RPC is set up.\"\r\n\r\n                @workers[ w.id ] = w\r\n\r\n            # -- Handle disconnects and exits -- #\r\n\r\n            p.once \"exit\", =>\r\n                debug \"Got exit from worker process #{w.id}\"\r\n                @log.info \"SlaveWorker exit: #{w.id}\"\r\n                delete @workers[ w.id ]\r\n\r\n                w.emit \"exit\"\r\n                w.destroy()\r\n\r\n                @_spawn() if !@_shutdown\r\n\r\n            # error seems to be thrown for issues sending IPC\r\n            p.on \"error\", (err) =>\r\n                debug \"Error from worker process #{w.id}: #{err}\"\r\n                @log.error \"Error from SlaveWorker process: #{err}\"\r\n                # FIXME: What else should we do?\r\n\r\n        #----------\r\n\r\n        count: ->\r\n            Object.keys(@workers).length\r\n\r\n        #----------\r\n\r\n        loaded_count: ->\r\n            _(@workers).select((w) -> w._loaded).length\r\n\r\n        #----------\r\n\r\n        once_loaded: (cb) ->\r\n            if @loaded_count() == 0\r\n                @once \"worker_loaded\", => cb null\r\n            else\r\n                cb null\r\n\r\n        #----------\r\n\r\n        shutdown: (cb) ->\r\n            @_shutdown = true\r\n\r\n            # send kill signals to all workers\r\n            @log.info \"Slave WorkerPool is exiting.\"\r\n\r\n            if @count() == 0\r\n                clearInterval @_statusPoll\r\n                cb null\r\n\r\n            af = _.after @count(), =>\r\n                clearInterval @_statusPoll\r\n                cb null\r\n\r\n            for id,w of @workers\r\n                @shutdownWorker id, (err) =>\r\n                    af()\r\n\r\n        #----------\r\n\r\n        shutdownWorker: (id,cb) ->\r\n            if !@workers[id]\r\n                cb? \"Cannot call shutdown: Worker id unknown\"\r\n                return false\r\n\r\n            @log.info \"Sending shutdown to worker #{id}\"\r\n            @workers[id].rpc.request \"shutdown\", {}, (err) =>\r\n                if err\r\n                    @log.error \"Shutdown errored: #{err}\"\r\n                    return false\r\n\r\n                cb = _.once cb\r\n\r\n                # set a shutdown timer\r\n                timer = setTimeout =>\r\n                    @log.error \"Failed to get worker exit before timeout. Trying kill.\"\r\n                    w.w.kill()\r\n\r\n                    timer = setTimeout =>\r\n                        cb \"Failed to shut down worker.\"\r\n                    , 500\r\n\r\n                , 1000\r\n\r\n                # now watch for the worker's exit event\r\n                @workers[id].once \"exit\", =>\r\n                    @log.info \"Shutdown succeeded for worker #{id}.\"\r\n                    clearTimeout timer if timer\r\n                    cb null\r\n\r\n        #----------\r\n\r\n        getWorker: (exclude_id) ->\r\n            # we want loaded workers, excluding the passed-in id if provided\r\n            workers = if exclude_id\r\n                _(@workers).select (w) -> w._loaded && w.id != exclude_id\r\n            else\r\n                _(@workers).select (w) -> w._loaded\r\n\r\n            if workers.length == 0\r\n                return null\r\n            else\r\n                # From this pool of eligible workers, choose the one that seems\r\n                # most appropriate to get new traffic.\r\n\r\n                # FIXME: How about the one that has sent the least bytes?\r\n                #return _.min workers, (w) -> w.status.bytes_sent\r\n\r\n                return _.sample(workers)\r\n\r\n        #----------\r\n\r\n        status: (cb) ->\r\n            status = {}\r\n\r\n            af = _.after Object.keys(@workers).length, =>\r\n                cb null, status\r\n\r\n            for id,w of @workers\r\n                do (id,w) =>\r\n                    w.rpc.request \"status\", (err,s) =>\r\n                        @log.error \"Worker status error: #{err}\" if err\r\n                        status[ id ] = id:id, listening:w._listening, loaded:w._loaded, streams:s, pid:w.pid\r\n                        af()\r\n\r\n    #----------\r\n\r\n    class @Worker extends require(\"events\").EventEmitter\r\n        constructor: (attributes) ->\r\n            super()\r\n\r\n            @[k] = v for k,v of attributes\r\n\r\n        destroy: ->\r\n            @removeAllListeners()\r\n"
  ]
}