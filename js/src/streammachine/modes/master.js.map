{
  "version": 3,
  "file": "master.js",
  "sourceRoot": "../../../../src/streammachine/modes/",
  "sources": [
    "master.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,MAAA,EAAA,MAAA,EAAA,UAAA,EAAA,GAAA,EAAA,CAAA,EAAA,KAAA,EAAA,OAAA,EAAA;;AAAA,CAAA,GAAU,OAAA,CAAQ,YAAR;;AACV,OAAA,GAAU,OAAA,CAAQ,SAAR;;AACV,KAAA,GAAU,OAAA,CAAQ,OAAR;;AACV,GAAA,GAAU,OAAA,CAAQ,SAAR;;AACV,MAAA,GAAU,OAAA,CAAQ,WAAR;;AACV,MAAA,GAAU,OAAA,CAAQ,WAAR;;AAEV,KAAA,GAAQ,OAAA,CAAQ,OAAR,CAAA,CAAiB,iBAAjB,EAPR;;;;;;;AAeA,MAAM,CAAC,OAAP,GAAuB;EAAN,MAAA,WAAA,QAAyB,OAAA,CAAQ,aAAR,EAAzB;IAIb,WAAa,CAAC,MAAD,EAAS,EAAT,CAAA;WACT,CAAM,MAAN;MAEA,OAAO,CAAC,KAAR,GAAgB;MAChB,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,sBAAd,EAHR;;MAOQ,IAAC,CAAA,MAAD,GAAU,IAAI,MAAJ,CAAW,IAAC,CAAA,GAAZ,EAPlB;;MAUQ,IAAC,CAAA,MAAD,GAAU,OAAA,CAAA;MACV,IAAC,CAAA,MAAM,CAAC,GAAR,CAAY,IAAZ,EAAoB,IAAC,CAAA,MAAM,CAAC,SAAS,CAAC,GAAtC;MACA,IAAC,CAAA,MAAM,CAAC,GAAR,CAAY,MAAZ,EAAoB,IAAC,CAAA,MAAM,CAAC,GAAG,CAAC,GAAhC;MAEA,IAAG,oBAAH;QACI,IAAC,CAAA,IAAD,GAAQ,IAAI,GAAJ,CAAQ,OAAR,EAAiB;UAAA,SAAA,EACrB;YAAA,EAAA,EAAI,QAAA,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA;qBACA,EAAA,CAAG,IAAH,EAAS,IAAT;YADA,CAAJ;YAGA,WAAA,EAAa,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA,GAAA;AAC7B,kBAAA;qBAAoB,EAAA,CAAG,IAAH,oCAAgB,CAAE,OAAT,CAAA,CAAkB,CAAC,cAAnB,IAAyB,MAAlC;YADS,CAHb;YAMA,WAAA,EAAa,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA,GAAA;AAC7B,kBAAA,GAAA,EAAA;qBAAoB,EAAA,CAAG,IAAH,sFAA2C,CAAE,uBAApC,IAA0C,MAAnD;YADS,CANb;YASA,MAAA,EAAQ,CAAC,MAAD,EAAQ,MAAR,EAAe,EAAf,CAAA,GAAA;qBACJ,IAAC,CAAA,MAAM,CAAC,SAAR,CAAkB,MAAlB,EAA0B,CAAC,GAAD,CAAA,GAAA;uBACtB,EAAA,CAAG,GAAH,EAAQ,IAAC,CAAA,MAAM,CAAC,MAAR,CAAA,CAAR;cADsB,CAA1B;YADI;UATR;QADqB,CAAjB,EADZ;OAdR;;;;MAiCQ,IAAG,KAAK,CAAC,GAAN,CAAU,SAAV,CAAH;QACI,IAAC,CAAA,aAAD,CAAe,EAAf,EADJ;OAAA,MAAA;QAGI,IAAC,CAAA,YAAD,CAAc,EAAd,EAHJ;;IAlCS,CAFjB;;;IA2CI,aAAe,CAAC,EAAD,CAAA;aACX,IAAC,CAAA,cAAD,CAAgB,CAAC,GAAD,CAAA,GAAA;QACZ,IAAG,GAAH;UACI,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,oDAAA,CAAA,CAAuD,GAAvD,CAAA,CAAd;iBACA,IAAC,CAAA,YAAD,CAAc,EAAd,EAFJ;;MADY,CAAhB;IADW,CA3CnB;;;IAmDI,YAAc,CAAC,EAAD,CAAA,EAAA;;MAEV,IAAC,CAAA,MAAM,CAAC,WAAR,CAAA;MAEA,IAAC,CAAA,MAAD,GAAU,IAAC,CAAA,MAAM,CAAC,MAAR,CAAe,IAAC,CAAA,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,IAAlC;MACV,IAAC,CAAA,MAAM,CAAC,MAAM,CAAC,MAAf,CAAsB,IAAC,CAAA,MAAvB;MACA,IAAC,CAAA,MAAM,CAAC,QAAQ,CAAC,MAAjB,CAAA;MAEA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,YAAb;wCAEA,GAAI,MAAM;IAVA,CAnDlB;;;IAiEI,YAAc,CAAC,GAAD,CAAA;MACV,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,sCAAb;MAEA,KAAA,CAAM,sCAAN;aAEA,GAAG,CAAC,IAAJ,CAAS,YAAT,EAAuB,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA,GAAA;QACnB,KAAA,CAAM,0DAAN,EAAZ;;eAGY,GAAG,CAAC,OAAJ,CAAY,QAAZ,EAAsB,IAAC,CAAA,MAAM,CAAC,MAAR,CAAA,CAAtB,EAAwC,CAAC,GAAD,EAAK,OAAL,CAAA,GAAA;UACpC,IAAG,GAAH;YACI,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,qCAAA,CAAA,CAAwC,GAAxC,CAAA,CAAd;YACA,EAAA,CAAG,CAAA,sBAAA,CAAA,CAAyB,GAAzB,CAAA,CAAH;AACA,mBAAO,MAHX;;UAKA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,qCAAb;UACA,KAAA,CAAM,qCAAN,EANhB;;UASgB,EAAA,CAAA,EAThB;;UAYgB,KAAA,CAAM,yBAAN;iBACA,IAAC,CAAA,MAAM,CAAC,eAAR,CAAwB,GAAxB,EAA6B,CAAC,GAAD,CAAA,GAAA;AAC7C,gBAAA;YAAoB,KAAA,CAAM,kDAAN;YAEA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,kCAAb;YAEA,aAAA,GAAgB,CAAC,CAAC,KAAF,CAAQ,CAAR,EAAW,CAAA,CAAA,GAAA;cACvB,KAAA,CAAM,0BAAN;cACA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,gCAAb;qBACA,OAAO,CAAC,IAAR,CAAA;YAHuB,CAAX,EAJpC;;YAUoB,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,yBAAb;YACA,GAAG,CAAC,OAAJ,CAAY,eAAZ,EAA6B,IAA7B,EAAmC,IAAC,CAAA,MAAM,CAAC,QAAQ,CAAC,MAApD,EAA4D,CAAC,GAAD,CAAA,GAAA;cACxD,IAAuD,GAAvD;gBAAA,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,6BAAA,CAAA,CAAgC,GAAhC,CAAA,CAAd,EAAA;;qBACA,aAAA,CAAA;YAFwD,CAA5D;YAIA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,yBAAb;mBACA,GAAG,CAAC,OAAJ,CAAY,eAAZ,EAA6B,IAA7B,EAAmC,IAAC,CAAA,MAApC,EAA4C,CAAC,GAAD,CAAA,GAAA;cACxC,IAAuD,GAAvD;gBAAA,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,6BAAA,CAAA,CAAgC,GAAhC,CAAA,CAAd,EAAA;;qBACA,aAAA,CAAA;YAFwC,CAA5C;UAjByB,CAA7B;QAdoC,CAAxC;MAJmB,CAAvB;IALU,CAjElB;;;IA+GI,cAAgB,CAAC,EAAD,CAAA;AACpB,UAAA;MAAQ,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,gCAAb;MAEA,KAAA,CAAM,mBAAN;MAEA,IAAG,CAAC,IAAC,CAAA,IAAL;QACI,EAAA,CAAG,IAAI,KAAJ,CAAU,8CAAV,CAAH;AACA,eAAO,MAFX;OAJR;;;;MAWQ,aAAA,GAAgB,UAAA,CAAW,CAAA,CAAA,GAAA;QACvB,KAAA,CAAM,4CAAN;eACA,EAAA,CAAG,IAAI,KAAJ,CAAU,kDAAV,CAAH;MAFuB,CAAX,EAGd,IAHc;MAKhB,KAAA,CAAM,wBAAN;aACA,IAAC,CAAA,IAAI,CAAC,IAAN,CAAW,YAAX,EAAyB,CAAC,GAAD,EAAK,MAAL,EAAY,GAAZ,CAAA,GAAA;QACrB,YAAA,CAAa,aAAb;QAEA,KAAA,CAAM,sBAAN;QAEA,GAAA,CAAI,IAAJ,EAAU,IAAV,EAJZ;;QAOY,KAAA,CAAM,4CAAN;eACA,IAAC,CAAA,MAAM,CAAC,eAAR,CAAwB,CAAA,CAAA,GAAA,EAAA;;UAEpB,KAAA,CAAM,+CAAN;iBACA,IAAC,CAAA,IAAI,CAAC,OAAN,CAAc,YAAd,EAA4B,IAAC,CAAA,MAAM,CAAC,MAAR,CAAA,CAA5B,EAA8C,CAAC,GAAD,EAAK,KAAL,CAAA,GAAA;AAC9D,gBAAA;YAAoB,IAAG,GAAH;cACI,IAAC,CAAA,MAAM,CAAC,KAAR,CAAc,CAAA,uDAAA,CAAA,CAA0D,GAA1D,CAAA,CAAd;AACA,qBAAO,MAFX;;YAIA,KAAA,CAAM,8BAAN;YAEA,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,+CAAb;YAEA,IAAC,CAAA,MAAM,CAAC,eAAR,CAAwB,IAAC,CAAA,IAAzB,EAA+B,CAAA,CAAA,GAAA;qBAC3B,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,mEAAb;YAD2B,CAA/B;YAGA,KAAA,GAAQ,CAAC,CAAC,KAAF,CAAQ,CAAR,EAAW,CAAA,CAAA,GAAA;cACf,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,mCAAb;gDACA,GAAI,MAAM;YAFK,CAAX;YAIR,IAAC,CAAA,IAAI,CAAC,IAAN,CAAW,eAAX,EAA4B,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA,GAAA;cACxB,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,4BAAb;cACA,IAAC,CAAA,MAAM,CAAC,QAAQ,CAAC,MAAjB,CAAwB,MAAxB;cACA,EAAA,CAAG,IAAH;qBACA,KAAA,CAAA;YAJwB,CAA5B;mBAMA,IAAC,CAAA,IAAI,CAAC,IAAN,CAAW,eAAX,EAA4B,CAAC,GAAD,EAAK,MAAL,EAAY,EAAZ,CAAA,GAAA;AAChD,kBAAA;cAAwB,IAAC,CAAA,MAAM,CAAC,IAAR,CAAa,4BAAb;cACA,IAAC,CAAA,MAAD,GAAU,IAAC,CAAA,MAAM,CAAC,MAAR,CAAe,MAAf;;mBACI,CAAE,MAAhB,CAAuB,IAAC,CAAA,MAAxB;;cACA,EAAA,CAAG,IAAH;qBACA,KAAA,CAAA;YALwB,CAA5B;UAtB0C,CAA9C;QAHoB,CAAxB;MATqB,CAAzB;IAlBY;;EAjHH;;uBAEb,IAAA,GAAM;;;;;;AAjBV",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nexpress = require \"express\"\r\nnconf   = require \"nconf\"\r\nRPC     = require \"ipc-rpc\"\r\nLogger  = require \"../logger\"\r\nMaster  = require \"../master\"\r\n\r\ndebug = require(\"debug\")(\"sm:modes:master\")\r\n\r\n# Master Server\r\n#\r\n# Masters don't take client connections directly. They take incoming\r\n# source streams and proxy them to the slaves, providing an admin\r\n# interface and a point to consolidate logs and listener counts.\r\n\r\nmodule.exports = class MasterMode extends require(\"./base_mode\")\r\n\r\n    MODE: \"Master\"\r\n\r\n    constructor: (config, cb) ->\r\n        super(config)\r\n\r\n        process.title = \"SM:MASTER\"\r\n        @logger.debug \"Master mode starting\"\r\n\r\n\r\n        # create a master\r\n        @master = new Master(@ctx)\r\n\r\n        # Set up a server for our admin\r\n        @server = express()\r\n        @server.use \"/s\",   @master.transport.app\r\n        @server.use \"/api\", @master.api.app\r\n\r\n        if process.send?\r\n            @_rpc = new RPC process, functions:\r\n                OK: (msg,handle,cb) ->\r\n                    cb null, \"OK\"\r\n\r\n                master_port: (msg,handle,cb) =>\r\n                    cb null, @handle?.address().port||\"NONE\"\r\n\r\n                source_port: (msg,handle,cb) =>\r\n                    cb null, @master.sourcein?.server.address()?.port||\"NONE\"\r\n\r\n                config: (config,handle,cb) =>\r\n                    @master.configure config, (err) =>\r\n                        cb err, @master.config()\r\n\r\n                #start_handoff: (msg,handle,cb) =>\r\n                #    @_sendHandoff()\r\n                #    cb null, \"OK\"\r\n\r\n        if nconf.get(\"handoff\")\r\n            @_handoffStart cb\r\n        else\r\n            @_normalStart cb\r\n\r\n    #----------\r\n\r\n    _handoffStart: (cb) ->\r\n        @_acceptHandoff (err) =>\r\n            if err\r\n                @logger.error \"_handoffStart Failed! Falling back to normal start: #{err}\"\r\n                @_normalStart cb\r\n\r\n    #----------\r\n\r\n    _normalStart: (cb) ->\r\n        # load any rewind buffers from disk\r\n        @master.loadRewinds()\r\n\r\n        @handle = @server.listen @ctx.config.master.port\r\n        @master.slaves.listen(@handle)\r\n        @master.sourcein.listen()\r\n\r\n        @logger.info \"Listening.\"\r\n\r\n        cb? null, @\r\n\r\n    #----------\r\n\r\n    _sendHandoff: (rpc) ->\r\n        @logger.info \"Got handoff signal from new process.\"\r\n\r\n        debug \"In _sendHandoff. Waiting for config.\"\r\n\r\n        rpc.once \"configured\", (msg,handle,cb) =>\r\n            debug \"Handoff recipient is configured. Syncing running config.\"\r\n\r\n            # send stream/source info so we make sure our configs are matched\r\n            rpc.request \"config\", @master.config(), (err,streams) =>\r\n                if err\r\n                    @logger.error \"Error setting config on new process: #{err}\"\r\n                    cb \"Error sending config: #{err}\"\r\n                    return false\r\n\r\n                @logger.info \"New Master confirmed configuration.\"\r\n                debug \"New master confirmed configuration.\"\r\n\r\n                # basically we leave the config request open while we send streams\r\n                cb()\r\n\r\n                # Send master data (includes source port handoff)\r\n                debug \"Calling sendHandoffData\"\r\n                @master.sendHandoffData rpc, (err) =>\r\n                    debug \"Back in _sendHandoff. Sending listening sockets.\"\r\n\r\n                    @logger.info \"Sent master data to new process.\"\r\n\r\n                    _afterSockets = _.after 2, =>\r\n                        debug \"Socket transfer is done.\"\r\n                        @logger.info \"Sockets transferred.  Exiting.\"\r\n                        process.exit()\r\n\r\n                    # Hand over the source port\r\n                    @logger.info \"Hand off source socket.\"\r\n                    rpc.request \"source_socket\", null, @master.sourcein.server, (err) =>\r\n                        @logger.error \"Error sending source socket: #{err}\" if err\r\n                        _afterSockets()\r\n\r\n                    @logger.info \"Hand off master socket.\"\r\n                    rpc.request \"master_handle\", null, @handle, (err) =>\r\n                        @logger.error \"Error sending master handle: #{err}\" if err\r\n                        _afterSockets()\r\n\r\n    #----------\r\n\r\n    _acceptHandoff: (cb) ->\r\n        @logger.info \"Initializing handoff receptor.\"\r\n\r\n        debug \"In _acceptHandoff\"\r\n\r\n        if !@_rpc\r\n            cb new Error \"Handoff called, but no RPC interface set up.\"\r\n            return false\r\n\r\n        # If we don't get HANDOFF_GO quickly, something is probably wrong.\r\n        # Perhaps we've been asked to start via handoff when there's no process\r\n        # out there to send us data.\r\n        handoff_timer = setTimeout =>\r\n            debug \"Handoff failed to handshake. Done waiting.\"\r\n            cb new Error \"Handoff failed to handshake within five seconds.\"\r\n        , 5000\r\n\r\n        debug \"Waiting for HANDOFF_GO\"\r\n        @_rpc.once \"HANDOFF_GO\", (msg,handle,ccb) =>\r\n            clearTimeout handoff_timer\r\n\r\n            debug \"HANDOFF_GO received.\"\r\n\r\n            ccb null, \"GO\"\r\n\r\n            # watch for streams\r\n            debug \"Waiting for internal configuration signal.\"\r\n            @master.once_configured =>\r\n                # signal that we're ready\r\n                debug \"Telling handoff sender that we're configured.\"\r\n                @_rpc.request \"configured\", @master.config(), (err,reply) =>\r\n                    if err\r\n                        @logger.error \"Failed to send config broadcast when starting handoff: #{err}\"\r\n                        return false\r\n\r\n                    debug \"Handoff sender ACKed config.\"\r\n\r\n                    @logger.info \"Handoff initiator ACKed our config broadcast.\"\r\n\r\n                    @master.loadHandoffData @_rpc, =>\r\n                        @logger.info \"Handoff receiver believes all stream and source data has arrived.\"\r\n\r\n                    aFunc = _.after 2, =>\r\n                        @logger.info \"Source and Master handles are up.\"\r\n                        cb? null, @\r\n\r\n                    @_rpc.once \"source_socket\", (msg,handle,cb) =>\r\n                        @logger.info \"Source socket is incoming.\"\r\n                        @master.sourcein.listen handle\r\n                        cb null\r\n                        aFunc()\r\n\r\n                    @_rpc.once \"master_handle\", (msg,handle,cb) =>\r\n                        @logger.info \"Master socket is incoming.\"\r\n                        @handle = @server.listen handle\r\n                        @master.slaves?.listen @handle\r\n                        cb null\r\n                        aFunc()\r\n\r\n    #----------\r\n"
  ]
}