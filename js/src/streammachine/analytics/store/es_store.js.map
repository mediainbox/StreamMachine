{
  "version": 3,
  "file": "es_store.js",
  "sourceRoot": "../../../../../src/streammachine/analytics/store/",
  "sources": [
    "es_store.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\r\nelasticsearch = require \"@elastic/elasticsearch\"\r\n\r\nBatchedQueue    = require \"../util/batched_queue\"\r\nEsIndexWriter   = require \"./store/idx_writer\"\r\nESTemplates     = require \"./store/es_templates\"\r\n\r\nmodule.exports = class AnalyticsEsStore\r\n    constructor: (@opts,cb) ->\r\n        @_uri = URL.parse @opts.config.es_uri\r\n\r\n        @log = @opts.log\r\n\r\n        @_timeout_sec = Number(@opts.config.finalize_secs)\r\n\r\n        if @opts.redis\r\n\r\n            @redis = @opts.redis.client\r\n\r\n        es_uri = @opts.config.es_uri\r\n        @idx_prefix = @opts.config.es_prefix\r\n\r\n        @log.debug \"Connecting to Elasticsearch at #{es_uri} with prefix of #{@idx_prefix}\"\r\n        debug \"Connecting to ES at #{es_uri}, prefix #{@idx_prefix}\"\r\n\r\n        apiVersion = '1.7'\r\n        if (typeof @opts.config.es_api_version != 'undefined')\r\n            apiVersion = @opts.config.es_api_version.toString()\r\n\r\n        @es = new elasticsearch.Client\r\n            node:           es_uri\r\n            apiVersion:     apiVersion\r\n            requestTimeout: @opts.config.request_timeout || 30000\r\n\r\n        @idx_batch  = new BatchedQueue\r\n            batch:      @opts.config.index_batch\r\n            latency:    @opts.config.index_latency\r\n\r\n        @idx_writer = new EsIndexWriter @es, @log.child(submodule:\"idx_writer\")\r\n        @idx_writer.on \"error\", (err) =>\r\n            @log.error err\r\n\r\n        @idx_batch.pipe(@idx_writer)\r\n\r\n        # track open sessions\r\n        @sessions = {}\r\n\r\n        @local = tz(require \"timezone/zones\")(nconf.get(\"timezone\")||\"UTC\")\r\n\r\n        # -- Load our Templates -- #\r\n\r\n        @_loadTemplates (err) =>\r\n            if err\r\n                console.error err\r\n                cb? err\r\n            else\r\n    # do something...\r\n                debug \"Hitting cb after loading templates\"\r\n                cb? null, @\r\n\r\n    #----------\r\n\r\n    _storeSession: (session,cb) ->\r\n# write one index per day of data\r\n        index_date = tz(session.time,\"%F\")\r\n        @es.index index:\"#{@idx_prefix}-sessions-#{index_date}\", type: '_doc', body:session, (err) =>\r\n            return cb new Error \"Error creating index #{@idx_prefix}-sessions-#{index_date} #{err}\" if err\r\n\r\n#----------\r\n\r\n    _selectSessionStart: (id,cb) ->\r\n# -- Look up user information from session_start -- #\r\n\r\n        body =\r\n            query:\r\n                bool:\r\n                    must: [\r\n                        {\r\n                            match:\r\n                                \"session_id\": id\r\n                        },\r\n                        {\r\n                            match:\r\n                                \"type\": \"start\"\r\n                        }\r\n                    ]\r\n            sort:\r\n                time:{order:\"desc\"}\r\n            size: 1\r\n\r\n        # session start is allowed to be anywhere in the last 24 hours\r\n        @_indicesForTimeRange \"listens\", new Date(), \"-72 hours\", (err,indices) =>\r\n            @es.search body:body, index:indices, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying session start for #{id}: #{err}\" if err\r\n\r\n                if res.body.hits && res.body.hits.total.value > 0\r\n                    cb null, _.extend {}, res.body.hits.hits[0]._source, time:new Date(res.body.hits.hits[0]._source.time)\r\n\r\n#----------\r\n\r\n    _selectPreviousSession: (sessionId, cb) ->\r\n    # -- Have we ever finalized this session id? -- #\r\n\r\n        body =\r\n            query:\r\n                bool:\r\n                    must: [\r\n                        {\r\n                            match:\r\n                                \"session_id\": sessionId\r\n                        },\r\n                        {\r\n                            match:\r\n                                \"type\": \"session\"\r\n                        }\r\n                    ]\r\n            sort:\r\n                time: {order:\"desc\"}\r\n            size:1\r\n\r\n\r\n        @_indicesForTimeRange \"sessions\", new Date(), \"-72 hours\", (err,indices) =>\r\n            @es.search body:body, index:indices, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying for old session #{id}: #{err}\" if err\r\n\r\n                if !res.body.hits || res.body.hits.total.value == 0\r\n                    cb null, null\r\n                else\r\n                    cb null, new Date(res.body.hits.hits[0]._source.time)\r\n\r\n\r\n\r\n#----------\r\n\r\n    _selectListenTotals: (id,ts,cb) ->\r\n# -- Query total duration and kbytes sent -- #\r\n\r\n        filter =\r\n            if ts\r\n                \"and\":\r\n                    filters:[\r\n                        { range:{ time:{ gt:ts } } },\r\n                        { term:{session_id:id} },\r\n                        { term:{type:\"listen\"}}\r\n                    ]\r\n            else\r\n                term:{session_id:id}\r\n\r\n        body =\r\n            query:\r\n                constant_score:\r\n                    filter:filter\r\n            aggs:\r\n                duration:\r\n                    sum:{ field:\"duration\" }\r\n                kbytes:\r\n                    sum:{ field:\"kbytes\" }\r\n                last_listen:\r\n                    max:{ field:\"time\" }\r\n\r\n        @_indicesForTimeRange \"listens\", new Date(), ts||\"-72 hours\", (err,indices) =>\r\n            @es.search index:indices, body:body, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying listens to finalize session #{id}: #{err}\" if err\r\n\r\n                if res.body.hits.total.value > 0\r\n                    cb null,\r\n                        requests:       res.body.hits.total.value\r\n                        duration:       res.body.aggregations.duration.value\r\n                        kbytes:         res.body.aggregations.kbytes.value\r\n                        last_listen:    new Date(res.body.aggregations.last_listen.value)\r\n                else\r\n                    cb null, null\r\n\r\n\r\n#----------\r\n\r\n    countListeners: (cb) ->\r\n# -- Query recent listeners -- #\r\n\r\n        body =\r\n            query:\r\n                constant_score:\r\n                    filter:\r\n                        range:\r\n                            time:\r\n                                gt:\"now-15m\"\r\n            size:0\r\n            aggs:\r\n                listeners_by_minute:\r\n                    date_histogram:\r\n                        field:      \"time\"\r\n                        fixed_interval:   \"1m\"\r\n                    aggs:\r\n                        duration:\r\n                            sum:{ field:\"duration\" }\r\n                        sessions:\r\n                            cardinality:{ field:\"session_id\" }\r\n                        streams:\r\n                            terms:{ field:\"stream\", size:50 }\r\n\r\n        @_indicesForTimeRange \"listens\", new Date(), \"-15 minutes\", (err,indices) =>\r\n            @es.search index:indices, body:body, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Failed to query listeners: #{err}\" if err\r\n\r\n                times = []\r\n\r\n                if !res.body.aggregations\r\n                    cb null, times\r\n                    return\r\n\r\n                for obj in res.body.aggregations.listeners_by_minute.buckets\r\n                    streams = {}\r\n                    for sobj in obj.streams.buckets\r\n                        streams[ sobj.key ] = sobj.doc_count\r\n\r\n                    times.unshift\r\n                        time:               @local(new Date(obj.key),\"%F %T%^z\")\r\n                        requests:           obj.doc_count\r\n                        avg_listeners:      Math.round( obj.duration.value / 60 )\r\n                        sessions:           obj.sessions.value\r\n                        requests_by_stream: streams\r\n\r\n                cb null, times\r\n\r\n    #----------\r\n\r\n\r\n    _indicesForTimeRange: (idx, start, end, cb) ->\r\n        if _.isFunction(end)\r\n            cb = end\r\n            end = null\r\n\r\n        start = @local(start)\r\n\r\n        if _.isString(end) && end[0] == \"-\"\r\n            end = @local(start,end)\r\n\r\n        indices = []\r\n        if end\r\n            end = @local(end)\r\n\r\n            s = start\r\n            while true\r\n                s = @local(s,\"-1 day\")\r\n                break if s < end\r\n                indices.push \"#{@idx_prefix}-#{idx}-#{ @local(s,\"%F\") }\"\r\n\r\n        indices.unshift \"#{@idx_prefix}-#{idx}-#{ @local(start,\"%F\") }\"\r\n        cb null, _.uniq(indices)\r\n\r\n\r\n    #----------\r\n\r\n\r\n    _loadTemplates: (cb) ->\r\n        errors = []\r\n\r\n        debug \"Loading #{Object.keys(ESTemplates).length} ElasticSearch templates\"\r\n\r\n        _loaded = _.after Object.keys(ESTemplates).length, =>\r\n            if errors.length > 0\r\n                debug \"Failed to load one or more ElasticSearch templates: #{errors.join(\" | \")}\"\r\n                @log.info errors\r\n                cb new Error \"Failed to load index templates: #{ errors.join(\" | \") }\"\r\n            else\r\n                debug \"ES templates loaded successfully.\"\r\n                cb null\r\n\r\n        for t,obj of ESTemplates\r\n            debug \"Loading ElasticSearch mapping for #{@idx_prefix}-#{t}\"\r\n            #@log.info \"Loading Elasticsearch mappings for #{@idx_prefix}-#{t}\"\r\n            tmplt = _.extend {}, obj, index_patterns:\"#{@idx_prefix}-#{t}-*\"\r\n            #@log.info tmplt\r\n            @es.indices.putTemplate name:\"#{@idx_prefix}-#{t}-template\", body:tmplt, (err) =>\r\n                errors.push err if err\r\n                _loaded()\r\n"
  ]
}