{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "../../../../src/streammachine/analytics/",
  "sources": [
    "index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nURL     = require \"url\"\r\nwinston = require \"winston\"\r\ntz      = require \"timezone\"\r\nnconf   = require \"nconf\"\r\nelasticsearch = require \"@elastic/elasticsearch\"\r\n\r\nBatchedQueue    = require \"../util/batched_queue\"\r\nIdxWriter       = require \"./idx_writer\"\r\nESTemplates     = require \"./es_templates\"\r\n\r\ndebug = require(\"debug\")(\"sm:analytics\")\r\n\r\n# This module is responsible for:\r\n\r\n# * Listen for session_start and listen interactions\r\n# * Watch for sessions that are no longer active.  Finalize them, attaching\r\n#   stats and duration, and throwing out sessions that did not meet minimum\r\n#   requirements\r\n# * Answer questions about current number of listeners at any given time\r\n# * Produce old-style w3c output for listener stats\r\n\r\nmodule.exports = class Analytics\r\n    constructor: (@opts,cb) ->\r\n        @_uri = URL.parse @opts.config.es_uri\r\n\r\n        @log = @opts.log\r\n\r\n        @_timeout_sec = Number(@opts.config.finalize_secs)\r\n\r\n        if @opts.redis\r\n\r\n            @redis = @opts.redis.client\r\n\r\n        es_uri = @opts.config.es_uri\r\n        @idx_prefix = @opts.config.es_prefix\r\n\r\n        @log.debug \"Connecting to Elasticsearch at #{es_uri} with prefix of #{@idx_prefix}\"\r\n        debug \"Connecting to ES at #{es_uri}, prefix #{@idx_prefix}\"\r\n\r\n        apiVersion = '1.7'\r\n        if (typeof @opts.config.es_api_version != 'undefined')\r\n            apiVersion = @opts.config.es_api_version.toString()\r\n\r\n        @es = new elasticsearch.Client\r\n            node:           es_uri\r\n            apiVersion:     apiVersion\r\n            requestTimeout: @opts.config.request_timeout || 30000\r\n\r\n        @idx_batch  = new BatchedQueue\r\n            batch:      @opts.config.index_batch\r\n            latency:    @opts.config.index_latency\r\n\r\n        @idx_writer = new IdxWriter @es, @log.child(submodule:\"idx_writer\")\r\n        @idx_writer.on \"error\", (err) =>\r\n            @log.error err\r\n\r\n        @idx_batch.pipe(@idx_writer)\r\n\r\n        # track open sessions\r\n        @sessions = {}\r\n\r\n        @local = tz(require \"timezone/zones\")(nconf.get(\"timezone\")||\"UTC\")\r\n\r\n        # -- Load our Templates -- #\r\n\r\n        @_loadTemplates (err) =>\r\n            if err\r\n                console.error err\r\n                cb? err\r\n            else\r\n                # do something...\r\n                debug \"Hitting cb after loading templates\"\r\n                cb? null, @\r\n\r\n        # -- are there any sessions that should be finalized? -- #\r\n\r\n        # when was our last finalized session?\r\n        #last_session = @influx.query \"SELECT max(time) from sessions\", (err,res) =>\r\n        #    console.log \"last session is \", err, res\r\n\r\n        # what sessions have we seen since then?\r\n\r\n        # -- Redis Session Sweep -- #\r\n\r\n        if @redis\r\n            @log.info \"Analytics setting up Redis session sweeper\"\r\n\r\n            setInterval =>\r\n                # look for sessions that should be written (score less than now)\r\n                @redis.zrangebyscore \"session-timeouts\", 0, Math.floor( Number(new Date) / 1000), (err,sessions) =>\r\n                    return @log.error \"Error fetching sessions to finalize: #{err}\" if err\r\n\r\n                    _sFunc = =>\r\n                        if s = sessions.shift()\r\n                            @_triggerSession s\r\n                            _sFunc()\r\n\r\n                    _sFunc()\r\n\r\n            , 5*1000\r\n\r\n    #----------\r\n\r\n    _loadTemplates: (cb) ->\r\n        errors = []\r\n\r\n        debug \"Loading #{Object.keys(ESTemplates).length} ES templates\"\r\n\r\n        _loaded = _.after Object.keys(ESTemplates).length, =>\r\n            if errors.length > 0\r\n                debug \"Failed to load one or more ES templates: #{errors.join(\" | \")}\"\r\n                @log.info errors\r\n                cb new Error \"Failed to load index templates: #{ errors.join(\" | \") }\"\r\n            else\r\n                debug \"ES templates loaded successfully.\"\r\n                cb null\r\n\r\n        for t,obj of ESTemplates\r\n            debug \"Loading ES mapping for #{@idx_prefix}-#{t}\"\r\n            @log.info \"Loading Elasticsearch mappings for #{@idx_prefix}-#{t}\"\r\n            tmplt = _.extend {}, obj, index_patterns:\"#{@idx_prefix}-#{t}-*\"\r\n            @log.info tmplt\r\n            @es.indices.putTemplate name:\"#{@idx_prefix}-#{t}-template\", body:tmplt, (err) =>\r\n                errors.push err if err\r\n                _loaded()\r\n\r\n    #----------\r\n\r\n    #----------\r\n\r\n    _log: (obj,cb) ->\r\n        session_id = null\r\n\r\n        if !obj.client?.session_id\r\n            cb? new Error \"Object does not contain a session ID\"\r\n            return false\r\n\r\n        # write one index per day of data\r\n        index_date = tz(obj.time,\"%F\")\r\n\r\n        time = new Date( obj.time )\r\n\r\n        # clean up IPv4 IP addresses stuck in IPv6\r\n        if obj.client?.ip\r\n            obj.client.ip = obj.client.ip.replace /^::ffff:/, \"\"\r\n\r\n        @_indicesForTimeRange \"listens\", time, (err,idx) =>\r\n            switch obj.type\r\n                when \"session_start\"\r\n                    @idx_batch.write index:idx[0], body:\r\n                        time:       new Date(obj.time)\r\n                        session_id: obj.client.session_id\r\n                        stream:     obj.stream_group || obj.stream\r\n                        client:     obj.client\r\n                        type:       \"start\"\r\n\r\n                    cb? null\r\n\r\n                    # -- start tracking the session -- #\r\n\r\n                when \"listen\"\r\n                    # do we know of other duration for this session?\r\n                    @_getStashedDurationFor obj.client.session_id, obj.duration, (err,dur) =>\r\n                        @idx_batch.write index:idx[0], body:\r\n                            session_id:         obj.client.session_id\r\n                            time:               new Date(obj.time)\r\n                            kbytes:             obj.kbytes\r\n                            duration:           obj.duration\r\n                            session_duration:   dur\r\n                            stream:             obj.stream\r\n                            client:             obj.client\r\n                            offsetSeconds:      obj.offsetSeconds\r\n                            contentTime:        obj.contentTime\r\n                            type:               \"listen\"\r\n\r\n                        cb? null\r\n\r\n            # -- update our timer -- #\r\n\r\n            @_updateSessionTimerFor obj.client.session_id, (err) =>\r\n\r\n    #----------\r\n\r\n    # Given a session id and duration, add the given duration to any\r\n    # existing cached duration and return the accumulated number\r\n    _getStashedDurationFor: (session,duration,cb) ->\r\n        if @redis\r\n            # use redis stash\r\n            key = \"duration-#{session}\"\r\n            @redis.incrby key, Math.round(duration), (err,res) =>\r\n                cb err, res\r\n\r\n            # set a TTL on our key, so that it doesn't stay indefinitely\r\n            @redis.pexpire key, 5*60*1000, (err) =>\r\n                @log.error \"Failed to set Redis TTL for #{key}: #{err}\" if err\r\n\r\n        else\r\n            # use memory stash\r\n            s = @_ensureMemorySession session\r\n            s.duration += duration\r\n            cb null, s.duration\r\n\r\n    #----------\r\n\r\n    _updateSessionTimerFor: (session,cb) ->\r\n        if @_timeout_sec <= 0\r\n            # timeouts are disabled\r\n            return cb null\r\n\r\n        if @redis\r\n            # this will set the score, or update it if the session is\r\n            # already in the set\r\n            timeout_at = (Number(new Date) / 1000) + @_timeout_sec\r\n\r\n            @redis.zadd \"session-timeouts\", timeout_at, session, (err) =>\r\n                cb err\r\n\r\n        else\r\n            s = @_ensureMemorySession session\r\n\r\n            clearTimeout s.timeout if s.timeout\r\n\r\n            s.timeout = setTimeout =>\r\n                @_triggerSession session\r\n            , @_timeout_sec * 1000\r\n\r\n            cb null\r\n\r\n    #----------\r\n\r\n    _scrubSessionFor: (session,cb) ->\r\n        if @redis\r\n            @redis.zrem \"session-timeouts\", session, (err) =>\r\n                return cb err if err\r\n\r\n                @redis.del \"duration-#{session}\", (err) =>\r\n                    cb err\r\n\r\n        else\r\n           s = @_ensureMemorySession session\r\n           clearTimeout s.timeout if s.timeout\r\n           delete @sessions[session]\r\n\r\n           cb null\r\n\r\n\r\n    #----------\r\n\r\n    _ensureMemorySession: (session) ->\r\n        @sessions[ session ] ||=\r\n            duration:0, last_seen_at:Number(new Date()), timeout:null\r\n\r\n    #----------\r\n\r\n    _triggerSession: (session) ->\r\n        @_scrubSessionFor session, (err) =>\r\n            return @log.error \"Error cleaning session cache: #{err}\" if err\r\n\r\n            @_finalizeSession session, (err,obj) =>\r\n                return @log.error \"Error assembling session: #{err}\" if err\r\n\r\n                if obj\r\n                    @_storeSession obj, (err) =>\r\n                        @log.error \"Error writing session: #{err}\" if err\r\n\r\n    #----------\r\n\r\n    _finalizeSession: (id,cb) ->\r\n        @log.silly \"Finalizing session for #{ id }\"\r\n\r\n        # This is a little ugly. We need to take several steps:\r\n        # 1) Have we ever finalized this session id?\r\n        # 2) Look up the session_start for the session_id\r\n        # 3) Compute the session's sent kbytes, sent duration, and elapsed duration\r\n        # 4) Write a session object\r\n\r\n        session = {}\r\n\r\n        # -- Get Started -- #\r\n\r\n        @_selectPreviousSession id, (err,ts) =>\r\n            if err\r\n                @log.error err\r\n                return cb? err\r\n\r\n            @_selectSessionStart id, (err,start) =>\r\n                if err\r\n                    @log.error err\r\n                    return cb err\r\n\r\n                if !start\r\n                    @log.debug \"Attempt to finalize invalid session. No start event for #{id}.\"\r\n                    return cb null, false\r\n\r\n                @_selectListenTotals id, ts, (err,totals) =>\r\n                    if err\r\n                        @log.error err\r\n                        return cb? err\r\n\r\n                    if !totals\r\n                        # Session did not have any recorded listen events.  Toss it.\r\n                        return cb null, false\r\n\r\n                    # -- build session -- #\r\n\r\n                    session =\r\n                        session_id: id\r\n                        output:     start.output\r\n                        stream:     start.stream\r\n                        time:       totals.last_listen\r\n                        start_time: ts || start.time\r\n                        client:     start.client\r\n                        kbytes:     totals.kbytes\r\n                        duration:   totals.duration\r\n                        connected:  ( Number(totals.last_listen) - Number(ts||start.time) ) / 1000\r\n\r\n                    cb null, session\r\n\r\n    #----------\r\n\r\n    _storeSession: (session,cb) ->\r\n        # write one index per day of data\r\n        index_date = tz(session.time,\"%F\")\r\n        @es.index index:\"#{@idx_prefix}-sessions-#{index_date}\", type: '_doc', body:session, (err) =>\r\n            return cb new Error \"Error creating index #{@idx_prefix}-sessions-#{index_date} #{err}\" if err\r\n\r\n    #----------\r\n\r\n    _selectSessionStart: (id,cb) ->\r\n        # -- Look up user information from session_start -- #\r\n\r\n        body =\r\n            query:\r\n                bool:\r\n                    must: [\r\n                        {\r\n                            match:\r\n                                \"session_id\": id\r\n                        },\r\n                        {\r\n                            match:\r\n                                \"type\": \"start\"\r\n                        }\r\n                    ]\r\n            sort:\r\n                time:{order:\"desc\"}\r\n            size: 1\r\n\r\n        # session start is allowed to be anywhere in the last 24 hours\r\n        @_indicesForTimeRange \"listens\", new Date(), \"-72 hours\", (err,indices) =>\r\n            @es.search body:body, index:indices, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying session start for #{id}: #{err}\" if err\r\n\r\n                if res.body.hits && res.body.hits.total.value > 0\r\n                    cb null, _.extend {}, res.body.hits.hits[0]._source, time:new Date(res.body.hits.hits[0]._source.time)\r\n    #----------\r\n\r\n    _selectPreviousSession: (id,cb) ->\r\n        # -- Have we ever finalized this session id? -- #\r\n\r\n        body =\r\n            query:\r\n                bool:\r\n                    must: [\r\n                        {\r\n                            match:\r\n                                \"session_id\": id\r\n                        },\r\n                        {\r\n                            match:\r\n                                \"type\": \"session\"\r\n                        }\r\n                    ]\r\n            sort:\r\n                time:{order:\"desc\"}\r\n            size:1\r\n\r\n\r\n        @_indicesForTimeRange \"sessions\", new Date(), \"-72 hours\", (err,indices) =>\r\n            @es.search body:body, index:indices, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying for old session #{id}: #{err}\" if err\r\n\r\n                if !res.body.hits || res.body.hits.total.value == 0\r\n                    cb null, null\r\n                else\r\n                    cb null, new Date(res.body.hits.hits[0]._source.time)\r\n\r\n    #----------\r\n\r\n    _selectListenTotals: (id,ts,cb) ->\r\n        # -- Query total duration and kbytes sent -- #\r\n\r\n        filter =\r\n            if ts\r\n                \"and\":\r\n                    filters:[\r\n                        { range:{ time:{ gt:ts } } },\r\n                        { term:{session_id:id} },\r\n                        { term:{type:\"listen\"}}\r\n                    ]\r\n            else\r\n               term:{session_id:id}\r\n\r\n        body =\r\n            query:\r\n                constant_score:\r\n                    filter:filter\r\n            aggs:\r\n                duration:\r\n                    sum:{ field:\"duration\" }\r\n                kbytes:\r\n                    sum:{ field:\"kbytes\" }\r\n                last_listen:\r\n                    max:{ field:\"time\" }\r\n\r\n        @_indicesForTimeRange \"listens\", new Date(), ts||\"-72 hours\", (err,indices) =>\r\n            @es.search index:indices, body:body, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Error querying listens to finalize session #{id}: #{err}\" if err\r\n\r\n                if res.body.hits.total.value > 0\r\n                    cb null,\r\n                        requests:       res.body.hits.total.value\r\n                        duration:       res.body.aggregations.duration.value\r\n                        kbytes:         res.body.aggregations.kbytes.value\r\n                        last_listen:    new Date(res.body.aggregations.last_listen.value)\r\n                else\r\n                    cb null, null\r\n\r\n    #----------\r\n\r\n    _indicesForTimeRange: (idx,start,end,cb) ->\r\n        if _.isFunction(end)\r\n            cb = end\r\n            end = null\r\n\r\n        start = @local(start)\r\n\r\n        if _.isString(end) && end[0] == \"-\"\r\n            end = @local(start,end)\r\n\r\n        indices = []\r\n        if end\r\n            end = @local(end)\r\n\r\n            s = start\r\n            while true\r\n                s = @local(s,\"-1 day\")\r\n                break if s < end\r\n                indices.push \"#{@idx_prefix}-#{idx}-#{ @local(s,\"%F\") }\"\r\n\r\n        indices.unshift \"#{@idx_prefix}-#{idx}-#{ @local(start,\"%F\") }\"\r\n        cb null, _.uniq(indices)\r\n\r\n    #----------\r\n\r\n    countListeners: (cb) ->\r\n        # -- Query recent listeners -- #\r\n\r\n        body =\r\n            query:\r\n                constant_score:\r\n                    filter:\r\n                        range:\r\n                            time:\r\n                                gt:\"now-15m\"\r\n            size:0\r\n            aggs:\r\n                listeners_by_minute:\r\n                    date_histogram:\r\n                        field:      \"time\"\r\n                        fixed_interval:   \"1m\"\r\n                    aggs:\r\n                        duration:\r\n                            sum:{ field:\"duration\" }\r\n                        sessions:\r\n                            cardinality:{ field:\"session_id\" }\r\n                        streams:\r\n                            terms:{ field:\"stream\", size:50 }\r\n\r\n        @_indicesForTimeRange \"listens\", new Date(), \"-15 minutes\", (err,indices) =>\r\n            @es.search index:indices, body:body, ignoreUnavailable:true, (err,res) =>\r\n                return cb new Error \"Failed to query listeners: #{err}\" if err\r\n\r\n                times = []\r\n\r\n                if !res.body.aggregations\r\n                    cb null, times\r\n                    return\r\n\r\n                for obj in res.body.aggregations.listeners_by_minute.buckets\r\n                    streams = {}\r\n                    for sobj in obj.streams.buckets\r\n                        streams[ sobj.key ] = sobj.doc_count\r\n\r\n                    times.unshift\r\n                        time:               @local(new Date(obj.key),\"%F %T%^z\")\r\n                        requests:           obj.doc_count\r\n                        avg_listeners:      Math.round( obj.duration.value / 60 )\r\n                        sessions:           obj.sessions.value\r\n                        requests_by_stream: streams\r\n\r\n                cb null, times\r\n\r\n    #----------\r\n\r\n    class @LogTransport extends winston.Transport\r\n        name: \"analytics\"\r\n\r\n        constructor: (@a) ->\r\n            super level:\"interaction\"\r\n\r\n        log: (level,msg,meta,cb) ->\r\n            if level == \"interaction\"\r\n                @a._log meta\r\n                cb?()\r\n\r\n    #----------\r\n"
  ]
}