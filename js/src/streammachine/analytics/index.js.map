{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "../../../../src/streammachine/analytics/",
  "sources": [
    "index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nURL     = require \"url\"\r\nwinston = require \"winston\"\r\ntz      = require \"timezone\"\r\nnconf   = require \"nconf\"\r\n\r\ndebug = require(\"debug\")(\"sm:analytics\")\r\n\r\n# This module is responsible for:\r\n\r\n# * Listen for session_start and listen interactions\r\n# * Watch for sessions that are no longer active.  Finalize them, attaching\r\n#   stats and duration, and throwing out sessions that did not meet minimum\r\n#   requirements\r\n# * Answer questions about current number of listeners at any given time\r\n\r\nmodule.exports = class Analytics\r\n    constructor: (@opts,cb) ->\r\n        @log = @opts.log\r\n\r\n        @_timeout_sec = Number(@opts.config.finalize_secs)\r\n\r\n        if @opts.redis\r\n            @redis = @opts.redis.client\r\n\r\n        # track open sessions\r\n        @sessions = {}\r\n\r\n        @local = tz(require \"timezone/zones\")(nconf.get(\"timezone\")||\"UTC\")\r\n\r\n\r\n        # -- are there any sessions that should be finalized? -- #\r\n        # when was our last finalized session?\r\n        #last_session = @influx.query \"SELECT max(time) from sessions\", (err,res) =>\r\n        #    console.log \"last session is \", err, res\r\n        # what sessions have we seen since then?\r\n\r\n        # -- Redis Session Sweep -- #\r\n\r\n        if @redis\r\n            @log.info \"Analytics setting up Redis session sweeper\"\r\n\r\n            setInterval =>\r\n                # look for sessions that should be written (score less than now)\r\n                @redis.zrangebyscore \"session-timeouts\", 0, Math.floor( Number(new Date) / 1000), (err,sessions) =>\r\n                    return @log.error \"Error fetching sessions to finalize: #{err}\" if err\r\n\r\n                    _sFunc = =>\r\n                        if s = sessions.shift()\r\n                            @_triggerSession s\r\n                            _sFunc()\r\n\r\n                    _sFunc()\r\n\r\n            , 5*1000\r\n\r\n    #----------\r\n\r\n    _log: (obj,cb) ->\r\n        session_id = null\r\n\r\n        if !obj.client?.session_id\r\n            cb? new Error \"Object does not contain a session ID\"\r\n            return false\r\n\r\n        # write one index per day of data\r\n        index_date = tz(obj.time,\"%F\")\r\n\r\n        time = new Date( obj.time )\r\n\r\n        # clean up IPv4 IP addresses stuck in IPv6\r\n        if obj.client?.ip\r\n            obj.client.ip = obj.client.ip.replace /^::ffff:/, \"\"\r\n\r\n        @_indicesForTimeRange \"listens\", time, (err,idx) =>\r\n            switch obj.type\r\n                when \"session_start\"\r\n                    @idx_batch.write index:idx[0], body:\r\n                        time:       new Date(obj.time)\r\n                        session_id: obj.client.session_id\r\n                        stream:     obj.stream_group || obj.stream\r\n                        client:     obj.client\r\n                        type:       \"start\"\r\n\r\n                    cb? null\r\n\r\n                    # -- start tracking the session -- #\r\n\r\n                when \"listen\"\r\n                    # do we know of other duration for this session?\r\n                    @_getStashedDurationFor obj.client.session_id, obj.duration, (err,dur) =>\r\n                        @idx_batch.write index:idx[0], body:\r\n                            session_id:         obj.client.session_id\r\n                            time:               new Date(obj.time)\r\n                            kbytes:             obj.kbytes\r\n                            duration:           obj.duration\r\n                            session_duration:   dur\r\n                            stream:             obj.stream\r\n                            client:             obj.client\r\n                            offsetSeconds:      obj.offsetSeconds\r\n                            contentTime:        obj.contentTime\r\n                            type:               \"listen\"\r\n\r\n                        cb? null\r\n\r\n            # -- update our timer -- #\r\n\r\n            @_updateSessionTimerFor obj.client.session_id, (err) =>\r\n\r\n    #----------\r\n\r\n    # Given a session id and duration, add the given duration to any\r\n    # existing cached duration and return the accumulated number\r\n    _getStashedDurationFor: (session,duration,cb) ->\r\n        if @redis\r\n            # use redis stash\r\n            key = \"duration-#{session}\"\r\n            @redis.incrby key, Math.round(duration), (err,res) =>\r\n                cb err, res\r\n\r\n            # set a TTL on our key, so that it doesn't stay indefinitely\r\n            @redis.pexpire key, 5*60*1000, (err) =>\r\n                @log.error \"Failed to set Redis TTL for #{key}: #{err}\" if err\r\n\r\n        else\r\n            # use memory stash\r\n            s = @_ensureMemorySession session\r\n            s.duration += duration\r\n            cb null, s.duration\r\n\r\n    #----------\r\n\r\n    _updateSessionTimerFor: (session,cb) ->\r\n        if @_timeout_sec <= 0\r\n            # timeouts are disabled\r\n            return cb null\r\n\r\n        if @redis\r\n            # this will set the score, or update it if the session is\r\n            # already in the set\r\n            timeout_at = (Number(new Date) / 1000) + @_timeout_sec\r\n\r\n            @redis.zadd \"session-timeouts\", timeout_at, session, (err) =>\r\n                cb err\r\n\r\n        else\r\n            s = @_ensureMemorySession session\r\n\r\n            clearTimeout s.timeout if s.timeout\r\n\r\n            s.timeout = setTimeout =>\r\n                @_triggerSession session\r\n            , @_timeout_sec * 1000\r\n\r\n            cb null\r\n\r\n    #----------\r\n\r\n    _scrubSessionFor: (session,cb) ->\r\n        if @redis\r\n            @redis.zrem \"session-timeouts\", session, (err) =>\r\n                return cb err if err\r\n\r\n                @redis.del \"duration-#{session}\", (err) =>\r\n                    cb err\r\n\r\n        else\r\n           s = @_ensureMemorySession session\r\n           clearTimeout s.timeout if s.timeout\r\n           delete @sessions[session]\r\n\r\n           cb null\r\n\r\n\r\n    #----------\r\n\r\n    _ensureMemorySession: (session) ->\r\n        @sessions[ session ] ||=\r\n            duration:0, last_seen_at:Number(new Date()), timeout:null\r\n\r\n    #----------\r\n\r\n    _triggerSession: (session) ->\r\n        @_scrubSessionFor session, (err) =>\r\n            return @log.error \"Error cleaning session cache: #{err}\" if err\r\n\r\n            @_finalizeSession session, (err,obj) =>\r\n                return @log.error \"Error assembling session: #{err}\" if err\r\n\r\n                if obj\r\n                    @_storeSession obj, (err) =>\r\n                        @log.error \"Error writing session: #{err}\" if err\r\n\r\n    #----------\r\n\r\n    _finalizeSession: (id,cb) ->\r\n        @log.debug \"Finalizing session for #{ id }\"\r\n\r\n        # This is a little ugly. We need to take several steps:\r\n        # 1) Have we ever finalized this session id?\r\n        # 2) Look up the session_start for the session_id\r\n        # 3) Compute the session's sent kbytes, sent duration, and elapsed duration\r\n        # 4) Write a session object\r\n\r\n        session = {}\r\n\r\n        # -- Get Started -- #\r\n\r\n        @_selectPreviousSession id, (err,ts) =>\r\n            if err\r\n                @log.error err\r\n                return cb? err\r\n\r\n            @_selectSessionStart id, (err,start) =>\r\n                if err\r\n                    @log.error err\r\n                    return cb err\r\n\r\n                if !start\r\n                    @log.debug \"Attempt to finalize invalid session. No start event for #{id}.\"\r\n                    return cb null, false\r\n\r\n                @_selectListenTotals id, ts, (err,totals) =>\r\n                    if err\r\n                        @log.error err\r\n                        return cb? err\r\n\r\n                    if !totals\r\n                        # Session did not have any recorded listen events.  Toss it.\r\n                        return cb null, false\r\n\r\n                    # -- build session -- #\r\n\r\n                    session =\r\n                        session_id: id\r\n                        output:     start.output\r\n                        stream:     start.stream\r\n                        time:       totals.last_listen\r\n                        start_time: ts || start.time\r\n                        client:     start.client\r\n                        kbytes:     totals.kbytes\r\n                        duration:   totals.duration\r\n                        connected:  ( Number(totals.last_listen) - Number(ts||start.time) ) / 1000\r\n\r\n                    cb null, session\r\n\r\n    #----------\r\n\r\n    class @LogTransport extends winston.Transport\r\n        name: \"analytics\"\r\n\r\n        constructor: (@a) ->\r\n            super level:\"interaction\"\r\n\r\n        log: (level,msg,meta,cb) ->\r\n            if level == \"interaction\"\r\n                @a._log meta\r\n                cb?()\r\n\r\n    #----------\r\n"
  ]
}