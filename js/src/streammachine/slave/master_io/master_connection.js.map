{
  "version": 3,
  "file": "master_connection.js",
  "sourceRoot": "../../../../../src/streammachine/slave/master_io/",
  "sources": [
    "master_connection.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "Socket = require \"socket.io-client\"\r\n{Events} = require('../../events')\r\n\r\n# This is the component that interacts with Master\r\n# See events.\r\n#\r\n\r\n\r\nmodule.exports = class MasterConnection extends require(\"events\").EventEmitter\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @logger = @ctx.logger.child(\r\n            component: 'slave:master-connection'\r\n        )\r\n        @config = @ctx.config.slave\r\n\r\n        @connected       = false\r\n        @io              = null\r\n        @id              = null\r\n        @attempts        = 1\r\n        @masterIndex     = -1\r\n        @forceDisconnect = false\r\n\r\n        # -- connect to the master server -- #\r\n\r\n        @_start()\r\n\r\n    #----------\r\n\r\n    once_connected: (cb) ->\r\n        if @connected\r\n            cb null, @io\r\n        else\r\n            @once \"connected\", => cb null, @io\r\n\r\n    #----------\r\n\r\n    _start: ->\r\n        master = @config.master\r\n\r\n        if typeof master != \"string\"\r\n            if master.length isnt (@masterIndex + 1)\r\n                @masterIndex = @masterIndex + 1\r\n\r\n            if @attempts >= @config.retry\r\n                @attempts = 1\r\n\r\n            master = master[@masterIndex]\r\n\r\n        @disconnect()\r\n        @_connect(master)\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        @forceDisconnect = true\r\n        @io?.disconnect()\r\n\r\n    #----------\r\n\r\n    _connect: (master) ->\r\n        @logger.debug \"connect to master at #{master}\"\r\n\r\n        @io = Socket.connect master, reconnection:true, timeout:@config.timeout\r\n\r\n        # -- handle new connections -- #\r\n\r\n        @io.on \"connect\", =>\r\n            @logger.debug \"Slave in _onConnect.\"\r\n\r\n            # make sure our connection is valid with a ping\r\n            pingTimeout = setTimeout =>\r\n                @logger.error \"Failed to get master OK ping.\"\r\n                # FIXME: exit?\r\n            , 1000\r\n\r\n            @io.emit Events.IO.CONNECTION_OK, (res) =>\r\n                clearTimeout pingTimeout\r\n\r\n                if res == \"OK\"\r\n                    # connect up our logging proxy\r\n                    @logger.debug \"Connected to master.\"\r\n                    @id = @io.io.engine.id\r\n                    @connected = true\r\n                    @emit \"connected\"\r\n\r\n                else\r\n                    @logger.error \"Master OK ping response invalid: #{res}\"\r\n                    # FIXME: exit?\r\n\r\n        # -- handle errors -- #\r\n\r\n        @io.on \"connect_error\", (err) =>\r\n            if err.code =~ /ECONNREFUSED/\r\n                @logger.info \"Slave connection refused: #{err}\"\r\n            else\r\n                @logger.info \"Slave got connection error of #{err}\", error:err\r\n                console.log \"got connection error of \", err\r\n\r\n            @attempts = @attempts + 1\r\n\r\n            if @isNecesaryReconnect()\r\n                @_start()\r\n\r\n        @io.on \"disconnect\", =>\r\n            @connected = false\r\n            @logger.debug \"Disconnected from master.\"\r\n\r\n            @emit \"disconnect\"\r\n            # FIXME: Exit?\r\n\r\n        @io.on Events.IO.CONFIG, (config) =>\r\n            @ctx.slave.configureStreams config.streams\r\n\r\n        @io.on Events.IO.SLAVE_STATUS, (cb) =>\r\n            @ctx.slave._streamStatus cb\r\n\r\n        @io.on Events.IO.AUDIO, (obj) =>\r\n            # our data gets converted into an ArrayBuffer to go over the\r\n            # socket. convert it back before insertion\r\n            obj.chunk.data = Buffer.from(obj.chunk.data)\r\n\r\n            # convert timestamp back to a date object\r\n            obj.chunk.ts = new Date(obj.chunk.ts)\r\n\r\n            @emit \"audio:#{obj.stream}\", obj.chunk\r\n\r\n    #----------\r\n\r\n    isNecesaryReconnect: ->\r\n        master = @config.master\r\n\r\n        if typeof master != \"string\"\r\n            if @attempts < @config.retry\r\n                return false\r\n\r\n            else if master.length isnt (@masterIndex + 1)\r\n                return true\r\n        false\r\n\r\n    #----------\r\n\r\n    vitals: (key,cb) ->\r\n        @io.emit Events.IO.SLAVE_VITALS, key, cb\r\n\r\n    log: (obj) ->\r\n        @io.emit \"log\", obj\r\n"
  ]
}