{
  "version": 3,
  "file": "server.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "server.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "express = require 'express'\r\n_       = require 'underscore'\r\nutil    = require 'util'\r\nfs      = require 'fs'\r\npath    = require 'path'\r\nuuid    = require 'node-uuid'\r\nhttp    = require \"http\"\r\ncompression = require \"compression\"\r\ncors    = require \"cors\"\r\nmaxmind = require \"maxmind\"\r\ngreenlock = require \"greenlock-express\"\r\n\r\nmodule.exports = class Server extends require('events').EventEmitter\r\n    constructor: (@opts) ->\r\n        super()\r\n\r\n        @core   = @opts.core\r\n        @logger = @opts.logger\r\n        @config = @opts.config\r\n\r\n        # -- set up our express app -- #\r\n\r\n        @app = express()\r\n\r\n        if @opts.config.cors?.enabled\r\n            origin = @opts.config.cors.origin || true\r\n\r\n            @app.use cors(origin:origin, methods:\"GET,HEAD\")\r\n\r\n        @app.httpAllowHalfOpen = true\r\n        @app.useChunkedEncodingByDefault = false\r\n\r\n        @app.set \"x-powered-by\", \"StreamMachine\"\r\n\r\n        # -- are we behind a geolock? -- #\r\n\r\n        @isGeolockEnabled = (@config.geolock && @config.geolock.enabled)\r\n        if @isGeolockEnabled\r\n            @logger.info \"Enabling 'geolock' for streams\"\r\n            @countryLookup = maxmind.open @config.geolock.config_file\r\n\r\n        # -- are we behind a proxy? -- #\r\n\r\n        if @config.behind_proxy\r\n            @logger.debug \"enable 'trust proxy' for express\"\r\n            @app.set \"trust proxy\", true\r\n\r\n        # -- Set up sessions -- #\r\n\r\n        if @config.session?.secret && @config.session?.key\r\n            @app.use express.cookieParser()\r\n            @app.use express.cookieSession\r\n                key:    @config.session?.key\r\n                secret: @config.session?.secret\r\n\r\n            @app.use (req,res,next) =>\r\n                if !req.session.userID\r\n                    req.session.userID = uuid.v4()\r\n\r\n                req.user_id = req.session.userID\r\n\r\n                next()\r\n\r\n        # -- Stream Finder -- #\r\n\r\n        @app.param \"stream\", (req,res,next,key) =>\r\n            # make sure it's a valid stream key\r\n            if key? && s = @core.streams[ key ]\r\n                if @isGeolockEnabled && @isGeolocked req, s, s.opts\r\n                    if s.opts.geolock.fallback\r\n                        res.redirect(302, s.opts.geolock.fallback)\r\n                    else\r\n                        res.status(403).end(\"Invalid Country.\")\r\n                else\r\n                    req.stream = s\r\n                    next()\r\n            else\r\n                res.status(404).end \"Invalid stream.\\n\"\r\n\r\n        # -- Stream Group Finder -- #\r\n\r\n        @app.param \"group\", (req,res,next,key) =>\r\n            # make sure it's a valid stream key\r\n            if key? && s = @core.stream_groups[ key ]\r\n                req.group = s\r\n                next()\r\n            else\r\n                res.status(404).end \"Invalid stream group.\\n\"\r\n\r\n        # -- Funky URL Rewriters -- #\r\n\r\n        @app.use (req,res,next) =>\r\n            if @core.root_route\r\n                if req.url == '/' || req.url == \"/;stream.nsv\" || req.url == \"/;\"\r\n                    req.url = \"/#{@core.root_route}\"\r\n                    next()\r\n                else if req.url == \"/listen.pls\"\r\n                    req.url = \"/#{@core.root_route}.pls\"\r\n                    next()\r\n                else\r\n                    next()\r\n            else\r\n                next()\r\n\r\n        # -- Debug Logger -- #\r\n\r\n        if @config.debug_incoming_requests\r\n            @app.use (req,res,next) =>\r\n                @logger.debug \"Request: #{req.url}\", ip:req.ip, ua:req.headers?['user-agent']\r\n                next()\r\n\r\n        # -- check user agent for banned clients -- #\r\n\r\n        if @config.ua_skip\r\n            banned = ///#{@config.ua_skip.join(\"|\")}///\r\n\r\n            @app.use (req,res,next) =>\r\n                return next() unless req.headers?['user-agent'] && banned.test(req.headers[\"user-agent\"])\r\n\r\n                # request from banned agent...\r\n                @logger.debug \"Request from banned User-Agent: #{req.headers['user-agent']}\",\r\n                    ip:     req.ip\r\n                    url:    req.url\r\n\r\n                res.status(403).end(\"Invalid User Agent.\")\r\n\r\n        # -- Utility Routes -- #\r\n\r\n        @app.get \"/index.html\", (req,res) =>\r\n            res.set \"content-type\", \"text/html\"\r\n            res.set \"connection\", \"close\"\r\n\r\n            res.status(200).end \"\"\"\r\n                <html>\r\n                    <head><title>StreamMachine</title></head>\r\n                    <body>\r\n                        <h1>OK</h1>\r\n                    </body>\r\n                </html>\r\n            \"\"\"\r\n\r\n        @app.get \"/crossdomain.xml\", (req,res) =>\r\n            res.set \"content-type\", \"text/xml\"\r\n            res.set \"connection\", \"close\"\r\n\r\n            res.status(200).end \"\"\"\r\n                <?xml version=\"1.0\"?>\r\n                <!DOCTYPE cross-domain-policy SYSTEM \"http://www.macromedia.com/xml/dtds/cross-domain-policy.dtd\">\r\n                <cross-domain-policy>\r\n                <allow-access-from domain=\"*\" />\r\n                </cross-domain-policy>\r\n            \"\"\"\r\n        # -- Stream Routes -- #\r\n\r\n        # playlist file\r\n        @app.get \"/:stream.pls\", (req,res) =>\r\n            res.set \"content-type\", \"audio/x-scpls\"\r\n            res.set \"connection\", \"close\"\r\n\r\n            host = req.headers?.host || req.stream.options.host\r\n\r\n            res.status(200).end \"[playlist]\\nNumberOfEntries=1\\nFile1=http://#{host}/#{req.stream.key}/\\n\"\r\n\r\n        # head request\r\n        @app.head \"/:stream\", (req,res) =>\r\n            res.set \"content-type\", \"audio/mpeg\"\r\n            res.status(200).end()\r\n\r\n        # listen to the stream\r\n        @app.get \"/:stream\", (req,res) =>\r\n            res.set \"X-Powered-By\", \"StreamMachine\"\r\n\r\n            # -- Stream match! -- #\r\n            if req.query.pump\r\n                # pump listener pushes from the buffer as fast as possible\r\n                new @core.Outputs.pumper req.stream, req:req, res:res\r\n\r\n            else\r\n                # normal live stream (with or without shoutcast)\r\n                if req.headers['icy-metadata']\r\n                    # -- shoutcast listener -- #\r\n                    new @core.Outputs.shoutcast req.stream, req:req, res:res\r\n                else\r\n                    # -- straight mp3 listener -- #\r\n                    new @core.Outputs.raw req.stream, req:req, res:res\r\n\r\n        @_setupServer @app\r\n\r\n    #----------\r\n\r\n    isGeolocked: (req,stream,opts) ->\r\n        locked = false\r\n\r\n        if opts.geolock && opts.geolock.enabled\r\n            data = @countryLookup.get req.ip\r\n            country = null\r\n\r\n            if data && data.country\r\n                country = data.country\r\n\r\n            if country && country.iso_code\r\n                index = opts.geolock.countryCodes.indexOf(country.iso_code)\r\n\r\n                if opts.geolock.mode == \"blacklist\"\r\n                    locked = index >= 0\r\n\r\n                else\r\n                    locked = index < 0\r\n\r\n            if locked && country\r\n                # request from invalid country...\r\n                @logger.debug \"Request from invalid country: #{country.names.es} (#{country.iso_code})\",\r\n                    ip: req.ip\r\n\r\n        locked\r\n\r\n    #----------\r\n\r\n    listen: (port,cb) ->\r\n        @logger.info \"SlaveWorker called listen\"\r\n        @hserver = @app.listen port, =>\r\n            #@io = require(\"socket.io\").listen @hserver\r\n            #@emit \"io_connected\", @io\r\n            cb?(@hserver)\r\n        @hserver\r\n\r\n    #----------\r\n\r\n    close: ->\r\n        @logger.info \"Slave server asked to stop listening.\"\r\n        @hserver?.close => @logger.info \"Slave server listening stopped.\"\r\n\r\n    #----------\r\n\r\n    _setupServer: (app) ->\r\n        config = @config\r\n        if process.env.NO_GREENLOCK\r\n            @logger.info \"Setup http server on port \" + config.http_port\r\n            server = http.createServer(app)\r\n            server.listen config.http_port || 80\r\n        else\r\n            @logger.deug \"setup Greenlock http/https servers\"\r\n            packageRoot = path.resolve(__dirname, '../../../..')\r\n            greenlock.init({\r\n                packageRoot\r\n                configDir: \"./greenlock.d\"\r\n                cluster: true,\r\n                workers: 4,\r\n                maintainerEmail: \"contact@mediainbox.io\"\r\n            })\r\n                .ready((glx) ->\r\n                    plainServer = glx.httpServer(app)\r\n                    plainAddr = config.http_ip || '0.0.0.0'\r\n                    plainPort = config.http_port || 80\r\n                    plainServer.listen plainPort, plainAddr, ->\r\n                        secureServer = glx.httpsServer(null, app)\r\n                        secureAddr = config.https_ip || '0.0.0.0'\r\n                        securePort = config.https_port || 443\r\n                        secureServer.listen securePort, secureAddr, ->\r\n                            plainServer.removeAllListeners 'error'\r\n                            secureServer.removeAllListeners 'error'\r\n                            console.log(\"Greenlock: cluster child on PID \" + process.pid)\r\n                )\r\n                .master(() =>\r\n                    console.log(\"Greenlock: master on PID \" + process.pid);\r\n                )\r\n\r\n"
  ]
}