{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_ = require \"underscore\"\r\n\r\nStream  = require \"./stream\"\r\nServer  = require \"./server\"\r\nAlerts  = require \"../alerts\"\r\nMasterConnection      = require \"./master_io/master_connection\"\r\nSocketSource = require \"./socket_source\"\r\n{ EventTypes, EventsHub } = require('./events')\r\ntz      = require 'timezone'\r\n\r\nmodule.exports = class Slave extends require(\"events\").EventEmitter\r\n    Outputs:\r\n        pumper:         require \"../outputs/pumper\"\r\n        shoutcast:      require \"../outputs/shoutcast\"\r\n        raw:            require \"../outputs/raw_audio\"\r\n\r\n    constructor: (@ctx) ->\r\n        super()\r\n\r\n        @_configured = false\r\n\r\n        @master = null\r\n\r\n        @streams        = {}\r\n        @stream_groups  = {}\r\n        @root_route     = null\r\n\r\n        @connected      = false\r\n        @_retrying      = null\r\n\r\n        @_shuttingDown  = false\r\n\r\n        # -- Global Stats -- #\r\n\r\n        # we'll track these at the stream level and then bubble them up\r\n        @_totalConnections  = 0\r\n        @_totalKBytesSent   = 0\r\n\r\n        # -- Set up logging -- #\r\n\r\n        @ctx.events = new EventsHub\r\n        @ctx.slave = @\r\n        @config = @ctx.config\r\n        @logger = @ctx.logger.child({\r\n            component: \"slave\"\r\n        })\r\n        @logger.debug \"initialize slave\"\r\n\r\n        # -- create an alerts object -- #\r\n\r\n        @alerts = new Alerts logger:@logger.child(module:\"alerts\")\r\n\r\n        # -- Make sure we have the proper slave config options -- #\r\n\r\n        if @config.slave?.master\r\n            @masterConnection = new MasterConnection @ctx\r\n\r\n            @masterConnection.on \"connected\", =>\r\n                @logger.debug \"IO is connected\"\r\n                @alerts.update \"slave_disconnected\", @masterConnection.id, false\r\n                # TODO @logger.proxyToMaster(@masterConnection)\r\n\r\n            @masterConnection.on \"disconnected\", =>\r\n                @logger.debug \"IO is disconnected\"\r\n                @alerts.update \"slave_disconnected\", @masterConnection.id, true\r\n                # TODO @logger.proxyToMaster()\r\n\r\n        @once \"streams\", =>\r\n            @logger.debug \"Streams event received\"\r\n            @_configured = true\r\n\r\n        # -- set up our stream server -- #\r\n\r\n        @server = new Server core:@, logger:@logger.child(subcomponent:\"server\"), config:@config\r\n\r\n    #----------\r\n\r\n    once_configured: (cb) ->\r\n        if @_configured\r\n            cb()\r\n        else\r\n            @once \"streams\", => cb()\r\n\r\n    once_rewinds_loaded: (cb) ->\r\n        @once_configured =>\r\n            @logger.debug \"Looking for sources to load in #{ Object.keys(@streams).length } streams.\"\r\n            aFunc = _.after Object.keys(@streams).length, =>\r\n                @logger.debug \"All sources are loaded.\"\r\n                cb()\r\n\r\n            # watch for each configured stream to have its rewind buffer loaded.\r\n            obj._once_source_loaded aFunc for k,obj of @streams\r\n\r\n    #----------\r\n\r\n    _shutdown: (cb) ->\r\n        if !@_worker\r\n            cb \"Don't have _worker to trigger shutdown on.\"\r\n            return false\r\n\r\n        if @_shuttingDown\r\n            # already shutting down...\r\n            cb \"Shutdown already in progress.\"\r\n            return false\r\n\r\n        @_shuttingDown = true\r\n\r\n        # A shutdown involves a) stopping listening for new connections and\r\n        # b) transferring our listeners to a different slave\r\n\r\n        # tell our server to stop listening\r\n        @server.close()\r\n\r\n        # tell our worker process to transfer out our listeners\r\n        @_worker.shutdown cb\r\n\r\n    #----------\r\n\r\n    configureStreams: (options) ->\r\n        @logger.debug \"In configureStreams\"\r\n        @logger.debug \"In slave configureStreams with \", options:options\r\n\r\n        # are any of our current streams missing from the new options? if so,\r\n        # disconnect them\r\n        for k,obj of @streams\r\n            if !options?[k]\r\n                @logger.debug \"configureStreams: Disconnecting stream #{k}\"\r\n                @logger.info \"configureStreams: Calling disconnect on #{k}\"\r\n                obj.disconnect()\r\n                delete @streams[k]\r\n\r\n        # run through the streams we've been passed, initializing sources and\r\n        # creating rewind buffers\r\n\r\n        @logger.debug \"configureStreams: New options start\"\r\n        for key,opts of options\r\n            @logger.debug \"configureStreams: Configuring #{key}\"\r\n            if @streams[key]\r\n                # existing stream...  pass it updated configuration\r\n                @logger.debug \"Passing updated config to stream: #{key}\", opts:opts\r\n                @streams[key].configure opts\r\n            else\r\n                @logger.debug \"Starting up stream: #{key}\", opts:opts\r\n\r\n                # FIXME: Eventually it would make sense to allow a per-stream\r\n                # value here\r\n                opts.tz = tz(require \"timezone/zones\")(@config.timezone||\"UTC\")\r\n\r\n                stream = @streams[key] = new Stream @, key, @logger.child(stream:key), opts\r\n\r\n                if @masterConnection\r\n                    source = @socketSource stream\r\n                    stream.useSource source\r\n\r\n            # should this stream accept requests to /?\r\n            if opts.root_route\r\n                @root_route = key\r\n\r\n        # emit a streams event for any components under us that might\r\n        # need to know\r\n        @logger.debug \"Done with configureStreams\"\r\n        @emit \"streams\", @streams\r\n\r\n    #----------\r\n\r\n    # Get a status snapshot by looping through each stream to return buffer\r\n    # stats. Lets master know that we're still listening and current\r\n    _streamStatus: (cb) ->\r\n        status = {}\r\n\r\n        totalKBytes         = 0\r\n        totalConnections    = 0\r\n\r\n        for key,s of @streams\r\n            status[ key ] = s.status()\r\n\r\n            totalKBytes += status[key].kbytes_sent\r\n            totalConnections += status[key].connections\r\n\r\n        cb null, _.extend status, _stats:{ kbytes_sent:totalKBytes, connections:totalConnections }\r\n\r\n    #----------\r\n\r\n    socketSource: (stream) ->\r\n        new SocketSource @, stream\r\n\r\n    #----------\r\n\r\n    ejectListeners: (lFunc,cb) ->\r\n        # transfer listeners, one at a time\r\n\r\n        @logger.info \"Preparing to eject listeners from slave.\"\r\n\r\n        @_enqueued = []\r\n\r\n        # -- prep our listeners -- #\r\n\r\n        for k,s of @streams\r\n            @logger.info \"Preparing #{ Object.keys(s._lmeta).length } listeners for #{ s.key }\"\r\n            @_enqueued.push [s,obj] for id,obj of s._lmeta\r\n\r\n        # -- short-circuit if there are no listeners -- #\r\n\r\n        return cb?() if @_enqueued.length == 0\r\n\r\n        # -- now send them one-by-one -- #\r\n\r\n        sFunc = =>\r\n            sl = @_enqueued.shift()\r\n\r\n            if !sl\r\n                @logger.info \"All listeners have been ejected.\"\r\n                return cb null\r\n\r\n            [stream,l] = sl\r\n\r\n            # wrap the listener send in an error domain to try as\r\n            # hard as we can to get it all there\r\n            d = require(\"domain\").create()\r\n            d.on \"error\", (err) =>\r\n                console.error \"Handoff error: #{err}\"\r\n                @logger.error \"Eject listener for #{l.id} hit error: #{err}\"\r\n                d.exit()\r\n                sFunc()\r\n\r\n            d.run =>\r\n                l.obj.prepForHandoff (skipHandoff=false) =>\r\n                    # some listeners don't need handoffs\r\n                    if skipHandoff\r\n                        return sFunc()\r\n\r\n                    socket = l.obj.socket\r\n                    lopts =\r\n                        key:        [stream.key,l.id].join(\"::\"),\r\n                        stream:     stream.key\r\n                        id:         l.id\r\n                        startTime:  l.startTime\r\n                        client:     l.obj.client\r\n\r\n                    # there's a chance that the connection could end\r\n                    # after we recorded the id but before we get here.\r\n                    # don't send in that case...\r\n                    if socket && !socket.destroyed\r\n                        lFunc lopts, socket, (err) =>\r\n                            if err\r\n                                @logger.error \"Failed to send listener #{lopts.id}: #{err}\"\r\n\r\n                            # move on to the next one...\r\n                            sFunc()\r\n\r\n                    else\r\n                        @logger.info \"Listener #{lopts.id} perished in the queue. Moving on.\"\r\n                        sFunc()\r\n\r\n        sFunc()\r\n\r\n    #----------\r\n\r\n    landListener: (obj,socket,cb) ->\r\n        # check and make sure they haven't disconnected mid-flight\r\n        if socket && !socket.destroyed\r\n            # create an output and attach it to the proper stream\r\n            output = new @Outputs[ obj.client.output ] @streams[ obj.stream ],\r\n                socket:     socket\r\n                client:     obj.client\r\n                startTime:  new Date(obj.startTime)\r\n\r\n            cb null\r\n\r\n        else\r\n            cb \"Listener disconnected in-flight\"\r\n\r\n    #----------\r\n"
  ]
}