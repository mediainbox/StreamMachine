{
  "version": 3,
  "file": "slave_io.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "slave_io.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "Socket = require \"socket.io-client\"\r\n\r\nmodule.exports = class MasterConnection extends require(\"events\").EventEmitter\r\n    constructor: (@slave,@_log,@opts) ->\r\n        super()\r\n\r\n        @connected       = false\r\n        @io              = null\r\n        @id              = null\r\n        @attempts        = 1\r\n        @masterIndex     = -1\r\n        @forceDisconnect = false\r\n\r\n        # -- connect to the master server -- #\r\n\r\n        @_log.debug \"Connecting to master at \", master:@opts.master\r\n\r\n        @_start()\r\n\r\n    #----------\r\n\r\n    once_connected: (cb) ->\r\n        if @connected\r\n            cb null, @io\r\n        else\r\n            @once \"connected\", => cb null, @io\r\n\r\n    #----------\r\n\r\n    _start: ->\r\n        master = @opts.master\r\n\r\n        if typeof master != \"string\"\r\n            if master.length isnt (@masterIndex + 1)\r\n                @masterIndex = @masterIndex + 1\r\n\r\n            if @attempts >= @opts.retry\r\n                @attempts = 1\r\n\r\n            master = master[@masterIndex]\r\n\r\n        @disconnect()\r\n        @_connect(master)\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        @forceDisconnect = true\r\n        @io?.disconnect()\r\n\r\n    #----------\r\n\r\n    _connect: (master) ->\r\n        @_log.info \"Slave trying connection to master #{ master }\"\r\n\r\n        @io = Socket.connect master, reconnection:true, timeout:@opts.timeout\r\n\r\n        # -- handle new connections -- #\r\n\r\n        @io.on \"connect\", =>\r\n            @_log.debug \"Slave in _onConnect.\"\r\n\r\n            # make sure our connection is valid with a ping\r\n            pingTimeout = setTimeout =>\r\n                @_log.error \"Failed to get master OK ping.\"\r\n                # FIXME: exit?\r\n            , 1000\r\n\r\n            @io.emit \"ok\", (res) =>\r\n                clearTimeout pingTimeout\r\n\r\n                if res == \"OK\"\r\n                    # connect up our logging proxy\r\n                    @_log.debug \"Connected to master.\"\r\n                    @id = @io.io.engine.id\r\n                    @connected = true\r\n                    @emit \"connected\"\r\n\r\n                else\r\n                    @_log.error \"Master OK ping response invalid: #{res}\"\r\n                    # FIXME: exit?\r\n\r\n        # -- handle errors -- #\r\n\r\n        @io.on \"connect_error\", (err) =>\r\n            if err.code =~ /ECONNREFUSED/\r\n                @_log.info \"Slave connection refused: #{err}\"\r\n            else\r\n                @_log.info \"Slave got connection error of #{err}\", error:err\r\n                console.log \"got connection error of \", err\r\n\r\n            @attempts = @attempts + 1\r\n\r\n            if @isNecesaryReconnect()\r\n                @_start()\r\n\r\n        # -- handle disconnects -- #\r\n\r\n        @io.on \"disconnect\", =>\r\n            @connected = false\r\n            @_log.debug \"Disconnected from master.\"\r\n\r\n            @emit \"disconnect\"\r\n            # FIXME: Exit?\r\n\r\n        # -- RPC calls -- #\r\n\r\n        @io.on \"config\", (config) =>\r\n            @slave.configureStreams config.streams\r\n\r\n        @io.on \"status\", (cb) =>\r\n            @slave._streamStatus cb\r\n\r\n        @io.on \"should_shutdown\", (cb) =>\r\n            @slave._shutdown cb\r\n\r\n        @io.on \"audio\", (obj) =>\r\n            # our data gets converted into an ArrayBuffer to go over the\r\n            # socket. convert it back before insertion\r\n            obj.chunk.data = Buffer.from(obj.chunk.data)\r\n\r\n            # convert timestamp back to a date object\r\n            obj.chunk.ts = new Date(obj.chunk.ts)\r\n\r\n            @emit \"audio:#{obj.stream}\", obj.chunk\r\n\r\n    #----------\r\n\r\n    isNecesaryReconnect: ->\r\n        master = @opts.master\r\n\r\n        if typeof master != \"string\"\r\n            if @attempts < @opts.retry\r\n                return false\r\n\r\n            else if master.length isnt (@masterIndex + 1)\r\n                return true\r\n        false\r\n\r\n    #----------\r\n\r\n    vitals: (key,cb) ->\r\n        @io.emit \"vitals\", key, cb\r\n\r\n    log: (obj) ->\r\n        @io.emit \"log\", obj\r\n"
  ]
}