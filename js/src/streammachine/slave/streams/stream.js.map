{
  "version": 3,
  "file": "stream.js",
  "sourceRoot": "../../../../../src/streammachine/slave/streams/",
  "sources": [
    "stream.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nuuid    = require \"node-uuid\"\r\n\r\n\r\nPreroller   = require \"./ads/preroller\"\r\nRewindBuffer      = require \"../../rewind_buffer\"\r\n\r\ndebug = require(\"debug\")(\"sm:slave:stream\")\r\n\r\n# Stream is the componenent where that listeners connect to.\r\n# Loads data from rewind buffer and pushes them to clients\r\n\r\nmodule.exports = class Stream extends RewindBuffer\r\n    constructor: (@core,key,log,opts) ->\r\n        # initialize RewindBuffer\r\n        super seconds: opts.seconds, burst:opts.burst, logger: log, station: key\r\n        @log = log\r\n        @key = key\r\n        @opts = opts\r\n\r\n        @STATUS = \"Initializing\"\r\n\r\n        @StreamTitle  = @opts.metaTitle\r\n        @StreamUrl    = \"\"\r\n\r\n        # remove our max listener count\r\n        @setMaxListeners 0\r\n\r\n        @_id_increment = 1\r\n        @_lmeta = {}\r\n\r\n        @preroll = null\r\n        @mlog_timer = null\r\n\r\n        # -- Stats Counters -- #\r\n\r\n        @_totalConnections  = 0\r\n        @_totalKBytesSent   = 0\r\n\r\n        @metaFunc = (chunk) =>\r\n            @StreamTitle    = chunk.StreamTitle if chunk.StreamTitle\r\n            @StreamUrl      = chunk.StreamUrl if chunk.StreamUrl\r\n\r\n        @bufferFunc = (c) =>\r\n            @_insertBuffer(c)\r\n\r\n        @once \"source\", =>\r\n            @source.on \"meta\", @metaFunc\r\n            @source.on \"buffer\", @bufferFunc\r\n\r\n        # now run configure...\r\n        process.nextTick => @configure(@opts)\r\n\r\n\r\n        # -- Wait to Load Rewind Buffer -- #\r\n\r\n        @emit \"_source_waiting\"\r\n\r\n        @_sourceInitializing = true\r\n        @_sourceInitT = setTimeout =>\r\n            @_sourceInitializing = false\r\n            @emit \"_source_init\"\r\n            debug \"Sending _source_init after source timeout\"\r\n        , 15*1000\r\n\r\n        @once \"source\", (source) =>\r\n            debug \"Stream source is incoming.\"\r\n            clearTimeout @_sourceInitT\r\n            @_sourceInitializing = true\r\n            source.getRewind (err,stream,req) =>\r\n                if err\r\n                    @log.error \"Source getRewind encountered an error: #{err}\", error:err\r\n                    @_sourceInitializing = false\r\n                    @emit \"_source_init\"\r\n                    debug \"Sending _source_init after load error\"\r\n                    #@emit \"rewind_loaded\"\r\n\r\n                    return false\r\n\r\n                @loadBuffer stream, (err) =>\r\n                    @log.debug \"Slave source loaded rewind buffer.\"\r\n                    #req.end()\r\n\r\n                    @_sourceInitializing = false\r\n                    @emit \"_source_init\"\r\n                    debug \"Sending _source_init after load success\"\r\n                    #@emit \"rewind_loaded\"\r\n\r\n    #----------\r\n\r\n    status: ->\r\n        _.extend @_rStatus(),\r\n            key:            @key\r\n            listeners:      @listeners()\r\n            connections:    @_totalConnections\r\n            kbytes_sent:    @_totalKBytesSent\r\n\r\n    #----------\r\n\r\n    useSource: (source) ->\r\n        # short-circuit if this is already our source\r\n        return true if @source == source\r\n        \r\n        @log.debug \"Slave stream got source connection\"\r\n        @source = source\r\n        @emit \"source\", @source\r\n\r\n    #----------\r\n\r\n    getStreamKey: (cb) ->\r\n        # use manual stream key if provided as part of stream configuration,\r\n        # to allow for AAC stream keys that can't be pulled out of a header\r\n        if @opts.stream_key\r\n            cb @opts.stream_key\r\n        else\r\n            if @source\r\n                @source.getStreamKey cb\r\n            else\r\n                @once \"source\", =>\r\n                    @source.getStreamKey cb\r\n\r\n    #----------\r\n\r\n    _once_source_loaded: (cb) ->\r\n        if @_sourceInitializing\r\n            # wait for a source_init event\r\n            debug \"_once_source_loaded is waiting for _source_init\"\r\n            @once \"_source_init\", => cb?()\r\n\r\n        else\r\n            # send them on through\r\n            cb?()\r\n\r\n    #----------\r\n\r\n    configure: (@opts) ->\r\n\r\n        # -- Preroll -- #\r\n\r\n        @log.debug \"Preroll settings are \", preroll:@opts.preroll\r\n\r\n        if @opts.preroll? && @opts.preroll != \"\"\r\n            # create a Preroller connection\r\n            key = if (@opts.preroll_key && @opts.preroll_key != \"\") then @opts.preroll_key else @key\r\n\r\n            new Preroller @, key, @opts.preroll, @opts.transcoder, @opts.impression_delay, (err,pre) =>\r\n                if err\r\n                    @log.error \"Failed to create preroller: #{err}\"\r\n                    return false\r\n\r\n                @preroll = pre\r\n                @log.debug \"Preroller is created.\"\r\n\r\n        # -- Set up bufferSize poller -- #\r\n\r\n        # We disconnect clients that have fallen too far behind on their\r\n        # buffers. Buffer size can be configured via the \"max_buffer\" setting,\r\n        # which takes bits\r\n        @log.debug \"Stream's max buffer size is #{ @opts.max_buffer }\"\r\n\r\n        if @buf_timer\r\n            clearInterval @buf_timer\r\n            @buf_timer = null\r\n\r\n        @buf_timer = setInterval =>\r\n            all_buf = 0\r\n            for id,l of @_lmeta\r\n                all_buf += l.rewind._queuedBytes + l.obj.socket?.bufferSize\r\n\r\n                if (l.rewind._queuedBytes||0) + (l.obj.socket?.bufferSize||0) > @opts.max_buffer\r\n                    @log.debug \"Connection exceeded max buffer size.\", client:l.obj.client, bufferSize:l.rewind._queuedBytes\r\n                    l.obj.disconnect(true)\r\n\r\n            @log.debug \"All buffers: #{all_buf}\"\r\n        , 60*1000\r\n\r\n        # Update RewindBuffer settings\r\n        @setRewind @opts.seconds, @opts.burst\r\n\r\n        @emit \"config\"\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        # handle clearing out lmeta\r\n        l.obj.disconnect(true) for k,l of @_lmeta\r\n\r\n        if @buf_timer\r\n            clearInterval @buf_timer\r\n            @buf_timer = null\r\n\r\n        @source?.removeListener \"meta\", @metaFunc\r\n        @source?.removeListener \"buffer\", @bufferFunc\r\n        @source = null\r\n\r\n        @metaFunc = @bufferFunc = ->\r\n\r\n        super()\r\n\r\n        @emit \"disconnect\"\r\n\r\n        @removeAllListeners()\r\n\r\n    #----------\r\n\r\n    listeners: ->\r\n        _(@_lmeta).keys().length\r\n\r\n    #----------\r\n\r\n    listen: (obj,opts,cb) ->\r\n        # generate a metadata hash\r\n        lmeta =\r\n            id:         @_id_increment++\r\n            obj:        obj\r\n            startTime:  opts.startTime  || (new Date)\r\n\r\n        # each listen is a connection\r\n        @_totalConnections += 1\r\n\r\n        # inject stream config into our options\r\n        opts = _.extend { logInterval: @opts.log_interval }, opts\r\n\r\n        # don't ask for a rewinder while our source is going through init,\r\n        # since we don't want to fail an offset request that should be\r\n        # valid.\r\n        @_once_source_loaded =>\r\n            # get a rewinder (handles the actual broadcast)\r\n            @getRewinder lmeta.id, opts, (err,rewind,extra...) =>\r\n                if err\r\n                    cb? err, null\r\n                    return false\r\n\r\n                lmeta.rewind = rewind\r\n\r\n                # stash the object\r\n                @_lmeta[ lmeta.id ] = lmeta\r\n\r\n                # return the rewinder (so that they can change offsets, etc)\r\n                cb? null, lmeta.rewind, extra...\r\n\r\n    #----------\r\n\r\n    disconnectListener: (id) ->\r\n        if lmeta = @_lmeta[id]\r\n            # -- remove from listeners -- #\r\n            delete @_lmeta[id]\r\n\r\n            true\r\n        else\r\n            console.error \"disconnectListener called for #{id}, but no listener found.\"\r\n\r\n    #----------\r\n\r\n    # Log a partial listening segment\r\n    recordListen: (opts) ->\r\n        # temporary conversion support...\r\n        opts.kbytes = Math.floor( opts.bytes / 1024 ) if opts.bytes\r\n\r\n        @_totalKBytesSent += opts.kbytes if _.isNumber(opts.kbytes)\r\n\r\n        if lmeta = @_lmeta[opts.id]\r\n            nothing = 1\r\n            ###\r\n            @log.interaction \"\",\r\n                type:           \"listen\"\r\n                client:         lmeta.obj.client\r\n                time:           new Date()\r\n                kbytes:         opts.kbytes\r\n                duration:       opts.seconds\r\n                offsetSeconds:  opts.offsetSeconds\r\n                contentTime:    opts.contentTime\r\n            ###\r\n\r\n    #----------\r\n\r\n    startSession: (client,cb) ->\r\n        ###\r\n        @log.interaction \"\",\r\n            type:       \"session_start\"\r\n            client:     client\r\n            time:       new Date()\r\n            session_id: client.session_id\r\n        ###\r\n\r\n        cb null, client.session_id\r\n\r\n    #----------\r\n"
  ]
}