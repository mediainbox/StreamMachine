{
  "version": 3,
  "file": "slave_worker.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "slave_worker.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "RPC = require \"ipc-rpc\"\r\n_ = require \"underscore\"\r\n\r\nLogger  = require \"../logger\"\r\nSlave   = require \"./\"\r\n\r\ndebug = require(\"debug\")(\"sm:slave:slave_worker\")\r\n\r\n# TEMP\r\nprocess.on \"uncaughtException\", (err) ->\r\n    console.error \"err is: #{err}\"\r\n    console.error \"err stack is: \", err.stack\r\n\r\nmodule.exports = class SlaveWorker\r\n    constructor: ->\r\n        @_config = null\r\n\r\n        @_configured    = false\r\n        @_loaded        = false\r\n\r\n        debug \"Init for SlaveWorker\"\r\n\r\n        # -- Set up RPC -- #\r\n\r\n        new RPC process, functions:\r\n            status: (msg,handle,cb) =>\r\n                @slave._streamStatus cb\r\n\r\n            #---\r\n\r\n            # Accept an incoming connection attempt\r\n            connection: (msg,sock,cb) =>\r\n                sock.allowHalfOpen = true\r\n                @slave.server.handle sock\r\n                cb null, \"OK\"\r\n\r\n            # Accept a listener that we should now start serving\r\n            land_listener: (msg,handle,cb) =>\r\n                @slave.landListener msg, handle, cb\r\n\r\n            #---\r\n\r\n            # Request to send all our listeners to the main slave process,\r\n            # probably so that it can whack us\r\n            send_listeners: (msg,handle,cb) =>\r\n                @slave.ejectListeners (obj,h,lcb) =>\r\n                    @_rpc.request \"send_listener\", obj, h, (err) =>\r\n                        lcb()\r\n\r\n                , (err) =>\r\n                    cb err\r\n\r\n            #---\r\n\r\n            # Request asking that we shut down...\r\n            shutdown: (msg,handle,cb) =>\r\n                # we ask the slave instance to shut down. It in turn asks us\r\n                # to distribute its listeners.\r\n\r\n                if @slave\r\n                    @slave._shutdown (err) =>\r\n                        cb err\r\n                else\r\n                    # we haven't gotten far enough... just exit\r\n                    cb null\r\n                    setTimeout =>\r\n                        process.exit()\r\n                    , 100\r\n\r\n        , (err,rpc) =>\r\n            @_rpc = rpc\r\n\r\n            # We're initially loaded via no config. At this point, we need\r\n            # to request config from the main slave process.\r\n            debug \"Requesting slave config over RPC\"\r\n            @_rpc.request \"config\", (err,obj) =>\r\n                if err\r\n                    console.error \"Error loading config: #{err}\"\r\n                    process.exit(1)\r\n\r\n                debug \"Slave config received\"\r\n\r\n                @_config = obj\r\n\r\n                if @_config[\"enable-webkit-devtools-slaveworker\"]\r\n                    console.log \"ENABLING WEBKIT DEVTOOLS IN SLAVE WORKER\"\r\n                    agent = require(\"webkit-devtools-agent\")\r\n                    agent.start()\r\n\r\n                @log = (new Logger @_config.log).child mode:\"slave_worker\", pid:process.pid\r\n                @log.debug(\"SlaveWorker initialized\")\r\n\r\n                # -- Create our Slave Instance -- #\r\n\r\n                debug \"Creating slave instance\"\r\n                @slave = new Slave _.extend(@_config, logger:@log), @\r\n\r\n                # -- Communicate Config Back to Slave -- #\r\n\r\n                # we watch the slave instance, and communicate its config event back\r\n                # to the main slave\r\n\r\n                @slave.once_configured =>\r\n                    debug \"Slave instance says it is configured\"\r\n                    @_configured = true\r\n                    @_rpc.request \"worker_configured\", (err) =>\r\n                        if err\r\n                            @log.error \"Error sending worker_configured: #{err}\"\r\n                        else\r\n                            @log.debug \"Controller ACKed that we're configured.\"\r\n                            debug \"Slave controller ACKed our config\"\r\n\r\n                # -- Communicate Rewinds Back to Slave -- #\r\n\r\n                # when all rewinds are loaded, pass that word on to our main slave\r\n\r\n                @slave.once_rewinds_loaded =>\r\n                    debug \"Slave instance says rewinds are loaded\"\r\n                    @_loaded = true\r\n                    @_rpc.request \"rewinds_loaded\", (err) =>\r\n                        if err\r\n                            @log.error \"Error sending rewinds_loaded: #{err}\"\r\n                        else\r\n                            @log.debug \"Controller ACKed that our rewinds are loaded.\"\r\n                            debug \"Slave controller ACKed that our rewinds are loaded\"\r\n\r\n    #----------\r\n\r\n    # A slave worker instance can request to shut down either\r\n    # because it got a request to do so from the master, or\r\n    # because of some sort of a fault condition in the worker.\r\n\r\n    # To shut down, we need to transfer the worker instance's\r\n    # listeners to a different worker.\r\n\r\n    shutdown: (cb) ->\r\n        @log.info \"Triggering listener ejection after shutdown request.\"\r\n        @slave.ejectListeners (obj,h,lcb) =>\r\n            @_rpc.request \"send_listener\", obj, h, (err) =>\r\n                lcb()\r\n\r\n        , (err) =>\r\n            # now that we're finished transferring listeners, we need to\r\n            # go ahead and shut down\r\n            @log.info \"Listener ejection completed. Shutting down...\"\r\n\r\n            cb err\r\n\r\n            setTimeout =>\r\n                @log.info \"Shutting down.\"\r\n                process.exit(1)\r\n            , 300\r\n"
  ]
}