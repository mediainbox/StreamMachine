{
  "version": 3,
  "file": "stream.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "stream.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nuuid    = require \"node-uuid\"\r\n\r\n\r\nPreroller   = require \"./preroller\"\r\nRewind      = require \"../rewind_buffer\"\r\n\r\ndebug = require(\"debug\")(\"sm:slave:stream\")\r\n\r\n# Streams are the endpoints that listeners connect to.\r\n\r\n# On startup, a slave stream should connect to the master and start serving\r\n# live audio as quickly as possible. It should then try to load in any\r\n# Rewind buffer info available on the master.\r\n\r\nmodule.exports = class Stream extends require('../rewind_buffer')\r\n    constructor: (@core,@key,@log,opts) ->\r\n        # initialize RewindBuffer\r\n        super seconds: opts.seconds, burst:opts.burst\r\n        @opts = opts\r\n\r\n        @STATUS = \"Initializing\"\r\n\r\n        @StreamTitle  = @opts.metaTitle\r\n        @StreamUrl    = \"\"\r\n\r\n        # remove our max listener count\r\n        @setMaxListeners 0\r\n\r\n        @_id_increment = 1\r\n        @_lmeta = {}\r\n\r\n        @preroll = null\r\n        @mlog_timer = null\r\n\r\n        # -- Stats Counters -- #\r\n\r\n        @_totalConnections  = 0\r\n        @_totalKBytesSent   = 0\r\n\r\n        @metaFunc = (chunk) =>\r\n            @StreamTitle    = chunk.StreamTitle if chunk.StreamTitle\r\n            @StreamUrl      = chunk.StreamUrl if chunk.StreamUrl\r\n\r\n        @bufferFunc = (c) =>\r\n            @_insertBuffer(c)\r\n\r\n        @once \"source\", =>\r\n            @source.on \"meta\", @metaFunc\r\n            @source.on \"buffer\", @bufferFunc\r\n\r\n        # now run configure...\r\n        process.nextTick => @configure(@opts)\r\n\r\n\r\n        # -- Wait to Load Rewind Buffer -- #\r\n\r\n        @emit \"_source_waiting\"\r\n\r\n        @_sourceInitializing = true\r\n        @_sourceInitT = setTimeout =>\r\n            @_sourceInitializing = false\r\n            @emit \"_source_init\"\r\n            debug \"Sending _source_init after source timeout\"\r\n        , 15*1000\r\n\r\n        @once \"source\", (source) =>\r\n            debug \"Stream source is incoming.\"\r\n            clearTimeout @_sourceInitT\r\n            @_sourceInitializing = true\r\n            source.getRewind (err,stream,req) =>\r\n                if err\r\n                    @log.error \"Source getRewind encountered an error: #{err}\", error:err\r\n                    @_sourceInitializing = false\r\n                    @emit \"_source_init\"\r\n                    debug \"Sending _source_init after load error\"\r\n                    #@emit \"rewind_loaded\"\r\n\r\n                    return false\r\n\r\n                @loadBuffer stream, (err) =>\r\n                    @log.debug \"Slave source loaded rewind buffer.\"\r\n                    #req.end()\r\n\r\n                    @_sourceInitializing = false\r\n                    @emit \"_source_init\"\r\n                    debug \"Sending _source_init after load success\"\r\n                    #@emit \"rewind_loaded\"\r\n\r\n    #----------\r\n\r\n    status: ->\r\n        _.extend @_rStatus(),\r\n            key:            @key\r\n            listeners:      @listeners()\r\n            connections:    @_totalConnections\r\n            kbytes_sent:    @_totalKBytesSent\r\n\r\n    #----------\r\n\r\n    useSource: (source) ->\r\n        # short-circuit if this is already our source\r\n        return true if @source == source\r\n        \r\n        @log.debug \"Slave stream got source connection\"\r\n        @source = source\r\n        @emit \"source\", @source\r\n\r\n    #----------\r\n\r\n    getStreamKey: (cb) ->\r\n        # use manual stream key if provided as part of stream configuration,\r\n        # to allow for AAC stream keys that can't be pulled out of a header\r\n        if @opts.stream_key\r\n            cb @opts.stream_key\r\n        else\r\n            if @source\r\n                @source.getStreamKey cb\r\n            else\r\n                @once \"source\", =>\r\n                    @source.getStreamKey cb\r\n\r\n    #----------\r\n\r\n    _once_source_loaded: (cb) ->\r\n        if @_sourceInitializing\r\n            # wait for a source_init event\r\n            debug \"_once_source_loaded is waiting for _source_init\"\r\n            @once \"_source_init\", => cb?()\r\n\r\n        else\r\n            # send them on through\r\n            cb?()\r\n\r\n    #----------\r\n\r\n    configure: (@opts) ->\r\n\r\n        # -- Preroll -- #\r\n\r\n        @log.debug \"Preroll settings are \", preroll:@opts.preroll\r\n\r\n        if @opts.preroll? && @opts.preroll != \"\"\r\n            # create a Preroller connection\r\n            key = if (@opts.preroll_key && @opts.preroll_key != \"\") then @opts.preroll_key else @key\r\n\r\n            new Preroller @, key, @opts.preroll, @opts.transcoder, @opts.impression_delay, (err,pre) =>\r\n                if err\r\n                    @log.error \"Failed to create preroller: #{err}\"\r\n                    return false\r\n\r\n                @preroll = pre\r\n                @log.debug \"Preroller is created.\"\r\n\r\n        # -- Set up bufferSize poller -- #\r\n\r\n        # We disconnect clients that have fallen too far behind on their\r\n        # buffers. Buffer size can be configured via the \"max_buffer\" setting,\r\n        # which takes bits\r\n        @log.debug \"Stream's max buffer size is #{ @opts.max_buffer }\"\r\n\r\n        if @buf_timer\r\n            clearInterval @buf_timer\r\n            @buf_timer = null\r\n\r\n        @buf_timer = setInterval =>\r\n            all_buf = 0\r\n            for id,l of @_lmeta\r\n                all_buf += l.rewind._queuedBytes + l.obj.socket?.bufferSize\r\n\r\n                if (l.rewind._queuedBytes||0) + (l.obj.socket?.bufferSize||0) > @opts.max_buffer\r\n                    @log.debug \"Connection exceeded max buffer size.\", client:l.obj.client, bufferSize:l.rewind._queuedBytes\r\n                    l.obj.disconnect(true)\r\n\r\n            @log.debug \"All buffers: #{all_buf}\"\r\n        , 60*1000\r\n\r\n        # Update RewindBuffer settings\r\n        @setRewind @opts.seconds, @opts.burst\r\n\r\n        @emit \"config\"\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        # handle clearing out lmeta\r\n        l.obj.disconnect(true) for k,l of @_lmeta\r\n\r\n        if @buf_timer\r\n            clearInterval @buf_timer\r\n            @buf_timer = null\r\n\r\n        @source?.removeListener \"meta\", @metaFunc\r\n        @source?.removeListener \"buffer\", @bufferFunc\r\n        @source = null\r\n\r\n        @metaFunc = @bufferFunc = ->\r\n\r\n        super()\r\n\r\n        @emit \"disconnect\"\r\n\r\n        @removeAllListeners()\r\n\r\n    #----------\r\n\r\n    listeners: ->\r\n        _(@_lmeta).keys().length\r\n\r\n    #----------\r\n\r\n    listen: (obj,opts,cb) ->\r\n        # generate a metadata hash\r\n        lmeta =\r\n            id:         @_id_increment++\r\n            obj:        obj\r\n            startTime:  opts.startTime  || (new Date)\r\n\r\n        # each listen is a connection\r\n        @_totalConnections += 1\r\n\r\n        # inject stream config into our options\r\n        opts = _.extend { logInterval: @opts.log_interval }, opts\r\n\r\n        # don't ask for a rewinder while our source is going through init,\r\n        # since we don't want to fail an offset request that should be\r\n        # valid.\r\n        @_once_source_loaded =>\r\n            # get a rewinder (handles the actual broadcast)\r\n            @getRewinder lmeta.id, opts, (err,rewind,extra...) =>\r\n                if err\r\n                    cb? err, null\r\n                    return false\r\n\r\n                lmeta.rewind = rewind\r\n\r\n                # stash the object\r\n                @_lmeta[ lmeta.id ] = lmeta\r\n\r\n                # return the rewinder (so that they can change offsets, etc)\r\n                cb? null, lmeta.rewind, extra...\r\n\r\n    #----------\r\n\r\n    disconnectListener: (id) ->\r\n        if lmeta = @_lmeta[id]\r\n            # -- remove from listeners -- #\r\n            delete @_lmeta[id]\r\n\r\n            true\r\n        else\r\n            console.error \"disconnectListener called for #{id}, but no listener found.\"\r\n\r\n    #----------\r\n\r\n    # Log a partial listening segment\r\n    recordListen: (opts) ->\r\n        # temporary conversion support...\r\n        opts.kbytes = Math.floor( opts.bytes / 1024 ) if opts.bytes\r\n\r\n        @_totalKBytesSent += opts.kbytes if _.isNumber(opts.kbytes)\r\n\r\n        if lmeta = @_lmeta[opts.id]\r\n            @log.interaction \"\",\r\n                type:           \"listen\"\r\n                client:         lmeta.obj.client\r\n                time:           new Date()\r\n                kbytes:         opts.kbytes\r\n                duration:       opts.seconds\r\n                offsetSeconds:  opts.offsetSeconds\r\n                contentTime:    opts.contentTime\r\n\r\n    #----------\r\n\r\n    startSession: (client,cb) ->\r\n        @log.interaction \"\",\r\n            type:       \"session_start\"\r\n            client:     client\r\n            time:       new Date()\r\n            session_id: client.session_id\r\n\r\n        cb null, client.session_id\r\n\r\n    #----------\r\n\r\n    class @StreamGroup extends require(\"events\").EventEmitter\r\n        constructor: (@key,@log) ->\r\n            super()\r\n            @streams    = {}\r\n\r\n        #----------\r\n\r\n        addStream: (stream) ->\r\n            if !@streams[ stream.key ]\r\n                @log.debug \"SG #{@key}: Adding stream #{stream.key}\"\r\n\r\n                @streams[ stream.key ] = stream\r\n\r\n                # listen in case it goes away\r\n                delFunc = =>\r\n                    @log.debug \"SG #{@key}: Stream disconnected: #{ stream.key }\"\r\n                    delete @streams[ stream.key ]\r\n\r\n                stream.on \"disconnect\", delFunc\r\n\r\n                stream.on \"config\", =>\r\n                    delFunc() if stream.opts.group != @key\r\n\r\n        #----------\r\n\r\n        startSession: (client,cb) ->\r\n            @log.interaction \"\",\r\n                type:       \"session_start\"\r\n                client:     client\r\n                time:       new Date()\r\n                id:         client.session_id\r\n\r\n            cb null, client.session_id\r\n"
  ]
}