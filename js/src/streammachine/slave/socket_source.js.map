{
  "version": 3,
  "file": "socket_source.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "socket_source.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "http = require \"http\"\r\n\r\n# emulate a source connection, receiving data via sockets from our master server\r\n\r\nmodule.exports = class SocketSource extends require(\"events\").EventEmitter\r\n    constructor: (@slave,@stream) ->\r\n        super()\r\n\r\n        @log = @stream.log.child subcomponent:\"socket_source\"\r\n\r\n        @log.debug \"created SocketSource for #{@stream.key}\"\r\n\r\n        @slave.io.on \"audio:#{@stream.key}\", (chunk) =>\r\n            @emit \"data\", chunk\r\n\r\n        @slave.io.on \"hls_snapshot:#{@stream.key}\", (snapshot) =>\r\n            @emit \"hls_snapshot\", snapshot\r\n\r\n        @_streamKey = null\r\n\r\n        getVitals = (retries=0) =>\r\n            @slave.io.vitals @stream.key, (err,obj) =>\r\n                if err\r\n                    @log.error \"Failed to get vitals (#{retries} retries remaining): #{err}\"\r\n\r\n                    if retries > 0\r\n                        getVitals()\r\n\r\n                    return\r\n\r\n                @_streamKey = obj.streamKey\r\n                @_vitals    = obj\r\n                @emit \"vitals\", obj\r\n\r\n        getVitals 2\r\n\r\n        @stream.once \"disconnect\", =>\r\n            getVitals = ->\r\n            @disconnect()\r\n\r\n    #----------\r\n\r\n    vitals: (cb) ->\r\n        _vFunc = (v) =>\r\n            cb? null, v\r\n\r\n        if @_vitals\r\n            _vFunc @_vitals\r\n        else\r\n            @once \"vitals\", _vFunc\r\n\r\n    #----------\r\n\r\n    getStreamKey: (cb) ->\r\n        if @_streamKey\r\n            cb? @_streamKey\r\n        else\r\n            @once \"vitals\", => cb? @_streamKey\r\n\r\n    #----------\r\n\r\n    getHLSSnapshot: (cb) ->\r\n        @slave.io.hls_snapshot @stream.key, cb\r\n\r\n    #----------\r\n\r\n    getRewind: (cb) ->\r\n        # connect to the master's StreamTransport and ask for any rewind\r\n        # buffer that is available\r\n\r\n        gRT = setTimeout =>\r\n            @log.debug \"Failed to get rewind buffer response.\"\r\n            cb? \"Failed to get a rewind buffer response.\"\r\n        , 15000\r\n\r\n        # connect to: @master.options.host:@master.options.port\r\n\r\n        # GET request for rewind buffer\r\n        @log.debug \"Making Rewind Buffer request for #{@stream.key}\", sock_id:@slave.io.id\r\n        req = http.request\r\n            hostname:   @slave.io.io.io.opts.host\r\n            port:       @slave.io.io.io.opts.port\r\n            path:       \"/s/#{@stream.key}/rewind\"\r\n            headers:\r\n                'stream-slave-id':    @slave.io.id\r\n        , (res) =>\r\n            clearTimeout gRT\r\n\r\n            @log.debug \"Got Rewind response with status code of #{ res.statusCode }\"\r\n            if res.statusCode == 200\r\n                # emit a 'rewind' event with a callback to get the response\r\n                cb? null, res\r\n\r\n            else\r\n                cb? \"Rewind request got a non-500 response.\"\r\n\r\n        req.on \"error\", (err) =>\r\n            clearTimeout gRT\r\n\r\n            @log.debug \"Rewind request got error: #{err}\", error:err\r\n            cb? err\r\n\r\n        req.end()\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        @log.debug \"SocketSource disconnecting for #{@stream.key}\"\r\n\r\n        @stream = null\r\n"
  ]
}