{
  "version": 3,
  "file": "preroller.js",
  "sourceRoot": "../../../../src/streammachine/slave/",
  "sources": [
    "preroller.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "_       = require \"underscore\"\r\nhttp    = require \"http\"\r\nurl     = require \"url\"\r\nrequest = require \"request\"\r\nxmldom  = require \"xmldom\"\r\nxpath   = require \"xpath\"\r\nhttp    = require \"http\"\r\n\r\ndebug = require(\"debug\")(\"sm:slave:preroller\")\r\n\r\nmodule.exports = class Preroller\r\n    constructor: (@stream,@key,@uri,@transcode_uri,@impressionDelay,cb) ->\r\n        @_counter = 1\r\n        @_config = null\r\n\r\n        if !@uri || !@transcode_uri\r\n            return cb new Error(\"Preroller requires Ad URI and Transcoder URI\")\r\n\r\n        # FIXME: Make these configurable\r\n        @agent = new http.Agent #keepAlive:true, maxSockets:100\r\n\r\n        # -- need to look at the stream to get characteristics -- #\r\n\r\n        @stream.log.debug \"Preroller calling getStreamKey\"\r\n\r\n        @stream.getStreamKey (@streamKey) =>\r\n            @stream.log.debug \"Preroller: Stream key is #{@streamKey}. Ready to start serving.\"\r\n\r\n            @_config =\r\n                key:                @key\r\n                streamKey:          @streamKey\r\n                adURI:              @uri\r\n                transcodeURI:       @transcode_uri\r\n                impressionDelay:    @impressionDelay\r\n                timeout:            2*1000\r\n                agent:              @agent\r\n\r\n        cb? null, @\r\n\r\n    #----------\r\n\r\n    pump: (output,writer,cb) ->\r\n        cb = _.once(cb)\r\n        aborted = false\r\n        # short-circuit if our config isn't set\r\n        if !@_config\r\n            cb new Error(\"Preroll request without valid config.\")\r\n            return true\r\n\r\n        # short-circuit if the output has already disconnected\r\n        if output.disconnected\r\n            cb new Error(\"Preroll request got disconnected output.\")\r\n            return true\r\n\r\n        count = @_counter++\r\n\r\n        # -- create an ad request -- #\r\n\r\n        adreq = new Preroller.AdRequest output, writer, @_config, count, (err) =>\r\n            @stream.log.error err if err\r\n            cb()\r\n\r\n        adreq.on \"error\", (err) =>\r\n            @stream.log.error err\r\n\r\n    #----------\r\n\r\n    class @AdRequest extends require(\"events\").EventEmitter\r\n        constructor: (@output,@writer,@config,@count,@_cb) ->\r\n            super()\r\n\r\n            @_cb = _.once @_cb\r\n\r\n            @_aborted = false\r\n            @_pumping = false\r\n\r\n            @_adreq = null\r\n            @_treq  = null\r\n            @_tresp = null\r\n\r\n            @_impressionTimeout = null\r\n\r\n            # -- Set up an abort listener -- #\r\n\r\n            @_abortL = =>\r\n                @debug \"conn_pre_abort triggered\"\r\n                @_abort null\r\n\r\n            @output.once \"disconnect\", @_abortL\r\n\r\n            # -- Set up our ad URI -- #\r\n\r\n            @uri = @config.adURI\r\n                .replace(\"!KEY!\", @config.streamKey)\r\n                .replace(\"!IP!\", @output.client.ip)\r\n                .replace(\"!STREAM!\", @config.key)\r\n                .replace(\"!UA!\", encodeURIComponent(@output.client.ua))\r\n                .replace(\"!UUID!\", @output.client.session_id)\r\n\r\n            @debug \"Ad request URI is #{@uri}\"\r\n\r\n            # -- Set a timeout -- #\r\n\r\n            # If the preroll request can't be completed in time, abort and move on\r\n            @_timeout = setTimeout(=>\r\n                @debug \"Preroll request timed out.\"\r\n                @_abort()\r\n            , @config.timeout)\r\n\r\n            # -- Request an ad -- #\r\n\r\n            @_requestAd (err,@_ad) =>\r\n                return @_cleanup err if err\r\n\r\n                # Now that we have an ad object, we call the transcoder to\r\n                # get a version of the creative that is matched to our specs\r\n                @_requestCreative @_ad, (err) =>\r\n                    return @_cleanup err if err\r\n\r\n                    # if we didn't get an error, that means the creative was\r\n                    # successfully piped to our output. We should arm the\r\n                    # impression function\r\n                    @_armImpression @_ad\r\n\r\n                    # and trigger our callback\r\n                    @debug \"Ad request finished.\"\r\n                    @_cleanup null\r\n\r\n        #----------\r\n\r\n        # Request an ad from the ad server\r\n        _requestAd: (cb) ->\r\n            @_adreq = request.get @uri, (err,res,body) =>\r\n                return cb new Error \"Ad request returned error: #{err}\" if err\r\n\r\n                if res.statusCode == 200\r\n                    new Preroller.AdObject body, (err,obj) =>\r\n                        if err\r\n                            cb new Error \"Ad request was unsuccessful: #{err}\"\r\n                        else\r\n                            cb null, obj\r\n                else\r\n                    cb new Error \"Ad request returned non-200 response: #{body}\"\r\n\r\n        #----------\r\n\r\n        # Request transcoded creative from the transcoder\r\n        _requestCreative: (ad,cb) ->\r\n            if !ad.creativeURL\r\n                # if the ad doesn't have a creativeURL, just call back\r\n                # immediately with no error\r\n                return cb null\r\n\r\n            @debug \"Preparing transcoder request for #{ad.creativeURL} with key #{@config.streamKey}.\"\r\n\r\n            @_treq = request.get(uri:@config.transcodeURI, agent:@config.agent, qs:{ uri:ad.creativeURL, key:@config.streamKey })\r\n                .once \"response\", (@_tresp) =>\r\n                    @debug \"Transcoder response received: #{@_tresp.statusCode}\"\r\n\r\n                    if @_tresp.statusCode == 200\r\n                        @debug \"Piping tresp to writer\"\r\n                        @_tresp.pipe(@writer,end:false)\r\n                        @_tresp.once \"end\", =>\r\n                            @debug \"Transcoder sent #{ @_tresp?.socket?.bytesRead || \"UNKNOWN\" } bytes\"\r\n                            #@debug \"Writable state is \", @writer._writableState\r\n\r\n                            if !@_aborted\r\n                                @debug \"Transcoder pipe completed successfully.\"\r\n\r\n                                cb null\r\n\r\n                    else\r\n                        cb new Error \"Non-200 response from transcoder.\"\r\n                .once \"error\", (err) =>\r\n                    cb new Error \"Transcoder request error: #{err}\"\r\n\r\n        #----------\r\n\r\n        _armImpression: (ad) ->\r\n            @_impressionTimeout = setTimeout =>\r\n                @output.removeListener \"disconnect\", disarm\r\n\r\n                process.nextTick ->\r\n                    disarm = null\r\n                    @_impressionTimeout = null\r\n\r\n                if ad.impressionURL\r\n                   request.get ad.impressionURL, (err,resp,body) =>\r\n                       if err\r\n                           @emit \"error\", new Error \"Failed to hit impression URL #{ad.impressionURL}: #{err}\"\r\n                       else\r\n                           @debug \"Impression URL hit successfully for #{@output.client.session_id}.\"\r\n                else\r\n                   @debug \"No impression URL found.\"\r\n\r\n            , @config.impressionDelay\r\n\r\n            @debug \"Arming impression for #{@config.impressionDelay}ms\"\r\n\r\n            # -- impression abort -- #\r\n\r\n            disarm = =>\r\n                @debug \"Disarming impression after early abort.\"\r\n                clearTimeout @_impressionTimeout if @_impressionTimeout\r\n\r\n            @output.once \"disconnect\", disarm\r\n\r\n        #----------\r\n\r\n        debug: (msg,args...) ->\r\n            debug \"#{@count}: \" + msg, args...\r\n\r\n        #----------\r\n\r\n        _abort: (err) ->\r\n            @_aborted = true\r\n\r\n            # abort any existing requests\r\n            @_adreq?.abort()\r\n            @_treq?.abort()\r\n\r\n            # make sure we don't write any more\r\n            @_tresp?.unpipe()\r\n\r\n            @_cleanup err\r\n\r\n\r\n        _cleanup: (err) ->\r\n            @debug \"In _cleanup: #{err}\"\r\n            clearTimeout @_timeout if @_timeout\r\n            @output.removeListener \"disconnect\", @_abortL\r\n            @_cb err\r\n\r\n    #----------\r\n\r\n    class @AdObject\r\n        constructor: (xmldoc,cb) ->\r\n            @creativeURL    = null\r\n            @impressionURL  = null\r\n\r\n            @doc            = null\r\n\r\n            debug \"Parsing ad object XML\"\r\n\r\n            doc = new xmldom.DOMParser().parseFromString(xmldoc)\r\n\r\n            debug \"XML doc parsed.\"\r\n\r\n            # -- VAST Support -- #\r\n\r\n            if wrapper = xpath.select(\"/VAST\",doc)?[0]\r\n                debug \"VAST wrapper detected\"\r\n\r\n                if ad = xpath.select(\"Ad/InLine\",wrapper)?[0]\r\n                    debug \"Ad document found.\"\r\n\r\n                    # find our linear creative\r\n                    if creative = xpath.select(\"./Creatives/Creative/Linear\",ad)?[0]\r\n\r\n                        # find the mpeg mediafile\r\n                        if mediafile = xpath.select(\"string(./MediaFiles/MediaFile[@type='audio/mpeg']/text())\",creative)\r\n                            debug \"MP3 Media File is #{mediafile}\"\r\n                            @creativeURL = mediafile\r\n                        else if mediafile = xpath.select(\"string(./MediaFiles/MediaFile[@type='audio/mp4']/text())\",creative)\r\n                            debug \"MP4 Media File is #{mediafile}\"\r\n                            @creativeURL = mediafile\r\n                        else if mediafile = xpath.select(\"string(./MediaFiles/MediaFile[@type='audio/aac']/text())\",creative)\r\n                            debug \"AAC Media File is #{mediafile}\"\r\n                            @creativeURL = mediafile\r\n\r\n                    # find the impression URL\r\n                    if impression = xpath.select(\"string(./Impression/text())\",ad)\r\n                        debug \"Impression URL is #{impression}\"\r\n                        @impressionURL = impression\r\n\r\n                    return cb null, @\r\n\r\n                else\r\n                    # VAST wrapper but no ad\r\n                    return cb null, null\r\n\r\n            # -- DAAST Support -- #\r\n\r\n            if wrapper = xpath.select(\"/DAAST\",doc)?[0]\r\n                debug \"DAAST wrapper detected\"\r\n\r\n                if ad = xpath.select(\"Ad/InLine\",wrapper)?[0]\r\n                    debug \"Ad document found.\"\r\n\r\n                    # find our linear creative\r\n                    if creative = xpath.select(\"./Creatives/Creative/Linear\",ad)?[0]\r\n\r\n                        # find the mpeg mediafile\r\n                        if mediafile = xpath.select(\"string(./MediaFiles/MediaFile[@type='audio/mpeg']/text())\",creative)\r\n                            debug \"MP3 Media File is #{mediafile}\"\r\n                            @creativeURL = mediafile\r\n                        else if mediafile = xpath.select(\"string(./MediaFiles/MediaFile[@type='audio/mp4']/text())\",creative)\r\n                            debug \"MP4 Media File is #{mediafile}\"\r\n                            @creativeURL = mediafile\r\n\r\n\r\n                    # find the impression URL\r\n                    if impression = xpath.select(\"string(./Impression/text())\",ad)\r\n                        debug \"Impression URL is #{impression}\"\r\n                        @impressionURL = impression\r\n\r\n                    return cb null, @\r\n\r\n                else\r\n                    # DAAST wrapper but no ad\r\n\r\n                    # Is there an error element? If so, we're supposed to hit\r\n                    # it as our impression URL\r\n                    if error = xpath.select(\"string(./Error/text())\",wrapper)\r\n                        debug \"Error URL found: #{error}\"\r\n                        @impressionURL = error\r\n\r\n                        # for a no ad error url, look for an [ERRORCODE] macro\r\n                        # and replace it with 303, because DAAST says so\r\n\r\n                        # FIXME: Technically, I think this response is intended\r\n                        # for the case where we had a wrapper and hit that URL\r\n                        # but got no response. We don't support that case yet,\r\n                        # but I think it's ok to send 303 here\r\n\r\n                        @impressionURL = @impressionURL.replace(\"[ERRORCODE]\",303)\r\n\r\n                        return cb null, @\r\n\r\n                    else\r\n                        return cb null, null\r\n\r\n            cb new Error \"Unsupported ad format\"\r\n\r\n"
  ]
}