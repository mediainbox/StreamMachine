{
  "version": 3,
  "file": "base.js",
  "sourceRoot": "../../../../src/streammachine/sources/",
  "sources": [
    "base.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "uuid = require \"node-uuid\"\r\nnconf = require \"nconf\"\r\n\r\nFrameChunker = require \"./_frame_chunker\"\r\nDebounce = require \"../util/debounce\"\r\n\r\nmodule.exports = class Source extends require(\"events\").EventEmitter\r\n\r\n    #----------\r\n\r\n    constructor: (source_opts={}) ->\r\n        super()\r\n\r\n        @uuid = @opts.uuid || uuid.v4()\r\n\r\n        @connectedAt = @opts.connectedAt || new Date()\r\n\r\n        @_shouldHandoff = false\r\n\r\n        @_isDisconnected = false\r\n\r\n        @isFallback = false\r\n        @streamKey  = null\r\n        @_vitals    = null\r\n\r\n        @_chunk_queue = []\r\n        @_chunk_queue_ts = null\r\n\r\n        # How often will we emit chunks of data? The default is set in StreamMachine.Defaults\r\n\r\n        @emitDuration = @opts.chunkDuration || ( nconf.get(\"chunk_duration\") && Number(nconf.get(\"chunk_duration\")) ) || 0.5\r\n\r\n        @log = @opts.logger?.child uuid:@uuid\r\n\r\n        if source_opts.useHeartbeat\r\n            # -- Alert if data stops flowing -- #\r\n\r\n            # creates a sort of dead mans switch that we use to kill the connection\r\n            # if it stops sending data\r\n\r\n            @_pingData = new Debounce @opts.heartbeatTimeout || 30*1000, (last_ts) =>\r\n                if !@_isDisconnected\r\n                    # data has stopped flowing. kill the connection.\r\n                    @log?.info \"Source data stopped flowing.  Killing connection.\"\r\n                    @emit \"_source_dead\", last_ts, Number(new Date())\r\n                    @disconnect()\r\n\r\n        if !source_opts.skipParser\r\n            @parserConstructor = require \"../parsers/#{@opts.format}\"\r\n\r\n    #----------\r\n    \r\n    createParser: ->\r\n        @log?.debug \"Creating #{@opts.format} frames parser\"\r\n\r\n        # -- Turns data frames into chunks -- #\r\n        @chunker = new FrameChunker @emitDuration * 1000\r\n        \r\n        @parser = new @parserConstructor\r\n\r\n        # -- Pull vitals from first header -- #\r\n        @parser.once \"header\", (header) =>\r\n            # -- compute frames per second and stream key -- #\r\n            @framesPerSec   = header.frames_per_sec\r\n            @streamKey      = header.stream_key\r\n\r\n            @log?.debug \"setting framesPerSec to \", frames:@framesPerSec\r\n            @log?.debug \"first header is \", header\r\n\r\n            # -- send out our stream vitals -- #\r\n\r\n            @_setVitals\r\n                streamKey:          @streamKey\r\n                framesPerSec:       @framesPerSec\r\n                emitDuration:       @emitDuration\r\n\r\n        @parser.on \"frame\", (frame,header) =>\r\n            @_pingData?.ping() # heartbeat?\r\n            @chunker.write frame:frame, header:header\r\n\r\n        @chunker.on \"readable\", =>\r\n            while chunk = @chunker.read()\r\n                @emit \"_chunk\", chunk\r\n\r\n    #----------\r\n\r\n    getStreamKey: (cb) ->\r\n        if @streamKey\r\n            cb? @streamKey\r\n        else\r\n            @once \"vitals\", => cb? @_vitals.streamKey\r\n\r\n    #----------\r\n\r\n    _setVitals: (vitals) ->\r\n        @_vitals = vitals\r\n        @emit \"vitals\", @_vitals\r\n\r\n    #----------\r\n\r\n    vitals: (cb) ->\r\n        _vFunc = (v) =>\r\n            cb? null, v\r\n\r\n        if @_vitals\r\n            _vFunc @_vitals\r\n        else\r\n            @once \"vitals\", _vFunc\r\n\r\n    #----------\r\n\r\n    disconnect: (cb) ->\r\n        @log?.debug \"Setting _isDisconnected\"\r\n        @_isDisconnected = true\r\n        @chunker?.removeAllListeners()\r\n        @parser?.removeAllListeners()\r\n        @_pingData?.kill()\r\n\r\n    #----------\r\n\r\n"
  ]
}