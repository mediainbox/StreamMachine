{
  "version": 3,
  "file": "_frame_chunker.js",
  "sourceRoot": "../../../../../src/streammachine/sources/base/",
  "sources": [
    "_frame_chunker.coffee"
  ],
  "names": [],
  "mappings": "AAAA,IAAA,YAAA,EAAA;;AAAA,SAAA,GAAY,OAAA,CAAQ,QAAR,CAAiB,CAAC;;AAE9B,MAAM,CAAC,OAAP,GAAuB,eAAN,MAAA,aAAA,QAA2B,UAA3B;EAEb,WAAa,UAAA,gBAA2B,IAAI,IAAJ,CAAA,CAA3B,CAAA;;;;IAAC,IAAC,CAAA;IAAU,IAAC,CAAA;IAGtB,IAAC,CAAA,YAAD,GAAgB;IAChB,IAAC,CAAA,eAAD,GAAmB;IACnB,IAAC,CAAA,WAAD,GAAe;IAEf,IAAC,CAAA,OAAD,GAAW,IAAC,CAAA;IAEZ,IAAC,CAAA,QAAD,GAAY;EATH,CAAjB;;;EAcI,SAAW,CAAC,EAAD,CAAA;IACP,IAAC,CAAA,QAAD,GAAY;IACZ,IAAC,CAAA,WAAD,GAAe;WACf,IAAC,CAAA,WAAD,GAAe;EAHR,CAdf;;;EAqBI,UAAY,CAAC,GAAD,EAAM,QAAN,EAAgB,EAAhB,CAAA;AAChB,QAAA,GAAA,EAAA,QAAA,EAAA,MAAA,EAAA,CAAA,EAAA,GAAA,EAAA,IAAA,EAAA,CAAA,EAAA,GAAA,EAAA,UAAA,EAAA,UAAA,EAAA;IAAQ,IAAC,CAAA,YAAY,CAAC,IAAd,CAAmB,GAAnB;IACA,IAAC,CAAA,eAAD,IAAoB,GAAG,CAAC,MAAM,CAAC;IAE/B,IAAG,IAAC,CAAA,eAAD,GAAmB,IAAC,CAAA,OAAvB;;MAGI,IAAC,CAAA,OAAD,GAAW,IAAC,CAAA,OAAD,GAAW,CAAC,IAAC,CAAA,QAAD,GAAY,IAAC,CAAA,eAAd,EADlC;;MAIY,GAAA,GAAM;AACN;MAAA,KAAA,uCAAA;;QAAA,GAAA,IAAO,CAAC,CAAC,KAAK,CAAC;MAAf,CALZ;;MAQY,MAAA,GAAS,IAAC,CAAA,YAAY,CAAC,OARnC;;MAWY,GAAA,GAAM,MAAM,CAAC,MAAP;;AAAe;AAAA;QAAA,KAAA,wCAAA;;uBAAA,CAAC,CAAC;QAAF,CAAA;;mBAAf;MAEN,QAAA,GAAW,IAAC,CAAA,gBAbxB;;MAgBY,IAAC,CAAA,YAAY,CAAC,MAAd,GAAuB;MACvB,IAAC,CAAA,eAAD,GAAmB,EAjB/B;;;MAsBY,UAAA,GAAa,IAAI,CAAC,KAAL,CAAW,QAAX;MACb,IAAC,CAAA,WAAD,IAAgB,QAAA,GAAW;MAE3B,IAAG,IAAC,CAAA,WAAD,GAAe,CAAlB;QACI,UAAA,GAAa,IAAI,CAAC,KAAL,CAAW,IAAC,CAAA,WAAZ;QACb,IAAC,CAAA,WAAD,GAAe,IAAC,CAAA,WAAD,GAAe;QAC9B,UAAA,IAAc,WAHlB;;MAKA,EAAA,GACO,IAAC,CAAA,QAAJ,GACI,IAAI,IAAJ,CAAS,MAAA,CAAO,IAAC,CAAA,QAAR,CAAA,GAAoB,UAA7B,CADJ,GAGI,IAAC,CAAA;MAET,IAAC,CAAA,QAAD,GAAY;MAEZ,IAAC,CAAA,IAAD,CACI;QAAA,IAAA,EAAM,GAAN;QACA,EAAA,EAAI,EADJ;QAEA,QAAA,EAAU,QAFV;QAGA,MAAA,EAAQ,MAHR;QAIA,SAAA,EAAW,GAAG,CAAC,MAAM,CAAC;MAJtB,CADJ,EAxCJ;;WA+CA,EAAA,CAAA;EAnDQ;;AAvBC",
  "sourcesContent": [
    "Transform = require(\"stream\").Transform\r\n\r\nmodule.exports = class FrameChunker extends Transform\r\n\r\n    constructor: (@duration, @initialTime = new Date()) ->\r\n        super objectMode: true\r\n\r\n        @_chunk_queue = []\r\n        @_queue_duration = 0\r\n        @_remainders = 0\r\n\r\n        @_target = @duration\r\n\r\n        @_last_ts = null\r\n\r\n\r\n#----------\r\n\r\n    resetTime: (ts) ->\r\n        @_last_ts = null\r\n        @_remainders = 0\r\n        @initialTime = ts\r\n\r\n#----------\r\n\r\n    _transform: (obj, encoding, cb) ->\r\n        @_chunk_queue.push obj\r\n        @_queue_duration += obj.header.duration\r\n\r\n        if @_queue_duration > @_target\r\n\r\n            # reset our target for the next chunk\r\n            @_target = @_target + (@duration - @_queue_duration)\r\n\r\n            # what's the total data length?\r\n            len = 0\r\n            len += o.frame.length for o in @_chunk_queue\r\n\r\n            # how many frames?\r\n            frames = @_chunk_queue.length\r\n\r\n            # make one buffer\r\n            buf = Buffer.concat (o.frame for o in @_chunk_queue)\r\n\r\n            duration = @_queue_duration\r\n\r\n            # reset queue\r\n            @_chunk_queue.length = 0\r\n            @_queue_duration = 0\r\n\r\n            # what's the timestamp for this chunk? If it seems reasonable\r\n            # to attach it to the last chunk, let's do so.\r\n\r\n            simple_dur = Math.floor(duration)\r\n            @_remainders += duration - simple_dur\r\n\r\n            if @_remainders > 1\r\n                simple_rem = Math.floor(@_remainders)\r\n                @_remainders = @_remainders - simple_rem\r\n                simple_dur += simple_rem\r\n\r\n            ts =\r\n                if @_last_ts\r\n                    new Date(Number(@_last_ts) + simple_dur)\r\n                else\r\n                    @initialTime\r\n\r\n            @_last_ts = ts\r\n\r\n            @push\r\n                data: buf\r\n                ts: ts\r\n                duration: duration\r\n                frames: frames\r\n                streamKey: obj.header.stream_key\r\n\r\n        cb()\r\n"
  ]
}