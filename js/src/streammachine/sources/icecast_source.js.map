{
  "version": 3,
  "file": "icecast_source.js",
  "sourceRoot": "../../../../src/streammachine/sources/",
  "sources": [
    "icecast_source.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "module.exports = class IcecastSource extends require(\"./base/base_source\")\r\n    TYPE: -> \"Icecast (#{[@opts.source_ip,@opts.sock.remotePort].join(\":\")})\"\r\n    HANDOFF_TYPE: \"icecast\"\r\n\r\n    # opts should include:\r\n    # format:   Format for Parser (aac or mp3)\r\n    # sock:     Socket for incoming data\r\n    # headers:  Headers from the source request\r\n    # uuid:     Source UUID, if this is a handoff source (optional)\r\n    # logger:   Logger (optional)\r\n    constructor: (opts) ->\r\n        super opts, useHeartbeat:true\r\n\r\n        @_shouldHandoff = true\r\n\r\n        # data is going to start streaming in as data on req. We need to pipe\r\n        # it into a parser to turn it into frames, headers, etc\r\n\r\n        @log?.debug \"New Icecast source.\"\r\n\r\n        @_vtimeout = setTimeout =>\r\n            @log?.error \"Failed to get source vitals before timeout. Forcing disconnect.\"\r\n            @disconnect()\r\n        , 3000\r\n\r\n        @once \"vitals\", =>\r\n            @log?.debug \"Vitals parsed for source.\"\r\n            clearTimeout @_vtimeout\r\n            @_vtimeout = null\r\n\r\n        @createParser()\r\n\r\n        # incoming -> Parser\r\n        @opts.sock.pipe @parser\r\n\r\n        @last_ts = null\r\n\r\n        # outgoing -> Stream\r\n        @on \"_chunk\", (chunk) ->\r\n            @last_ts = chunk.ts\r\n            @emit \"data\", chunk\r\n\r\n        @opts.sock.on \"close\", =>\r\n            @log?.debug \"Icecast source got close event\"\r\n            @disconnect()\r\n\r\n        @opts.sock.on \"end\", =>\r\n            @log?.debug \"Icecast source got end event\"\r\n            @disconnect()\r\n\r\n        # return with success\r\n        @connected = true\r\n\r\n    #----------\r\n\r\n    status: ->\r\n        source:         @TYPE?() ? @TYPE\r\n        connected:      @connected\r\n        url:            [@opts.source_ip,@opts.sock.remotePort].join(\":\")\r\n        streamKey:      @streamKey\r\n        uuid:           @uuid\r\n        last_ts:        @last_ts\r\n        connected_at:   @connectedAt\r\n\r\n    #----------\r\n\r\n    disconnect: ->\r\n        if @connected\r\n            super()\r\n\r\n            clearTimeout @_vtimeout if @_vtimeout\r\n\r\n            @opts.sock.destroy()\r\n            @opts.sock.removeAllListeners()\r\n            @connected = false\r\n            @emit \"disconnect\"\r\n\r\n            @removeAllListeners()\r\n"
  ]
}