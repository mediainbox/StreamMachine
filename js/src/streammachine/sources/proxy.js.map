{
  "version": 3,
  "file": "proxy.js",
  "sourceRoot": "../../../../src/streammachine/sources/",
  "sources": [
    "proxy.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "Icy     = require 'icy'\r\nutil    = require 'util'\r\nurl     = require 'url'\r\ndomain  = require \"domain\"\r\nmoment  = require \"moment\"\r\n_       = require \"underscore\"\r\n\r\ndebug   = require(\"debug\")(\"sm:sources:proxy\")\r\n\r\nmodule.exports = class ProxySource extends require(\"./base\")\r\n    TYPE: -> \"Proxy (#{@url})\"\r\n\r\n    # opts should include:\r\n    # format:   Format for Parser (aac or mp3)\r\n    # url:      URL for original stream\r\n    # fallback: Should we set the isFallback flag? (default false)\r\n    # logger:   Logger (optional)\r\n    constructor: (opts) ->\r\n        super opts, useHeartbeat:false\r\n\r\n        @url = @opts.url\r\n\r\n        debug \"ProxySource created for #{@url}\"\r\n\r\n        @isFallback     = @opts.fallback or false\r\n\r\n        @defaultHeaders = @opts.headers or \"user-agent\": \"StreamMachine 0.1.0\"\r\n\r\n        @connected      = false\r\n        @framesPerSec   = null\r\n        @connected_at   = null\r\n        @chunksCount = 0\r\n\r\n        @_in_disconnect = false\r\n\r\n        # connection drop handling\r\n        # (FIXME: bouncing not yet implemented)\r\n        @_maxBounces    = 10\r\n        @_bounces       = 0\r\n        @_bounceInt     = 5\r\n\r\n        @StreamTitle    = null\r\n        @StreamUrl      = null\r\n\r\n        @d = domain.create()\r\n\r\n        @d.on \"error\", (err) =>\r\n            @_niceError err\r\n\r\n        @d.run =>\r\n            @connect()\r\n\r\n    #----------\r\n\r\n    _niceError: (err) =>\r\n        debug \"Caught error: #{err}\", err.stack\r\n        nice_err = switch err.syscall\r\n            when \"getaddrinfo\"\r\n                \"Unable to look up DNS for Icecast proxy\"\r\n            when \"connect\"\r\n                \"Unable to connect to Icecast proxy. Connection Refused\"\r\n            else\r\n                \"Error making connection to Icecast proxy\"\r\n\r\n        @log?.error \"ProxySource encountered an error: #{nice_err}\", err\r\n\r\n    #----------\r\n\r\n    status: =>\r\n        source:         @TYPE?() ? @TYPE\r\n        connected:      @connected\r\n        url:            @url\r\n        streamKey:      @streamKey\r\n        uuid:           @uuid\r\n        isFallback:     @isFallback\r\n        last_ts:        @last_ts\r\n        connected_at:   @connected_at\r\n\r\n\r\n    #----------\r\n\r\n    connect: =>\r\n        @createParser()\r\n\r\n        debug \"Begin connection to Icecast from #{@url}\"\r\n\r\n        url_opts = url.parse @url\r\n        url_opts.headers = _.clone @defaultHeaders\r\n\r\n        @last_ts = null\r\n        @chunker.resetTime new Date()\r\n\r\n        @ireq = Icy.get url_opts, (ice) =>\r\n            debug \"Connected to Icecast from #{@url}\"\r\n\r\n            if ice.statusCode == 302\r\n                @url = ice.headers.location\r\n\r\n            @icecast = ice\r\n\r\n            @icecast.once \"end\", =>\r\n                debug \"Received Icecast END event\"\r\n                @reconnect()\r\n\r\n            @icecast.once \"close\", =>\r\n                debug \"Received Icecast CLOSE event\"\r\n                @reconnect()\r\n\r\n            @icecast.on \"metadata\", (data) =>\r\n                debug \"Received Icecast METADATA event\"\r\n\r\n                unless @_in_disconnect\r\n                    meta = Icy.parse(data)\r\n\r\n                    if meta.StreamTitle\r\n                        @StreamTitle = meta.StreamTitle\r\n\r\n                    if meta.StreamUrl\r\n                        @StreamUrl = meta.StreamUrl\r\n\r\n                    @emit \"metadata\", StreamTitle:@StreamTitle||\"\", StreamUrl:@StreamUrl||\"\"\r\n\r\n            # incoming -> Parser\r\n            @icecast.on \"data\", (chunk) =>\r\n                @parser.write chunk\r\n\r\n            # return with success\r\n            @connected = true\r\n            @connected_at = new Date()\r\n            @emit \"connect\"\r\n\r\n            setTimeout @checkStatus, 30000\r\n\r\n        @ireq.once \"error\", (err) =>\r\n            debug \"Got icecast stream error #{err}, reconnecting\"\r\n            @_niceError err\r\n            @reconnect(true)\r\n\r\n        # outgoing -> Stream\r\n        @on \"_chunk\", @broadcastData\r\n\r\n        @logChunk = _.throttle(@_logChunk.bind(this), 5000)\r\n        @on \"_chunk\", @logChunk\r\n\r\n    #----------\r\n\r\n    broadcastData: (chunk) =>\r\n        @chunksCount++\r\n        @last_ts = chunk.ts\r\n        @emit \"data\", chunk\r\n\r\n    #----------\r\n\r\n    _logChunk: (chunk) =>\r\n        debug \"received chunk from parser (time: #{chunk.ts.toISOString().substr(11)}, total: #{@chunksCount})\"\r\n\r\n\r\n    #----------\r\n\r\n    checkStatus: =>\r\n        if not @connected\r\n            debug \"Check status: not connected, skipping\"\r\n            return\r\n\r\n        debug \"Check status: last chunk timestamp is #{@last_ts}\"\r\n\r\n        unless @last_ts\r\n            return setTimeout @checkStatus, 5000\r\n\r\n        if moment(@last_ts).isBefore(moment().subtract(1, \"minutes\"))\r\n            debug \"Check status: last chunk timestamp is older than 1 minute ago, reconnecting\"\r\n            return @reconnect()\r\n\r\n        setTimeout @checkStatus, 30000\r\n\r\n    #----------\r\n\r\n    reconnect: (ignoreConnectionStatus = false) =>\r\n        # Ignore reconnection if there is an active connection or the \"ignore status\" flag given is false\r\n        if !@connected && !ignoreConnectionStatus\r\n          return\r\n\r\n        msWaitToConnect = 5000\r\n        debug \"Reconnect to Icecast source from #{@url} in #{msWaitToConnect}ms\"\r\n\r\n        @connected = false\r\n\r\n        # Clean proxy listeners\r\n        @chunksCount = 0\r\n        @removeListener \"_chunk\", @broadcastData\r\n        @removeListener \"_chunk\", @logChunk\r\n\r\n        # Clean icecast\r\n        @ireq?.end()\r\n        @ireq?.res?.client.destroy()\r\n        @icecast?.removeAllListeners()\r\n        @icecast = null\r\n        @ireq = null\r\n\r\n        @parser = null\r\n        @chunker = null\r\n\r\n        setTimeout @connect, msWaitToConnect\r\n"
  ]
}