{
  "version": 3,
  "file": "icecast_source.js",
  "sourceRoot": "../../util/",
  "sources": [
    "icecast_source.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "fs          = require \"fs\"\r\npath        = require \"path\"\r\nnet = require \"net\"\r\nThrottle    = require \"throttle\"\r\n\r\n@args = require(\"optimist\")\r\n    .usage(\"Usage: $0 --host localhost --port 8001 --stream foo --password abc123 [file]\")\r\n    .describe\r\n        host:       \"Server\"\r\n        port:       \"Server source port\"\r\n        stream:     \"Stream key\"\r\n        password:   \"Stream password\"\r\n        rate:       \"Throttle rate for streaming\"\r\n    .default\r\n        rate:       32000\r\n    .demand(\"host\",\"port\",\"stream\")\r\n    .argv\r\n\r\n# -- Looping Source -- #\r\n\r\nclass LoopingSource extends require('stream').Duplex\r\n    constructor: (opts) ->\r\n        super opts\r\n\r\n        @_reading = false\r\n\r\n        @_data = Buffer.alloc 0\r\n        @_readPos = 0\r\n\r\n\r\n    #----------\r\n\r\n    _write: (chunk,encoding,cb) ->\r\n        buf = Buffer.concat([@_data,chunk])\r\n        @_data = buf\r\n        console.log \"_data length is now \", @_data.length\r\n        @emit \"readable\" if !@reading\r\n        cb()\r\n\r\n    #----------\r\n\r\n    _read: (size) ->\r\n        if @_reading\r\n            console.log \"_read while reading\"\r\n            return true\r\n\r\n        if @_data.length == 0\r\n            @push ''\r\n            return true\r\n\r\n        @_reading = true\r\n\r\n        rFunc = =>\r\n            remaining = Math.min (@_data.length - @_readPos), size\r\n\r\n            console.log \"reading from #{ @_readPos } with #{ remaining }\"\r\n            buf = Buffer.from remaining\r\n            @_data.copy buf, 0, @_readPos, @_readPos.remaining\r\n\r\n            @_readPos = @_readPos + remaining\r\n\r\n            if @_readPos >= @_data.length\r\n                @_readPos = 0\r\n\r\n            console.log \"pushing buffer of #{ buf.length }\"\r\n            if @push buf, 'binary'\r\n                rFunc()\r\n            else\r\n                @_reading = false\r\n\r\n        rFunc()\r\n\r\n# -- Make sure they gave us a file -- #\r\n\r\nfilepath = @args._?[0]\r\n\r\nif !filepath\r\n    console.error \"A file path is required.\"\r\n    process.exit(1)\r\n\r\nfilepath = path.resolve(filepath)\r\n\r\nif !fs.existsSync(filepath)\r\n    console.error \"File not found.\"\r\n    process.exit(1)\r\n\r\nconsole.log \"file is \", filepath\r\n\r\n# -- Read the file -- #\r\n\r\nlsource = new LoopingSource\r\nthrottle = new Throttle @args.rate\r\nfile = fs.createReadStream filepath\r\nfile.pipe lsource\r\nlsource.pipe throttle\r\n\r\n# -- Open our connection to the server -- #\r\n\r\nsock = net.connect @args.port, @args.host, =>\r\n    console.log \"Connected!\"\r\n\r\n    authTimeout = null\r\n\r\n    # we really only care about the first thing we see\r\n    sock.once \"readable\", =>\r\n        resp = sock.read()\r\n\r\n        if /^HTTP\\/1\\.0 200 OK/.test(resp.toString())\r\n            console.log \"Got HTTP OK. Starting streaming.\"\r\n\r\n            clearTimeout authTimeout\r\n            throttle.pipe(sock)\r\n\r\n        else\r\n            console.error \"Unknown response: #{ resp.toString() }\"\r\n            process.exit(1)\r\n\r\n    sock.write \"SOURCE /#{@args.stream} ICE/1.0\\r\\n\"\r\n\r\n    if @args.password\r\n        # username doesn't matter.\r\n        auth = Buffer.from(\"source:#{@args.password}\",'ascii').toString(\"base64\")\r\n        sock.write \"Authorization: basic #{auth}\\r\\n\\r\\n\"\r\n        console.log \"Writing auth with #{ auth }.\"\r\n\r\n    authTimeout = setTimeout =>\r\n        console.error \"Timed out waiting for authentication.\"\r\n        process.exit(1)\r\n    , 5000\r\n\r\nsock.on \"error\", (err) =>\r\n    console.error \"Socket error: #{err}\"\r\n    process.exit(1)\r\n\r\n\r\n"
  ]
}