{
  "version": 3,
  "file": "streamer.js",
  "sourceRoot": "../",
  "sources": [
    "streamer.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "process.env.NEW_RELIC_NO_CONFIG_FILE = 'true';\r\n\r\nif !process.env.NEW_RELIC_APP_NAME ||!process.env.NEW_RELIC_LICENSE_KEY\r\n    console.log('[integrations] skipping NewRelic, missing NEW_RELIC_APP_NAME or NEW_RELIC_LICENSE_KEY env vars')\r\nelse\r\n    console.log('[integrations] loading NewRelic')\r\n    require('newrelic')\r\n\r\n\r\nrequire('@google-cloud/trace-agent').start\r\n    projectId: process.env.GCLOUD_PROJECT\r\n    keyFilename: process.env.GCLOUD_KEY_FILENAME\r\n\r\n#require('@google-cloud/debug-agent').start\r\n#    projectId: process.env.GCLOUD_PROJECT\r\n#    keyFilename: process.env.GCLOUD_KEY_FILENAME\r\n\r\n_ = require \"underscore\"\r\nnconf = require \"nconf\"\r\nrequest = require \"request\"\r\ndebug = require(\"debug\") \"sm:master:streamer\"\r\n\r\nclass Streamer\r\n    constructor: (@config) ->\r\n        @mode = nconf.get(\"mode\") or \"standalone\"\r\n        debug \"Streamer created in mode #{@mode.toUpperCase()}\"\r\n\r\n    #----------\r\n\r\n    initialize: () ->\r\n        @getRadio (radio) =>\r\n            @ping()\r\n            @createStreamMachine radio\r\n\r\n    #----------\r\n\r\n    getRadio: (callback) ->\r\n        debug \"Fetch radio config from #{@config.uri}\"\r\n        request.get(@config.uri,\r\n            json: true,\r\n            qs: ping: @mode\r\n        , (error, response, body) =>\r\n            if error\r\n                debug error\r\n                debug \"Error ocurred, retrying\"\r\n                return @retry callback\r\n            if not body\r\n                debug \"No radio available, retrying\"\r\n                return @retry callback\r\n            debug \"Fetched radio config successfully\"\r\n            callback body\r\n        )\r\n\r\n    #----------\r\n\r\n    retry: (callback) ->\r\n        setTimeout () =>\r\n            debug \"Retry\"\r\n            @getRadio callback\r\n        , @config.ping / 2\r\n\r\n    #----------\r\n\r\n    createStreamMachine: (@radio) ->\r\n        # There are three potential modes of operation:\r\n        # 1) Standalone -- One server, handling boths streams and configuration\r\n        # 2) Master -- Central server in a master/slave setup. Does not handle any streams\r\n        #    directly, but hands out config info to slaves and gets back logging.\r\n        # 3) Slave -- Connects to a master server for stream information.  Passes back\r\n        #    logging data. Offers up stream connections to clients.\r\n        _.defaults @radio.options, @getStreamMachine().Defaults\r\n        switch @mode\r\n            when \"master\"\r\n                new (@getStreamMachine()).MasterMode @radio.options\r\n            when \"slave\"\r\n                new (@getStreamMachine()).SlaveMode @radio.options\r\n            else\r\n                new (@getStreamMachine()).StandaloneMode @radio.options\r\n\r\n    #----------\r\n\r\n    getStreamMachine: () ->\r\n        @streamMachine = @streamMachine or require \"./src/streammachine\"\r\n        @streamMachine\r\n\r\n    #----------\r\n\r\n    ping: () ->\r\n        setTimeout () =>\r\n            debug \"Ping\"\r\n            request.put @config.uri,\r\n                qs: ping: @mode, name: @radio.name\r\n            , () =>\r\n                @ping()\r\n        , @config.ping\r\n\r\n    #----------\r\n\r\n#----------\r\n\r\nnconf.env().argv()\r\nnconf.file file: nconf.get(\"config\") || nconf.get(\"CONFIG\") || \"/etc/streammachine.conf\"\r\n\r\n# -- Debugging -- #\r\n# These next two sections are for debugging and use tools that are not included\r\n# as dependencies.\r\nif nconf.get(\"enable-heapdump\")\r\n    console.log \"ENABLING HEAPDUMP (trigger via USR2)\"\r\n    require(\"heapdump\")\r\nif nconf.get(\"heapdump-interval\")\r\n    console.log \"ENABLING PERIODIC HEAP DUMPS\"\r\n    heapdump = require \"heapdump\"\r\n    setInterval =>\r\n        file = \"/tmp/streammachine-#{process.pid}-#{Date.now()}.heapsnapshot\"\r\n        heapdump.writeSnapshot file, (err) =>\r\n            if err\r\n                console.error err\r\n            else\r\n                console.error \"Wrote heap snapshot to #{file}\"\r\n    , Number(nconf.get(\"heapdump-interval\")) * 1000\r\n# -- -- #\r\n\r\nstreamer = new Streamer nconf.get()\r\nstreamer.initialize()\r\n"
  ]
}