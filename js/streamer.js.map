{
  "version": 3,
  "file": "streamer.js",
  "sourceRoot": "../",
  "sources": [
    "streamer.coffee"
  ],
  "names": [],
  "mappings": "AAIG;;;;;AAAA,IAAA,aAAA,EAAA,QAAA,EAAA,CAAA,EAAA,KAAA,EAAA,QAAA,EAAA,KAAA,EAAA,OAAA,EAAA;;AAEH,OAAO,CAAC,GAAG,CAAC,wBAAZ,GAAuC;;AAEvC,IAAG,OAAO,CAAC,GAAG,CAAC,kBAAZ,IAAkC,OAAO,CAAC,GAAG,CAAC,qBAAjD;EACI,OAAO,CAAC,GAAR,CAAY,iCAAZ;EACA,OAAA,CAAQ,UAAR,EAFJ;CAJG;;;;;AAaH,CAAA,GAAI,OAAA,CAAQ,QAAR;;AACJ,KAAA,GAAQ,OAAA,CAAQ,OAAR;;AACR,OAAA,GAAU,OAAA,CAAQ,SAAR;;AACV,KAAA,GAAQ,OAAA,CAAQ,OAAR,CAAA,CAAiB,aAAjB;;AAER,aAAA,GAAgB,OAAA,CAAQ,wBAAR;;AAEV,WAAN,MAAA,SAAA;EACI,WAAa,QAAA,CAAA;IAAC,IAAC,CAAA;EAAF,CAAjB;;;EAII,UAAY,CAAA,CAAA;WACR,IAAC,CAAA,UAAD,CAAY,CAAC,MAAD,CAAA,GAAA;MACR,IAAC,CAAA,IAAD,CAAA;aACA,IAAC,CAAA,mBAAD,CAAqB,MAArB;IAFQ,CAAZ;EADQ,CAJhB;;;EAWI,UAAY,CAAC,QAAD,CAAA;IACR,IAAG,IAAC,CAAA,MAAM,CAAC,MAAX;MACI,KAAA,CAAM,CAAA,oBAAA,CAAA,CAAuB,IAAC,CAAA,MAAM,CAAC,MAA/B,CAAA,CAAN;MACA,QAAA,CAAS,IAAC,CAAA,MAAV;AACA,aAHJ;;IAKA,IAAG,CAAC,IAAC,CAAA,MAAM,CAAC,GAAZ;MACI,MAAM,IAAI,KAAJ,CAAU,8CAAV,EADV;;IAGA,KAAA,CAAM,CAAA,yBAAA,CAAA,CAA4B,IAAC,CAAA,MAAM,CAAC,GAApC,CAAA,CAAN;WACA,OAAO,CAAC,GAAR,CAAY,IAAC,CAAA,MAAM,CAAC,GAApB,EACI;MAAA,IAAA,EAAM,IAAN;MACA,EAAA,EAAI;QAAA,IAAA,EAAM,IAAC,CAAA;MAAP;IADJ,CADJ,EAGE,CAAC,KAAD,EAAQ,QAAR,EAAkB,IAAlB,CAAA,GAAA;MACE,IAAG,KAAH;QACI,KAAA,CAAM,KAAN;QACA,KAAA,CAAM,yBAAN;AACA,eAAO,IAAC,CAAA,KAAD,CAAO,QAAP,EAHX;;MAIA,IAAG,CAAI,IAAP;QACI,KAAA,CAAM,8BAAN;AACA,eAAO,IAAC,CAAA,KAAD,CAAO,QAAP,EAFX;;MAGA,KAAA,CAAM,mCAAN;aACA,QAAA,CAAS,IAAT;IATF,CAHF;EAVQ,CAXhB;;;EAsCI,KAAO,CAAC,QAAD,CAAA;WACH,UAAA,CAAW,CAAA,CAAA,GAAA;MACP,KAAA,CAAM,OAAN;aACA,IAAC,CAAA,UAAD,CAAY,QAAZ;IAFO,CAAX,EAGE,IAAC,CAAA,MAAM,CAAC,IAAR,GAAe,CAHjB;EADG,CAtCX;;;EA8CI,mBAAqB,QAAA,CAAA;IAAC,IAAC,CAAA,iBAC3B;;;;;;;IAMQ,CAAC,CAAC,QAAF,CAAW,IAAC,CAAA,MAAM,CAAC,OAAnB,EAA4B,aAAa,CAAC,QAA1C;IACA,IAAC,CAAA,IAAD,GAAQ,KAAK,CAAC,GAAN,CAAU,MAAV,CAAA,IAAqB,IAAC,CAAA,MAAM,CAAC,OAAO,CAAC;AAE7C,YAAO,IAAC,CAAA,IAAR;AAAA,WACS,QADT;eAEQ,IAAI,aAAa,CAAC,KAAK,CAAC,UAAxB,CAAmC,IAAC,CAAA,MAAM,CAAC,OAA3C;AAFR,WAGS,OAHT;eAIQ,IAAI,aAAa,CAAC,KAAK,CAAC,SAAxB,CAAkC,IAAC,CAAA,MAAM,CAAC,OAA1C;AAJR;eAMQ,IAAI,aAAa,CAAC,KAAK,CAAC,cAAxB,CAAuC,IAAC,CAAA,MAAM,CAAC,OAA/C;AANR;EAViB,CA9CzB;;;EAkEI,IAAM,CAAA,CAAA;WACF,UAAA,CAAW,CAAA,CAAA,GAAA;MACP,CAAC,CAAC,QAAF,CAAW,CAAA,CAAA,GAAA;eAAM,KAAA,CAAM,MAAN,EAAc,KAAd;MAAN,CAAX;aACA,OAAO,CAAC,GAAR,CAAY,IAAC,CAAA,MAAM,CAAC,GAApB,EACI;QAAA,EAAA,EAAI;UAAA,IAAA,EAAM,IAAC,CAAA,IAAP;UAAa,IAAA,EAAM,IAAC,CAAA,MAAM,CAAC;QAA3B;MAAJ,CADJ,EAEE,CAAA,CAAA,GAAA;eACE,IAAC,CAAA,IAAD,CAAA;MADF,CAFF;IAFO,CAAX,EAME,IAAC,CAAA,MAAM,CAAC,IANV;EADE;;AAnEV,EApBG;;;;;AAoGH,KAAK,CAAC,GAAN,CAAA,CAAW,CAAC,IAAZ,CAAA;;AACA,KAAK,CAAC,IAAN,CAAW;EAAA,IAAA,EAAM,KAAK,CAAC,GAAN,CAAU,QAAV,CAAA,IAAuB,KAAK,CAAC,GAAN,CAAU,QAAV,CAAvB,IAA8C;AAApD,CAAX,EArGG;;;;;AA0GH,IAAG,KAAK,CAAC,GAAN,CAAU,iBAAV,CAAH;EACI,OAAO,CAAC,GAAR,CAAY,sCAAZ;EACA,OAAA,CAAQ,UAAR,EAFJ;;;AAGA,IAAG,KAAK,CAAC,GAAN,CAAU,mBAAV,CAAH;EACI,OAAO,CAAC,GAAR,CAAY,8BAAZ;EACA,QAAA,GAAW,OAAA,CAAQ,UAAR;EACX,WAAA,CAAY,CAAA,CAAA,GAAA;AAChB,QAAA;IAAQ,IAAA,GAAO,CAAA,mBAAA,CAAA,CAAsB,OAAO,CAAC,GAA9B,CAAA,CAAA,CAAA,CAAqC,IAAI,CAAC,GAAL,CAAA,CAArC,CAAA,aAAA;WACP,QAAQ,CAAC,aAAT,CAAuB,IAAvB,EAA6B,CAAC,GAAD,CAAA,GAAA;MACzB,IAAG,GAAH;eACI,OAAO,CAAC,KAAR,CAAc,GAAd,EADJ;OAAA,MAAA;eAGI,OAAO,CAAC,KAAR,CAAc,CAAA,uBAAA,CAAA,CAA0B,IAA1B,CAAA,CAAd,EAHJ;;IADyB,CAA7B;EAFQ,CAAZ,EAOE,MAAA,CAAO,KAAK,CAAC,GAAN,CAAU,mBAAV,CAAP,CAAA,GAAyC,IAP3C,EAHJ;CA7GG;;;AA0HH,QAAA,GAAW,IAAI,QAAJ,CAAa,KAAK,CAAC,GAAN,CAAA,CAAb;;AACX,QAAQ,CAAC,UAAT,CAAA",
  "sourcesContent": [
    "###\r\nrequire('@google-cloud/trace-agent').start\r\n    projectId: process.env.GCLOUD_PROJECT\r\n    keyFilename: process.env.GCLOUD_KEY_FILENAME\r\n###\r\n\r\nprocess.env.NEW_RELIC_NO_CONFIG_FILE = 'true';\r\n\r\nif process.env.NEW_RELIC_APP_NAME && process.env.NEW_RELIC_LICENSE_KEY\r\n    console.log('[integrations] loading NewRelic')\r\n    require('newrelic')\r\n\r\n\r\n#require('@google-cloud/debug-agent').start\r\n#    projectId: process.env.GCLOUD_PROJECT\r\n#    keyFilename: process.env.GCLOUD_KEY_FILENAME\r\n\r\n_ = require \"lodash\"\r\nnconf = require \"nconf\"\r\nrequest = require \"request\"\r\ndebug = require(\"debug\") \"sm:streamer\"\r\n\r\nStreamMachine = require \"./coffee/streammachine\"\r\n\r\nclass Streamer\r\n    constructor: (@config) ->\r\n\r\n    #----------\r\n\r\n    initialize: () ->\r\n        @readConfig (config) =>\r\n            @ping()\r\n            @createStreamMachine config\r\n\r\n    #----------\r\n\r\n    readConfig: (callback) ->\r\n        if @config.client\r\n            debug \"using local config: #{@config.config}\"\r\n            callback @config\r\n            return\r\n\r\n        if !@config.uri\r\n            throw new Error('No remote config URL supplied in config file')\r\n\r\n        debug \"fetch remove config from #{@config.uri}\"\r\n        request.get(@config.uri,\r\n            json: true,\r\n            qs: ping: @mode\r\n        , (error, response, body) =>\r\n            if error\r\n                debug error\r\n                debug \"Error ocurred, retrying\"\r\n                return @retry callback\r\n            if not body\r\n                debug \"No radio available, retrying\"\r\n                return @retry callback\r\n            debug \"Fetched radio config successfully\"\r\n            callback body\r\n        )\r\n\r\n    #----------\r\n\r\n    retry: (callback) ->\r\n        setTimeout () =>\r\n            debug \"Retry\"\r\n            @readConfig callback\r\n        , @config.ping / 2\r\n\r\n    #----------\r\n\r\n    createStreamMachine: (@config) ->\r\n        # There are three potential modes of operation:\r\n        # 1) Standalone -- One server, handling boths streams and configuration\r\n        # 2) Master -- Central server in a master/slave setup. Does not handle any streams\r\n        #    directly, but hands out config info to slaves and gets back logging.\r\n        # 3) Slave -- Connects to a master server for stream information.  Passes back\r\n        #    logging data. Offers up stream connections to clients.\r\n        _.defaults @config.options, StreamMachine.Defaults\r\n        @mode = nconf.get(\"mode\") or @config.options.mode\r\n\r\n        switch @mode\r\n            when \"master\"\r\n                new StreamMachine.Modes.MasterMode @config.options\r\n            when \"slave\"\r\n                new StreamMachine.Modes.SlaveMode @config.options\r\n            else\r\n                new StreamMachine.Modes.StandaloneMode @config.options\r\n\r\n    #----------\r\n\r\n    ping: () ->\r\n        setTimeout () =>\r\n            _.throttle(() => debug \"Ping\", 10000)\r\n            request.put @config.uri,\r\n                qs: ping: @mode, name: @config.name\r\n            , () =>\r\n                @ping()\r\n        , @config.ping\r\n\r\n    #----------\r\n\r\n#----------\r\n\r\nnconf.env().argv()\r\nnconf.file file: nconf.get(\"config\") || nconf.get(\"CONFIG\") || \"/etc/streammachine.conf\"\r\n\r\n# -- Debugging -- #\r\n# These next two sections are for debugging and use tools that are not included\r\n# as dependencies.\r\nif nconf.get(\"enable-heapdump\")\r\n    console.log \"ENABLING HEAPDUMP (trigger via USR2)\"\r\n    require(\"heapdump\")\r\nif nconf.get(\"heapdump-interval\")\r\n    console.log \"ENABLING PERIODIC HEAP DUMPS\"\r\n    heapdump = require \"heapdump\"\r\n    setInterval =>\r\n        file = \"/tmp/streammachine-#{process.pid}-#{Date.now()}.heapsnapshot\"\r\n        heapdump.writeSnapshot file, (err) =>\r\n            if err\r\n                console.error err\r\n            else\r\n                console.error \"Wrote heap snapshot to #{file}\"\r\n    , Number(nconf.get(\"heapdump-interval\")) * 1000\r\n# -- -- #\r\n\r\nstreamer = new Streamer nconf.get()\r\nstreamer.initialize()\r\n"
  ]
}